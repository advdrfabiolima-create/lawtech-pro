<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>LawTech Pro ‚Äî Gest√£o de Processos</title>
    <link rel="icon" type="image/png" href="favicon.png"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root {
            /* Light Theme Colors - Professional & Clean */
            --bg-primary: #f8fafc;
            --bg-secondary: #111827;
            --bg-tertiary: #1a2332;
            --bg-elevated: #ffffff;
            
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-tertiary: #64748b;
            
            --accent-blue: #2563eb;
            --accent-blue-light: #3b82f6;
            --accent-blue-glow: rgba(37, 99, 235, 0.3);
            
            --accent-green: #10b981;
            --accent-purple: #8b5cf6;
            --accent-orange: #f59e0b;
            --accent-red: #ef4444;
            --accent-gold: #fbbf24;
            
            --border-subtle: rgba(0, 0, 0, 0.08);
            --border-medium: rgba(0, 0, 0, 0.12);
            
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            
            --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Compatibility */
            --bg: var(--bg-primary);
            --sidebar: var(--bg-secondary);
            --white: var(--bg-elevated);
            --border: var(--border-medium);
            --primary: var(--accent-blue);
            --success: var(--accent-green);
            --danger: var(--accent-red);
            --warning: var(--accent-orange);
            --muted: var(--text-tertiary);
            --text-main: var(--text-primary);
            --text-menu: var(--text-tertiary);
            --sidebar-hover: var(--bg-tertiary);
            --radius: var(--radius-md);
        }

        * { box-sizing: border-box; font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--text-main); line-height: 1.5; }
        
        /* Sidebar Premium */
        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-right: 1px solid var(--border-subtle);
            padding: 32px 24px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 1000;
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .sidebar-header img {
            width: 100%;
            max-width: 180px;
            height: auto;
            filter: drop-shadow(0 0 20px var(--accent-blue-glow));
            transition: all var(--transition-base);
        }

        .sidebar-header img:hover {
            filter: drop-shadow(0 0 30px var(--accent-blue-glow));
            transform: scale(1.05);
        }

        .menu {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex-grow: 1;
        }

        .menu a {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            color: #94a3b8;
            text-decoration: none;
            border-radius: var(--radius-lg);
            font-size: 14px;
            font-weight: 600;
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .menu a::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--accent-blue);
            transform: scaleY(0);
            transition: transform var(--transition-base);
        }

        .menu a:hover::before,
        .menu a.active::before {
            transform: scaleY(1);
        }

        .menu a i {
            margin-right: 12px;
            font-size: 18px;
            transition: all var(--transition-base);
        }

        .menu a:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #e2e8f0;
            transform: translateX(4px);
        }

        .menu a.active {
            background: rgba(37, 99, 235, 0.15);
            color: #60a5fa;
            border: 1px solid rgba(37, 99, 235, 0.4);
        }

        .menu a.active i {
            color: #60a5fa;
        }

        .sidebar-footer {
            padding-top: 24px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 12px;
            margin-top: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .sidebar-footer > div {
            display: flex;
            justify-content: space-between;
        }

        .sidebar-footer span {
            color: #cbd5e1 !important;
        }

        /* √Årea Principal */
        .main { margin-left: 280px; min-height: 100vh; display: flex; flex-direction: column; position: relative; z-index: 1; }
        .header { background: var(--white); height: 72px; padding: 0 32px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 900; }
        .content { padding: 32px; }

        /* Filtros Estilizados */
        .filters-container { background: var(--white); padding: 20px; border-radius: var(--radius); border: 1px solid var(--border); margin-bottom: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .filter-label { font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-right: 15px; }
        
        .btn-filter { background: #f1f5f9; border: 1px solid transparent; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--muted); transition: 0.2s; }
        .btn-filter:hover { background: #e2e8f0; color: var(--text-main); }
        .btn-filter.active { background: var(--primary); color: #fff; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25); }

        /* Tabela de Elite */
        .card { background: var(--white); border-radius: var(--radius); padding: 0; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; color: var(--muted); padding: 16px 24px; border-bottom: 2px solid var(--border); font-size: 11px; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; }
        td { padding: 16px 24px; border-bottom: 1px solid var(--border); font-size: 14px; color: var(--text-main); }
        tr:hover td { background-color: #f8fafc; }
        
        .status-pill { color: var(--success); font-weight: 700; font-size: 11px; background: #ecfdf5; padding: 4px 10px; border-radius: 50px; border: 1px solid #d1fae5; }

        .btn-primary { background: var(--primary); color: #fff; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: 0.2s; }
        .btn-primary:hover { background: #1d4ed8; transform: translateY(-1px); }

        /* Modal */
        #modalProcesso { backdrop-filter: blur(4px); }
        .modal-content { background:#fff; width:100%; max-width:480px; padding:32px; border-radius:16px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }

        .btn-crm-gold-nav {
            background: linear-gradient(135deg, var(--accent-gold) 0%, #facc15 100%) !important;
            color: #000 !important;
            font-weight: 800 !important;
            margin-top: 16px !important;
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
            position: relative;
            overflow: hidden;
            border-radius: var(--radius-lg);
            padding: 14px 16px !important;
            display: flex !important;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            font-size: 14px;
            transition: all var(--transition-base);
        }

        .btn-crm-gold-nav i {
            margin-right: 10px;
            font-size: 18px;
        }

        .btn-crm-gold-nav:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(251, 191, 36, 0.6);
        } 
        
        .btn-crm-gold-nav i { margin-right: 10px; }

        /* Estiliza√ß√£o Premium para os Selects e Labels */
        .modal-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .field-group {
            display: flex;
            flex-direction: column;
        }
        .label-premium {
            font-size: 11px;
            font-weight: 800;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .select-premium {
            width: 100%;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            background-color: #f8fafc;
            color: #1e293b;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
        }
        .select-premium:focus {
            border-color: #2563eb;
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            background-color: #fff;
        }
        .btn-primary-premium {
    flex: 2;
    background: #2563eb;
    color: #ffffff;
    border: none;
    padding: 14px;
    border-radius: 12px;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.2s;
}
.btn-primary-premium:hover {
    background: #1d4ed8;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
}
.btn-primary-premium:disabled {
    background: #94a3b8;
    cursor: not-allowed;
}

.btn-cancel-premium {
    flex: 1;
    background: #f1f5f9;
    color: #64748b;
    border: none;
    padding: 14px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: background 0.2s;
}
.btn-cancel-premium:hover {
    background: #e2e8f0;
    color: #475569;
}
.aba-btn {
    background: #f1f5f9;
    border: none;
    padding: 12px 20px;
    border-radius: 50px;
    font-weight: 600;
    font-size: 14px;
    color: #64748b;
    cursor: pointer;
    transition: all 0.25s ease;
    display: flex;
    align-items: center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

.aba-btn:hover {
    background: #e2e8f0;
    transform: translateY(-1px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.1);
}

.aba-btn.active {
    background: var(--primary);
    color: white;
    box-shadow: 0 6px 16px rgba(37,99,235,0.25);
    transform: translateY(-1px);
}

.aba-btn i {
    opacity: 0.9;
}
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="sidebar-header"><img src="Logo LawTech Pro_transparente.png" alt="LawTech Pro"></div>
        <nav class="menu">
            <a href="/dashboard"><i class="lucide lucide-layout-dashboard"></i> Dashboard</a>
            <a href="/clientes-page"><i class="lucide lucide-users"></i> Clientes</a>
            <a href="/prazos-page"><i class="lucide lucide-clock"></i> Prazos</a>
            <a href="/processos-page" class="active"><i class="lucide lucide-folder"></i> Processos</a>
            <a href="/audiencias-page"><i class="lucide lucide-calendar-days"></i> Audi√™ncias</a>
            <a href="/calculos-page"><i class="lucide lucide-calculator"></i> C√°lculos Jur√≠dicos</a>
            <a href="/financeiro-page"><i class="lucide lucide-credit-card"></i> Financeiro</a>
            <a href="/publicacoes-page"><i class="lucide lucide-clock"></i> Publica√ß√µes DJEN</a>
            <a href="/ia-page" style="display: flex; align-items: center; gap: 10px;">
                <i class="lucide lucide-sparkles" style="color: #fbbf24;"></i> IA Jur√≠dica 
                <span style="font-size: 9px; background: #fbbf24; color: #000; padding: 2px 5px; border-radius: 4px; font-weight: bold; margin-left: auto;">PREMIUM</span>
            </a>
            <a href="/planos-page"><i class="lucide lucide-award"></i> Gest√£o de Planos</a>
            <a href="/config-page"><i class="lucide lucide-settings"></i> Configura√ß√µes</a>
            <a href="/crm-page" class="btn-crm-gold-nav">
                <i class="lucide lucide-trending-up"></i> CRM PROSPEC√á√ÉO
            </a>
        </nav>
        <div class="sidebar-footer">
            <div>
                <span>Usu√°rio:</span>
                <span id="footerEmail">...</span>
            </div>
            <div>
                <span>Plano:</span>
                <span id="footerPlano">...</span>
            </div>
        </div>
    </aside>

    <div class="main">
        <header class="header">
            <div style="display: flex; align-items: center; gap: 15px;">
                <h2 style="font-size: 18px; font-weight: 700;">üìÇ Gest√£o de Processos</h2>
            </div>
            
            <div style="display:flex; gap:20px; align-items:center;">
                <button class="btn-primary" onclick="abrirModalProcesso()">+ Novo Processo</button>
                
                <div style="position: relative; display: flex; align-items: center; gap: 12px;">
                    <span id="userNameHeader" style="font-size: 13px; font-weight: 600; color: var(--muted);">Advogado</span>
                    <div onclick="toggleUserMenu()" id="userCircle" style="width: 38px; height: 38px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: 700; border: 2px solid #e2e8f0; font-size: 13px; text-transform: uppercase;">
                        --
                    </div>
                    <div id="userDropdown" style="display: none; position: absolute; top: 50px; right: 0; background: white; border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); width: 180px; z-index: 1001;">
                        <a href="/config-page" style="display: block; padding: 10px 16px; color: var(--text-main); text-decoration: none; font-size: 13px; border-bottom: 1px solid var(--border);">üë§ Meus Dados</a>
                        <a href="#" onclick="logout()" style="display: block; padding: 10px 16px; color: var(--danger); text-decoration: none; font-size: 13px; font-weight: 600;">üö™ Sair</a>
                    </div>
                </div>
            </div>
        </header>

        <main class="content">
            <div class="filters-container">
                <div id="region-filter" style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                    <span class="filter-label">Filtrar por Regi√£o:</span>
                    <button class="btn-filter active" onclick="filtrarRegiao('TODOS', this)">Todos</button>
                    <button class="btn-filter" onclick="filtrarRegiao('SUL', this)">Sul</button>
                    <button class="btn-filter" onclick="filtrarRegiao('SUDESTE', this)">Sudeste</button>
                    <button class="btn-filter" onclick="filtrarRegiao('CENTRO', this)">Centro-Oeste</button>
                    <button class="btn-filter" onclick="filtrarRegiao('NORDESTE', this)">Nordeste</button>
                    <button class="btn-filter" onclick="filtrarRegiao('NORTE', this)">Norte</button>
                </div>
                <div id="state-filter" style="display: none; gap: 10px; align-items: center; padding-top: 15px; margin-top: 15px; border-top: 1px solid var(--border);">
                    <span class="filter-label">Estados:</span>
                    <div id="state-buttons" style="display: flex; gap: 8px; flex-wrap: wrap;"></div>
                </div>
            </div>

            <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
    <button id="btnTabAtivo" 
            class="aba-btn ${abaAtual === 'ativo' ? 'active' : ''}" 
            onclick="mudarAba('ativo')">
        <i class="lucide lucide-folder-open" style="width:18px; height:18px; margin-right:6px;"></i>
        Processos Ativos
    </button>
    
    <button id="btnTabArquivado" 
            class="aba-btn ${abaAtual === 'arquivado' ? 'active' : ''}" 
            onclick="mudarAba('arquivado')">
        <i class="lucide lucide-archive" style="width:18px; height:18px; margin-right:6px;"></i>
        Arquivados
    </button>
    
    <button id="btnTabExcluido" 
            class="aba-btn ${abaAtual === 'excluido' ? 'active' : ''}" 
            onclick="mudarAba('excluido')"
            style="color: var(--danger);">
        <i class="lucide lucide-trash-2" style="width:18px; height:18px; margin-right:6px;"></i>
        Lixeira (Auditoria)
    </button>
</div>

            <div class="card" style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; table-layout: fixed; min-width: 1200px;">
                    <thead>
                        <tr style="background: #f1f5f9; color: #64748b; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700;">
                            <th style="width: 22%; padding: 16px 12px; text-align: left;">N¬∫ Processo (CNJ)</th>
                            <th style="width: 18%; padding: 16px 12px; text-align: left;">Cliente</th>
                            <th style="width: 14%; padding: 16px 12px; text-align: left;">Parte Contr√°ria</th>
                            <th style="width: 12%; padding: 16px 12px; text-align: left;">Esfera</th>
                            <th style="width: 12%; padding: 16px 12px; text-align: left;">Tribunal</th>
                            <th style="width: 10%; padding: 16px 12px; text-align: center;">Inst√¢ncia / Grau</th>
                            <th style="width: 8%; padding: 16px 12px; text-align: center;">UF</th>
                            <th style="width: 10%; padding: 16px 12px; text-align: center;">Status</th>
                            <th style="width: 10%; padding: 16px 12px; text-align: right;">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="listaProcessos">
                        <tr><td colspan="9" style="text-align:center; padding:50px; color:var(--muted);">Carregando sua base de processos...</td></tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <div id="modalProcesso" style="display:none; position:fixed; inset:0; background:rgba(15, 23, 42, 0.7); z-index:10000; align-items:center; justify-content:center;">
        <div class="modal-content">
            <h3 style="margin-bottom: 24px; font-size: 20px; font-weight: 700; color: var(--sidebar);">üìÇ Novo Processo</h3>
            <form id="formProcesso">
                <div style="margin-bottom:16px;">
                    <label style="display:block; font-size:11px; font-weight:700; color: var(--muted); margin-bottom:6px; text-transform:uppercase;">N¬∫ do Processo (CNJ)</label>
                    <input type="text" id="procNumero" placeholder="0000000-00.0000.0.00.0000" maxlength="25" oninput="mascaraCNJ(this)" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px;" required>
                </div>
                <div style="margin-bottom:16px;">
                    <label style="display:block; font-size:11px; font-weight:700; color: var(--muted); margin-bottom:6px; text-transform:uppercase;">Parte Contr√°ria (Ex: Empresa X / R√©u)</label>
                    <input type="text" id="procParteContraria" placeholder="Nome da parte adversa" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px;">
                </div>
                <div style="margin-bottom:16px;">
                    <label style="display:block; font-size:11px; font-weight:700; color: var(--muted); margin-bottom:6px; text-transform:uppercase;">Vincular Cliente</label>
                    <select id="procClienteId" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px;" required>
                        <option value="">Carregando clientes...</option>
                    </select>
                </div>

                <!-- Grid corrigido: um field-group por select, para alinhar corretamente -->
                <div class="modal-grid">
                    <div class="field-group">
                        <label class="label-premium">Esfera</label>
                        <select id="procEsfera" class="select-premium" onchange="organizarTribunaisPorEsfera()" required>
                            <option value="">Selecione...</option>
                            <option value="estadual">Justi√ßa Estadual</option>
                            <option value="federal">Justi√ßa Federal</option>
                            <option value="trabalho">Justi√ßa do Trabalho</option>
                            <option value="eleitoral">Justi√ßa Eleitoral</option>
                            <option value="superior">Tribunais Superiores / Conselhos</option>
                        </select>
                    </div>

                    <div class="field-group">
                        <label class="label-premium">Tribunal</label>
                        <select id="procTribunal" class="select-premium" required>
                            <option value="">Aguardando Esfera...</option>
                        </select>
                    </div>
                </div>

                <div class="modal-grid">
                    <div class="field-group">
                        <label class="label-premium">Inst√¢ncia / Grau</label>
                        <select id="procInstancia" class="select-premium">
                            <option value="1">1¬∫ Grau</option>
                            <option value="2">2¬∫ Grau</option>            
                            <option value="STJ">STJ</option>
                            <option value="STF">STF</option>
                        </select>
                    </div>

                    <div class="field-group">
                        <label class="label-premium">Estado (UF)</label>
                        <select id="procEstado" class="select-premium">
                            <option value="">Selecione...</option>
                            <option value="AC">Acre</option>
                            <option value="AL">Alagoas</option>
                            <option value="AP">Amap√°</option>
                            <option value="AM">Amazonas</option>
                            <option value="BA">Bahia</option>
                            <option value="CE">Cear√°</option>
                            <option value="DF">Distrito Federal</option>
                            <option value="ES">Esp√≠rito Santo</option>
                            <option value="GO">Goi√°s</option>
                            <option value="MA">Maranh√£o</option>
                            <option value="MT">Mato Grosso</option>
                            <option value="MS">Mato Grosso do Sul</option>
                            <option value="MG">Minas Gerais</option>
                            <option value="PA">Par√°</option>
                            <option value="PB">Para√≠ba</option>
                            <option value="PR">Paran√°</option>
                            <option value="PE">Pernambuco</option>
                            <option value="PI">Piau√≠</option>
                            <option value="RJ">Rio de Janeiro</option>
                            <option value="RN">Rio Grande do Norte</option>
                            <option value="RS">Rio Grande do Sul</option>
                            <option value="RO">Rond√¥nia</option>
                            <option value="RR">Roraima</option>
                            <option value="SC">Santa Catarina</option>
                            <option value="SP">S√£o Paulo</option>
                            <option value="SE">Sergipe</option>
                            <option value="TO">Tocantins</option>
                        </select>
                    </div>
                </div>

                <div style="margin-top: 30px; display: flex; gap: 12px;">
                    <button type="submit" class="btn-primary-premium">
                        <i class="lucide lucide-save"></i> Salvar Processo
                    </button>
                    <button type="button" onclick="fecharModalProcesso()" class="btn-cancel-premium">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

  <script>
    const token = localStorage.getItem('token');
    if (!token) window.location.href = '/login.html';
    
    let todosProcessos = []; // üìÇ Guardar√° a lista global para os filtros funcionar
    let abaAtual = 'ativo';

    const regioesMap = {
        'SUL': ['PR', 'RS', 'SC'],
        'SUDESTE': ['ES', 'MG', 'RJ', 'SP'],
        'CENTRO': ['DF', 'GO', 'MT', 'MS'],
        'NORDESTE': ['AL', 'BA', 'CE', 'MA', 'PB', 'PE', 'PI', 'RN', 'SE'],
        'NORTE': ['AC', 'AM', 'AP', 'PA', 'RO', 'RR', 'TO']
    };

    async function inicializar() {
        try {
            console.log('üîÑ Inicializando p√°gina de processos...');
            
            // 1. Busca dados do usu√°rio
            const resUser = await fetch('/api/auth/me', { headers: { 'Authorization': `Bearer ${token}` } });
            const dataUser = await resUser.json();

            if (dataUser.ok) {
                const emailElement = document.getElementById('footerEmail');
                if (emailElement) {
                    emailElement.innerText = dataUser.usuario.email || 'N√£o dispon√≠vel';
                    console.log('‚úÖ Email atualizado:', dataUser.usuario.email);
                }

                const nomeCompleto = dataUser.usuario.nome || 'Advogado';
                const primeiroNome = nomeCompleto.split(' ')[0];
                
                const nameHeader = document.getElementById('userNameHeader');
                if (nameHeader) nameHeader.innerText = primeiroNome;

                const partes = nomeCompleto.trim().split(' ').filter(n => n);
                let iniciais = partes[0][0];
                if (partes.length > 1) {
                    iniciais += partes[partes.length - 1][0];
                }
                
                const circulo = document.getElementById('userCircle');
                if (circulo) circulo.innerText = iniciais.toUpperCase();
            }

            // 2. Busca plano
            const resPlan = await fetch('/api/plano-consumo', { headers: { Authorization: `Bearer ${token}` } });
            const dataPlan = await resPlan.json();
            
            const planoElement = document.getElementById('footerPlano');
            if (planoElement) {
                planoElement.innerText = dataPlan.plano || 'Free';
                console.log('‚úÖ Plano atualizado:', dataPlan.plano);
            }

            // 3. Carrega processos
            await carregarProcessos();
        } catch (err) {
            console.error("‚ùå Erro na inicializa√ß√£o:", err);
        }
    }

    async function carregarProcessos() {
        try {
            const response = await fetch('/api/processos', {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }
            });

            if (response.ok) {
                todosProcessos = await response.json();
                console.log('JSON RAW recebido:', JSON.stringify(todosProcessos[0], null, 2));
                console.log("Esfera e tribunal do primeiro:", {
                    esfera: todosProcessos[0]?.esfera,
                    tribunal: todosProcessos[0]?.tribunal
                });
                renderizarTabela(todosProcessos);
            } else {
                console.error('Erro na resposta:', response.status);
            }
        } catch (err) {
            console.error("Erro ao carregar lista:", err);
        }
    }

    function renderizarTabela(lista) {
        const tabela = document.getElementById('listaProcessos');
        const listaFiltrada = lista.filter(p => (p.status || 'ativo').toLowerCase() === abaAtual);

        if (listaFiltrada.length === 0) {
            tabela.innerHTML = `<tr><td colspan="9" style="text-align:center; padding:50px; color:var(--muted);">Nenhum processo encontrado.</td></tr>`;
            return;
        }
console.log('Data crua do banco (primeiro processo exclu√≠do):', todosProcessos.find(p => p.status?.toLowerCase() === 'excluido')?.data_exclusao);
console.log('Data convertida no front:', new Date(todosProcessos.find(p => p.status?.toLowerCase() === 'excluido')?.data_exclusao).toLocaleString('pt-BR'));
        tabela.innerHTML = listaFiltrada.map(p => `
            <tr style="border-bottom: 1px solid #e2e8f0;">
                <td style="padding: 16px 12px;">
                    <div style="font-weight: 700; color: #2563eb; font-size: 14px;">${p.numero || 'N/A'}</div>
                    <div style="font-size: 12px; color: #64748b;">vs. ${p.parte_contraria || 'N√£o informada'}</div>
                </td>
                <td style="padding: 16px 12px; font-weight: 600;">${p.cliente || '---'}</td>
                <td style="padding: 16px 12px;">${p.parte_contraria || '---'}</td>
                <td style="padding: 16px 12px;">
                    <span style="background: #e0f2fe; color: #0369a1; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; text-transform: uppercase;">
                        ${formatarEsfera(p.esfera) || 'N/A'}
                    </span>
                </td>
                <td style="padding: 16px 12px; font-weight: 500;">${formatarTribunal(p.tribunal) || '‚Äî'}</td>
                <td style="padding: 16px 12px; text-align: center; font-weight: 600;">${p.instancia || '1'}¬∫ Grau</td>
                <td style="padding: 16px 12px; text-align: center; font-weight: 700; color: #2563eb;">${p.uf || '--'}</td>
                <td style="padding: 16px 12px; text-align: center;">
                    <span style="background: ${abaAtual === 'excluido' ? '#fee2e2' : '#ecfdf5'}; color: ${abaAtual === 'excluido' ? '#ef4444' : '#10b981'}; padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 700;">
                        ${(p.status || 'ATIVO').toUpperCase()}
                    </span>
                </td>
                <td style="padding: 16px 12px; text-align: right;">
    <div style="display: flex; gap: 12px; justify-content: flex-end; align-items: center;">
        ${abaAtual === 'ativo' ? `
            <button onclick="arquivarProcesso(${p.id})" title="Arquivar" style="background:none;border:none;cursor:pointer;color:#f59e0b;"><i data-lucide="archive" style="width:18px;"></i></button>
            <button onclick="excluirProcesso(${p.id})" title="Excluir" style="background:none;border:none;cursor:pointer;color:#ef4444;"><i data-lucide="trash-2" style="width:18px;"></i></button>
        ` : abaAtual === 'arquivado' ? `
            <button onclick="desarquivarProcesso(${p.id})" title="Desarquivar" style="background:none;border:none;cursor:pointer;color:#10b981;"><i data-lucide="refresh-cw" style="width:18px;"></i></button>
            <button onclick="excluirProcesso(${p.id})" title="Excluir" style="background:none;border:none;cursor:pointer;color:#ef4444;"><i data-lucide="trash-2" style="width:18px;"></i></button>
        ` : `
            <div style="text-align: right; line-height: 1.3; min-width: 160px;">
                <div style="font-size: 9px; color: #94a3b8; text-transform: uppercase; font-weight: 700; margin-bottom: 2px;">Auditado</div>
                
                <!-- Quem excluiu -->
                <div style="font-size: 11px; color: #ef4444; font-weight: 600; margin-bottom: 2px;">
                    ${p.excluido_por 
                        ? (p.excluido_por.includes('@') ? p.excluido_por.split('@')[0] : p.excluido_por) 
                        : 'Sistema'}
                </div>
                                
            <!-- Data + hora corrigida 100% para -03:00 Bahia -->
<div style="font-size: 10px; color: #64748b; font-weight: 500;">
    ${p.data_exclusao 
        ? (() => {
            let data = new Date(p.data_exclusao);
            // Se tiver 'Z' ou for UTC, ajusta manualmente para -03:00
            if (p.data_exclusao.includes('Z') || data.getTimezoneOffset() === 0) {
                data.setHours(data.getHours() - 3);  // Desloca -3h do UTC
            }
            return data.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        })()
        : 'Data n√£o registrada'}
</div>
            </div>
        `}
    </div>
</td>
            </tr>
        `).join('');
        lucide.createIcons();
    }

    function mudarAba(aba) {
    abaAtual = aba;
    ['btnTabAtivo', 'btnTabArquivado', 'btnTabExcluido'].forEach(id => {
        const btn = document.getElementById(id);
        if (btn) btn.classList.toggle('active', id === `btnTab${aba.charAt(0).toUpperCase() + aba.slice(1)}`);
    });
    renderizarTabela(todosProcessos);
    
    // For√ßa recria√ß√£o dos √≠cones Lucide ap√≥s mudar aba
    if (typeof lucide !== 'undefined') lucide.createIcons();
}

    // SALVAMENTO DO PROCESSO COM LOGS PARA DEBUG
document.getElementById('formProcesso').onsubmit = async (e) => {
    e.preventDefault();

    const btnSalvar = e.target.querySelector('button[type="submit"]');
    const textoOriginal = btnSalvar.innerHTML;
    btnSalvar.disabled = true;
    btnSalvar.innerHTML = "Verificando...";

    const esferaValue = document.getElementById('procEsfera').value.trim();
    const tribunalValue = document.getElementById('procTribunal').value.trim();

    console.log('Valor atual de esfera antes de enviar:', esferaValue);
    console.log('Valor atual de tribunal antes de enviar:', tribunalValue);

    const selectCliente = document.getElementById('procClienteId');
    const numeroProcesso = document.getElementById('procNumero').value.trim();

    const dados = {
        numero: numeroProcesso,
        cliente_id: selectCliente.value,
        cliente: selectCliente.options[selectCliente.selectedIndex].text.trim(),
        uf: document.getElementById('procEstado').value.trim(),
        instancia: document.getElementById('procInstancia').value.trim(),
        parte_contraria: document.getElementById('procParteContraria').value.trim(),
        esfera: esferaValue,
        tribunal: tribunalValue
    };

    console.log("Enviando para o backend:", dados);

    // Valida√ß√£o b√°sica
    if (!dados.numero) {
        alert("O n√∫mero do processo √© obrigat√≥rio!");
        btnSalvar.disabled = false;
        btnSalvar.innerHTML = textoOriginal;
        return;
    }
    if (!dados.esfera) {
        alert("Selecione a Esfera antes de salvar!");
        btnSalvar.disabled = false;
        btnSalvar.innerHTML = textoOriginal;
        return;
    }
    if (!dados.tribunal) {
        alert("Selecione o Tribunal antes de salvar!");
        btnSalvar.disabled = false;
        btnSalvar.innerHTML = textoOriginal;
        return;
    }

    try {
        // Passo 1: Verifica se j√° existe processo com esse n√∫mero
        btnSalvar.innerHTML = "Verificando duplicidade...";
        const checkRes = await fetch(`/api/processos/existe/${encodeURIComponent(numeroProcesso)}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!checkRes.ok) {
            throw new Error('Erro ao verificar duplicidade');
        }

        const checkData = await checkRes.json();

        // Passo 2: Se existir, pergunta ao usu√°rio
        if (checkData.existe) {
            const confirmar = confirm(
                `Esse processo (${numeroProcesso}) j√° est√° cadastrado no sistema.\n\n` +
                `Deseja cadastrar novamente (duplicado)?\n` +
                `(Isso criar√° uma nova entrada com o mesmo n√∫mero)`
            );

            if (!confirmar) {
                btnSalvar.disabled = false;
                btnSalvar.innerHTML = textoOriginal;
                return; // Cancela o cadastro
            }
        }

        // Passo 3: Prossegue com o salvamento
        btnSalvar.innerHTML = "Salvando...";

        const response = await fetch('/api/processos', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json', 
                'Authorization': `Bearer ${token}` 
            },
            body: JSON.stringify(dados)
        });

        if (response.ok) {
            alert("‚úÖ Processo cadastrado com sucesso!");
            fecharModalProcesso();
            e.target.reset();
            await carregarProcessos();
        } else {
            const erroData = await response.json();
            alert("‚ùå Erro ao salvar: " + (erroData.erro || "Falha desconhecida"));
        }
    } catch (err) {
        console.error("Erro completo:", err);
        alert("‚ùå Erro de conex√£o ou servidor.");
    } finally {
        btnSalvar.disabled = false;
        btnSalvar.innerHTML = textoOriginal;
    }
};

    function organizarTribunaisPorEsfera() {
    const esfera = document.getElementById('procEsfera').value;
    console.log('Esfera selecionada:', esfera);

    const tribunalSelect = document.getElementById('procTribunal');
    let html = '<option value="">Selecione o Tribunal...</option>';

    if (esfera === 'estadual') {
        ['TJAC','TJAL','TJAP','TJAM','TJBA','TJCE','TJDFT','TJES','TJGO','TJMA','TJMT','TJMS','TJMG','TJPA','TJPB','TJPR','TJPE','TJPI','TJRJ','TJRN','TJRS','TJRO','TJRR','TJSC','TJSP','TJSE','TJTO'].forEach(tj => html += `<option value="${tj}">${tj}</option>`);
    } 
    else if (esfera === 'federal') {
        ['TRF1','TRF2','TRF3','TRF4','TRF5','TRF6'].forEach(trf => html += `<option value="${trf}">${trf}</option>`);
    } 
    else if (esfera === 'trabalho') {
        for(let i=1; i<=24; i++) html += `<option value="TRT${i}">TRT${i}</option>`;
    } 
    else if (esfera === 'eleitoral') {
        // Aqui adicionamos o TRE como op√ß√£o principal
        html += `<option value="TRE">TRE (Tribunal Regional Eleitoral)</option>`;
        // Se quiser deixar mais op√ß√µes no futuro, pode adicionar TREs espec√≠ficos por estado
        // Exemplo: html += `<option value="TRE-BA">TRE-BA</option>`;
    } 
    else if (esfera === 'superior') {
        ['STJ','STF','TST','TSE','STM','CNJ'].forEach(sup => html += `<option value="${sup}">${sup}</option>`);
    }

    tribunalSelect.innerHTML = html;
    console.log('Tribunal select atualizado com', tribunalSelect.options.length, 'op√ß√µes');
}

    async function carregarClientesNoSelect() {
        try {
            const res = await fetch('/api/clientes', { headers: { 'Authorization': `Bearer ${token}` } });
            const clientes = await res.json();
            const select = document.getElementById('procClienteId');
            select.innerHTML = '<option value="">Selecione o Cliente...</option>' + 
                clientes.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
        } catch (err) { console.error("Erro ao carregar clientes"); }
    }

    function abrirModalProcesso() { 
        document.getElementById('modalProcesso').style.display = 'flex'; 
        carregarClientesNoSelect(); 
        // Resetar selects
        document.getElementById('procEsfera').value = '';
        document.getElementById('procTribunal').innerHTML = '<option value="">Aguardando Esfera...</option>';
    }

    function fecharModalProcesso() { 
        document.getElementById('modalProcesso').style.display = 'none'; 
        document.getElementById('formProcesso').reset(); 
    }
    
    function logout() { localStorage.removeItem('token'); window.location.href = '/login.html'; }
    // üöÄ INICIALIZA√á√ÉO COM GARANTIA DUPLA
    document.addEventListener('DOMContentLoaded', () => {
        console.log('üìÑ DOM carregado');
        setTimeout(() => {
            inicializar();
        }, 100);
    });

    window.onload = () => {
        console.log('üåê Window carregado');
        inicializar();
    };

    // Filtros de Regi√£o
    function filtrarRegiao(regiao, elemento) {
        document.querySelectorAll('#region-filter .btn-filter').forEach(btn => btn.classList.remove('active'));
        elemento.classList.add('active');
        const stateFilterDiv = document.getElementById('state-filter');
        const stateButtonsDiv = document.getElementById('state-buttons');

        if (regiao === 'TODOS') {
            stateFilterDiv.style.display = 'none';
            renderizarTabela(todosProcessos);
            return;
        }

        stateFilterDiv.style.display = 'flex';
        stateButtonsDiv.innerHTML = '';
        regioesMap[regiao].forEach(uf => {
            const btn = document.createElement('button');
            btn.className = 'btn-filter';
            btn.innerText = uf;
            btn.onclick = () => filtrarPorEstado(uf, btn);
            stateButtonsDiv.appendChild(btn);
        });
        renderizarTabela(todosProcessos.filter(p => regioesMap[regiao].includes(p.uf)));
    }

    function filtrarPorEstado(uf, elemento) {
        document.querySelectorAll('#state-buttons .btn-filter').forEach(btn => btn.classList.remove('active'));
        elemento.classList.add('active');
        renderizarTabela(todosProcessos.filter(p => p.uf === uf));
    }

    // M√°scara CNJ
    function mascaraCNJ(i) {
        let v = i.value.replace(/\D/g, "");
        if (v.length > 7) v = v.replace(/^(\d{7})(\d)/, "$1-$2");
        if (v.length > 9) v = v.replace(/^(\d{7})-(\d{2})(\d)/, "$1-$2.$3");
        if (v.length > 13) v = v.replace(/^(\d{7})-(\d{2})\.(\d{4})(\d)/, "$1-$2.$3.$4");
        if (v.length > 14) v = v.replace(/^(\d{7})-(\d{2})\.(\d{4})\.(\d{1})(\d)/, "$1-$2.$3.$4.$5");
        if (v.length > 16) v = v.replace(/^(\d{7})-(\d{2})\.(\d{4})\.(\d{1})\.(\d{2})(\d)/, "$1-$2.$3.$4.$5.$6");
        i.value = v;
    }

    // Arquivar
    async function arquivarProcesso(id) {
        if (!confirm("Deseja mover este processo para os Arquivados?")) return;
        try {
            const res = await fetch(`/api/processos/${id}/arquivar`, { 
                method: 'PATCH', 
                headers: { 'Authorization': `Bearer ${token}` } 
            });
            if (res.ok) {
                alert("Processo arquivado!");
                await carregarProcessos(); 
            } else {
                alert("Erro ao arquivar.");
            }
        } catch (err) { alert("Erro ao arquivar."); }
    }

    async function desarquivarProcesso(id) {
        if (!confirm("Deseja retornar este processo para a lista de Ativos?")) return;
        try {
            const res = await fetch(`/api/processos/${id}/desarquivar`, { 
                method: 'PATCH', 
                headers: { 'Authorization': `Bearer ${token}` } 
            });
            if (res.ok) {
                alert("‚úÖ Processo reativado com sucesso!");
                await carregarProcessos(); 
            } else {
                alert("Erro ao reativar processo.");
            }
        } catch (err) {
            console.error(err);
            alert("Erro na comunica√ß√£o com o servidor.");
        }
    }

    async function excluirProcesso(id) {
        if (!confirm("Deseja enviar para a Lixeira de Auditoria?")) return;
        try {
            const res = await fetch(`/api/processos/${id}/excluir`, { 
                method: 'PATCH', 
                headers: { 'Authorization': `Bearer ${token}` } 
            });
            if (res.ok) {
                alert("Processo exclu√≠do!");
                await carregarProcessos();
            }
        } catch (err) { alert("Erro ao excluir."); }
    }

    function toggleUserMenu() {
        const m = document.getElementById('userDropdown');
        m.style.display = m.style.display === 'none' ? 'block' : 'none';
    }

    window.onclick = (e) => {
        if (!e.target.closest('#userCircle') && !e.target.closest('#userDropdown')) {
            const m = document.getElementById('userDropdown');
            if(m) m.style.display = 'none';
        }
    };

    function formatarEsfera(valor) {
        if (!valor || valor === 'null' || valor === 'desconhecida') return 'Desconhecida';
        const mapa = {
            estadual: 'Justi√ßa Estadual',
            federal: 'Justi√ßa Federal',
            trabalho: 'Justi√ßa do Trabalho',
            eleitoral: 'Justi√ßa Eleitoral',
            superior: 'Tribunais Superiores'
        };
        return mapa[valor.toLowerCase()] || valor.charAt(0).toUpperCase() + valor.slice(1);
    }

    function formatarTribunal(valor) {
        if (!valor || valor === 'null' || valor === 'desconhecido') return 'Desconhecido';
        if (valor.startsWith('TRF')) return `TRF-${valor.slice(3)}`;
        if (valor.startsWith('TJ')) return `TJ-${valor.slice(2)}`;
        return valor;
    }
    // Inicializa √≠cones Lucide na carga inicial
if (typeof lucide !== 'undefined') {
    lucide.createIcons();
}

// E chama toda vez que mudar aba (para √≠cones din√¢micos)
function mudarAba(aba) {
    abaAtual = aba;
    ['btnTabAtivo', 'btnTabArquivado', 'btnTabExcluido'].forEach(id => {
        const btn = document.getElementById(id);
        if (btn) {
            btn.classList.toggle('active', id === `btnTab${aba.charAt(0).toUpperCase() + aba.slice(1)}`);
        }
    });
    renderizarTabela(todosProcessos);
    
    // For√ßa √≠cones em todas as abas e na carga
setTimeout(() => {
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
}, 500);  // Delay para garantir que DOM carregou
}
</script>
</body>
</html>