<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Jur√≠dico</title>

  <!-- Bootstrap -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <style>
    body {
      background-color: #f5f6fa;
    }
    .card {
      margin-bottom: 20px;
    }
    .vencido {
      border-left: 6px solid #dc3545;
    }
    .semana {
      border-left: 6px solid #ffc107;
    }
    .futuro {
      border-left: 6px solid #198754;
    }
  </style>
</head>

<body class="container py-4">

<h1 class="mb-4">üìä Dashboard de Prazos</h1>

<!-- INFO DO USU√ÅRIO -->
<div class="mb-3">
  <strong>Usu√°rio logado:</strong>
  <span id="usuario-email"></span><br>
  <strong>Perfil:</strong>
  <span id="usuario-role"></span>
</div>

<button class="btn btn-outline-danger mb-4" onclick="logout()">üö™ Sair</button>

<!-- BOT√ÉO CRIAR PRAZO -->
<button
  id="btn-criar-prazo"
  class="btn btn-primary mb-4"
  onclick="toggleFormularioPrazo()"
>
  ‚ûï Criar Prazo
</button>

<!-- FORMUL√ÅRIO -->
<div id="form-criar-prazo" class="card mt-3" style="display:none;">
  <div class="card-body">

    <h5 class="mb-3">‚ûï Novo Prazo</h5>

    <div class="mb-2">
      <label class="form-label">Processo</label>
      <select id="processoId" class="form-select">
        <option value="">Selecione um processo</option>
      </select>
    </div>

    <div class="mb-2">
      <label class="form-label">Tipo</label>
      <input id="tipo" class="form-control" placeholder="Ex: Contesta√ß√£o">
    </div>

    <div class="mb-2">
      <label class="form-label">Descri√ß√£o</label>
      <input id="descricao" class="form-control" placeholder="Descri√ß√£o do prazo">
    </div>

    <div class="mb-3">
      <label class="form-label">Data Limite</label>
      <input id="dataLimite" type="date" class="form-control">
    </div>

    <button class="btn btn-success" onclick="salvarPrazo()">Salvar Prazo</button>
    <button class="btn btn-secondary ms-2" onclick="toggleFormularioPrazo()">Cancelar</button>

  </div>
</div>

<!-- LISTAS -->
<div class="card vencido">
  <div class="card-body">
    <h4>üî¥ Prazos Vencidos</h4>
    <ul id="vencidos" class="list-group list-group-flush"></ul>
  </div>
</div>

<div class="card semana">
  <div class="card-body">
    <h4>üü° Prazos da Semana</h4>
    <ul id="semana" class="list-group list-group-flush"></ul>
  </div>
</div>

<div class="card futuro">
  <div class="card-body">
    <h4>üü¢ Prazos Futuros</h4>
    <ul id="futuros" class="list-group list-group-flush"></ul>
  </div>
</div>

<!-- CONCLU√çDOS -->
<div class="card mt-4">
  <div class="card-body">
    <h4>‚úÖ Prazos Conclu√≠dos</h4>
    <ul id="concluidos" class="list-group list-group-flush"></ul>
  </div>
</div>

<!-- PLANO & CONSUMO -->
<div class="card mb-4">
  <div class="card-body">
    <h4>üì¶ Plano & Consumo</h4>

    <p><strong>Plano atual:</strong> <span id="plano-nome">---</span></p>
    <p><strong>Prazos usados:</strong> <span id="prazos-usados">0</span></p>
    <p><strong>Limite do plano:</strong> <span id="prazos-limite">‚àû</span></p>

    <div class="progress mb-2">
      <div
        id="barra-consumo"
        class="progress-bar"
        role="progressbar"
        style="width: 0%"
      ></div>
    </div>

    <button
  class="btn btn-outline-primary btn-sm"
  onclick="abrirModalUpgrade()"
  id="btn-upgrade"
>
  üöÄ Fazer upgrade
</button>
  </div>
</div>

<!-- MODAL UPGRADE DE PLANO -->
<div class="modal fade" id="modalUpgrade" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">üöÄ Fazer upgrade de plano</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <p>Escolha o plano desejado:</p>

        <select id="planoSelecionado" class="form-select">
            <option value="">Carregando planos...</option>
        </select>

      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">
          Cancelar
        </button>
        <button class="btn btn-success" onclick="confirmarUpgrade()">
          Confirmar upgrade
        </button>
      </div>

    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const MODO_TESTE_UPGRADE = true; // Mudar para false em produ√ß√£o
const token = localStorage.getItem('token');

if (!token) {
  window.location.href = '/login.html';
}

function logout() {
  localStorage.clear();
  window.location.href = '/login.html';
}

/* =====================
   USU√ÅRIO LOGADO
===================== */
async function carregarUsuario() {
  const res = await fetch('/auth/me', {
    headers: { Authorization: `Bearer ${token}` }
  });
  const data = await res.json();

  document.getElementById('usuario-email').innerText = data.usuario.email;
  document.getElementById('usuario-role').innerText = data.usuario.role;
}

carregarUsuario();

/* =====================
   FORMUL√ÅRIO
===================== */
function toggleFormularioPrazo() {
  const form = document.getElementById('form-criar-prazo');
  const btn = document.getElementById('btn-criar-prazo');

  const abrindo = form.style.display === 'none' || form.style.display === '';

  if (abrindo) {
    form.style.display = 'block';
    btn.innerText = '‚ûñ Fechar Prazo';
    btn.classList.replace('btn-primary', 'btn-secondary');
    carregarProcessos();
  } else {
    form.style.display = 'none';
    btn.innerText = '‚ûï Criar Prazo';
    btn.classList.replace('btn-secondary', 'btn-primary');
  }
}

/* =====================
   PROCESSOS
===================== */
async function carregarProcessos() {
  const select = document.getElementById('processoId');
  select.innerHTML = '<option value="">Selecione um processo</option>';

  const res = await fetch('/processos', {
    headers: { Authorization: `Bearer ${token}` }
  });

  const processos = await res.json();

  processos.forEach(p => {
    const option = document.createElement('option');
    option.value = p.id;
    option.textContent = p.numero;
    select.appendChild(option);
  });
}

/* =====================
   SALVAR PRAZO
===================== */
async function salvarPrazo() {
  const processoId = document.getElementById('processoId').value;
  const tipo = document.getElementById('tipo').value;
  const descricao = document.getElementById('descricao').value;
  const dataLimite = document.getElementById('dataLimite').value;

  if (!processoId || !tipo || !dataLimite) {
    alert('Preencha os campos obrigat√≥rios');
    return;
  }

  const res = await fetch('/prazos', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      Authorization: `Bearer ${token}`
    },
    body: JSON.stringify({
      processoId,
      tipo,
      descricao,
      dataLimite
    })
  });

  if (!res.ok) {
  const data = await res.json();

  if (data.codigo === 'LIMITE_PLANO_ATINGIDO') {
    alert(data.erro + '\n\n' + data.sugestao);
    abrirModalUpgrade();
    return;
  }

  alert(data.erro || 'Erro ao cadastrar prazo');
  return;
}

  alert('Prazo criado com sucesso ‚úÖ');
  toggleFormularioPrazo();
  carregarTodos();
}

/* =====================
   PRAZOS
===================== */
async function carregarPrazos(url, id) {
  const ul = document.getElementById(id);
  ul.innerHTML = '';

  const res = await fetch(url, {
    headers: { Authorization: `Bearer ${token}` }
  });

  const dados = await res.json();

  if (dados.length === 0) {
    ul.innerHTML = '<li class="list-group-item">Nenhum prazo</li>';
    return;
  }

  dados.forEach(p => {
    const li = document.createElement('li');
    li.className = 'list-group-item';
    li.innerHTML = `
  <strong>${p.tipo}</strong> ‚Äî ${p.descricao}<br>
  üìÖ ${new Date(p.data_limite).toLocaleDateString()} |
  üìÅ Processo: ${p.processo_numero}
  ${
    p.status !== 'concluido'
      ? `<br>
         <button class="btn btn-sm btn-success mt-2"
                 onclick="concluirPrazo(${p.id})">
           ‚úî Concluir
         </button>`
      : ''
  }
`;
    ul.appendChild(li);
  });
}

function carregarTodos() {
  carregarPrazos('/dashboard/prazos-vencidos', 'vencidos');
  carregarPrazos('/dashboard/prazos-semana', 'semana');
  carregarPrazos('/dashboard/prazos-futuros', 'futuros');
  carregarPrazos('/dashboard/prazos-concluidos', 'concluidos');
}

carregarTodos();

async function concluirPrazo(prazoId) {
  const confirmar = confirm('Deseja marcar este prazo como conclu√≠do?');
  if (!confirmar) return;

  try {
    const response = await fetch(`/prazos/${prazoId}/concluir`, {
      method: 'PATCH',
      headers: {
        Authorization: `Bearer ${localStorage.getItem('token')}`
      }
    });

    const data = await response.json();

    if (!response.ok) {
      alert(data.erro || 'Erro ao concluir prazo');
      return;
    }

    alert('Prazo conclu√≠do ‚úÖ');

    // Atualiza listas
    carregarPrazos('/dashboard/prazos-vencidos', 'vencidos');
    carregarPrazos('/dashboard/prazos-semana', 'semana');
    carregarPrazos('/dashboard/prazos-futuros', 'futuros');
    carregarPrazos('/dashboard/prazos-concluidos', 'concluidos');

  } catch (error) {
    alert('Erro de comunica√ß√£o com o servidor');
  }
}
async function carregarPlanoConsumo() {
  try {
    const response = await fetch('/plano-consumo', {
      headers: {
        Authorization: `Bearer ${localStorage.getItem('token')}`
      }
    });

    const data = await response.json();

    document.getElementById('plano-nome').innerText = data.plano;
    
    const btnUpgrade = document.getElementById('btn-upgrade');

// Se for plano Premium, esconder bot√£o e mostrar mensagem
if (data.plano === 'Premium' && !MODO_TESTE_UPGRADE) {
  btnUpgrade.style.display = 'none';

  // cria mensagem se ainda n√£o existir
  let msgPremium = document.getElementById('msg-premium');

  if (!msgPremium) {
    msgPremium = document.createElement('p');
    msgPremium.id = 'msg-premium';
    msgPremium.className = 'text-success fw-semibold mt-2';
    msgPremium.innerText = '‚≠ê Voc√™ j√° est√° no plano Premium';

    btnUpgrade.parentElement.appendChild(msgPremium);
  }

} else {
  // Se N√ÉO for premium, garante que o bot√£o apare√ßa
  btnUpgrade.style.display = 'inline-block';

  const msgPremium = document.getElementById('msg-premium');
  if (msgPremium) msgPremium.remove();
}
    document.getElementById('prazos-usados').innerText = data.prazos_usados;

    if (data.limite_prazos !== null) {
        document.getElementById('prazos-limite').innerText = data.limite_prazos;

      const percentual = Math.min(
        (data.prazos_usados / data.limite_prazos) * 100,
        100
      );

      const barra = document.getElementById('barra-consumo');
      barra.style.width = `${percentual}%`;
      barra.innerText = `${Math.round(percentual)}%`;

      if (percentual >= 80) {
        barra.classList.add('bg-warning');
      }
      if (percentual >= 100) {
        barra.classList.add('bg-danger');
      }
    } else {
      document.getElementById('prazos-limite').innerText = 'Ilimitado';
      document.getElementById('barra-consumo').style.width = '100%';
    }

  } catch (error) {
    console.error('Erro ao carregar plano e consumo');
  }
}

carregarPlanoConsumo();

/* =====================
   UPGRADE DE PLANO
===================== */

async function carregarPlanosParaUpgrade() {
  const select = document.getElementById('planoSelecionado');
  select.innerHTML = '<option value="">Selecione um plano</option>';

  try {
    const response = await fetch('/api/planos', {
      headers: {
        Authorization: `Bearer ${localStorage.getItem('token')}`
      }
    });

    const planos = await response.json();

    planos.forEach(plano => {
      const option = document.createElement('option');
      option.value = plano.id;
      option.textContent = plano.nome;
      select.appendChild(option);
    });

  } catch (error) {
    console.error('Erro ao carregar planos', error);
    select.innerHTML = '<option value="">Erro ao carregar planos</option>';
  }
}
function abrirModalUpgrade() {
  carregarPlanosParaUpgrade(); // üî• AQUI
  
  const modal = new bootstrap.Modal(
    document.getElementById('modalUpgrade')
  );
  modal.show();
}
async function confirmarUpgrade() {
  const planoId = document.getElementById('planoSelecionado').value;

  if (!planoId) {
    alert('Selecione um plano');
    return;
  }

  const confirmar = confirm(
    'Tem certeza que deseja mudar o plano do escrit√≥rio?'
  );

  if (!confirmar) return;

  try {
    const response = await fetch('/api/upgrade', {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${localStorage.getItem('token')}`
      },
      body: JSON.stringify({ planoId })
    });

    // ‚ö†Ô∏è DEBUG IMPORTANTE
    if (!response.ok) {
      const texto = await response.text();
      console.error('Resposta do servidor:', texto);
      alert('Erro retornado pelo servidor. Veja o console.');
      return;
    }

    const data = await response.json();

    alert('Plano atualizado com sucesso üöÄ');
    carregarPlanoConsumo();

    const modalEl = document.getElementById('modalUpgrade');
    const modal = bootstrap.Modal.getInstance(modalEl);
    if (modal) modal.hide();

  } catch (error) {
    console.error('Erro real:', error);
    alert('Erro de comunica√ß√£o com o servidor');
  }
}
</script>

</body>
</html>
