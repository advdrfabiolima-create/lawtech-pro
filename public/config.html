<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LawTech Pro ‚Äî Configura√ß√µes</title>
    <link rel="icon" type="image/png" href="favicon.png">
    
    <!-- Cole aqui o bloco de fontes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/lucide@0.451.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            /* Light Theme Colors - Professional & Clean */
            --bg-primary: #f8fafc;
            --bg-secondary: #111827;
            --bg-tertiary: #1a2332;
            --bg-elevated: #ffffff;
            
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-tertiary: #64748b;
            
            --accent-blue: #2563eb;
            --accent-blue-light: #3b82f6;
            --accent-blue-glow: rgba(37, 99, 235, 0.3);
            
            --accent-green: #10b981;
            --accent-purple: #8b5cf6;
            --accent-orange: #f59e0b;
            --accent-red: #ef4444;
            --accent-gold: #fbbf24;
            
            --border-subtle: rgba(0, 0, 0, 0.08);
            --border-medium: rgba(0, 0, 0, 0.12);
            
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            
            --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Compatibility */
            --bg: var(--bg-primary);
            --sidebar: var(--bg-secondary);
            --white: var(--bg-elevated);
            --border: var(--border-medium);
            --primary: var(--accent-blue);
            --success: var(--accent-green);
            --danger: var(--accent-red);
            --warning: var(--accent-orange);
            --muted: var(--text-tertiary);
            --text-main: var(--text-primary);
            --text-menu: var(--text-tertiary);
            --sidebar-hover: var(--bg-tertiary);
            --radius: var(--radius-md);
        }

        /* Reset LawTech Pro */
        * { box-sizing: border-box; font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--text-main); line-height: 1.5; }

        /* Sidebar Premium */
        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-right: 1px solid var(--border-subtle);
            padding: 32px 24px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 1000;
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .sidebar-header img {
            width: 100%;
            max-width: 180px;
            height: auto;
            filter: drop-shadow(0 0 20px var(--accent-blue-glow));
            transition: all var(--transition-base);
        }

        .sidebar-header img:hover {
            filter: drop-shadow(0 0 30px var(--accent-blue-glow));
            transform: scale(1.05);
        }

        .menu {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex-grow: 1;
        }

        .menu a {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            color: #94a3b8;
            text-decoration: none;
            border-radius: var(--radius-lg);
            font-size: 14px;
            font-weight: 600;
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .menu a::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--accent-blue);
            transform: scaleY(0);
            transition: transform var(--transition-base);
        }

        .menu a:hover::before,
        .menu a.active::before {
            transform: scaleY(1);
        }

        .menu a i {
            margin-right: 12px;
            font-size: 18px;
            transition: all var(--transition-base);
        }

        .menu a:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #e2e8f0;
            transform: translateX(4px);
        }

        .menu a.active {
            background: rgba(37, 99, 235, 0.15);
            color: #60a5fa;
            border: 1px solid rgba(37, 99, 235, 0.4);
        }

        .menu a.active i {
            color: #60a5fa;
        }

        .sidebar-footer {
            padding-top: 24px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 12px;
            margin-top: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .sidebar-footer span {
            color: #cbd5e1 !important;
        }

        /* √Årea Principal Alinhada */
        .main { margin-left: 280px; min-height: 100vh; display: flex; flex-direction: column; }
        
        .header { 
            background: var(--white); height: 72px; padding: 0 32px; 
            display: flex; align-items: center; justify-content: space-between; 
            border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 900; 
        }

        .content { 
            padding: 40px; 
            max-width: 900px; /* Largura ideal para formul√°rios */
            margin: 0 auto;  /* Centraliza na tela */
            width: 100%; 
        }
        /* Cards Estilo Dashboard */
        .card { 
            background: var(--white); padding: 28px; border-radius: var(--radius); 
            border: 1px solid var(--border); margin-bottom: 24px; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); 
        }
        .card-title { 
            font-size: 16px; font-weight: 700; color: var(--text-main); 
            margin-bottom: 20px; display: flex; align-items: center; gap: 10px; 
        }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        label { 
            display: block; font-size: 11px; font-weight: 700; 
            color: var(--muted); margin-bottom: 8px; text-transform: uppercase; 
            letter-spacing: 0.5px;
        }
        
        input, select { 
            width: 100%; padding: 12px 16px; border: 1px solid var(--border); 
            border-radius: 8px; font-size: 14px; outline: none; background: #fff; 
            transition: border-color 0.2s;
        }
        input:focus { border-color: var(--primary); }
        input[readonly] { background: #f1f5f9; color: var(--muted); }
        
        .radio-group { display: flex; gap: 20px; margin-bottom: 15px; }
        .radio-option { display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 500; cursor: pointer; }

        .btn-save { 
            padding: 14px 24px; background: var(--primary); color: white; 
            border: none; border-radius: 8px; font-size: 14px; font-weight: 600; 
            cursor: pointer; transition: 0.2s; width: 100%; 
        }
        .btn-save:hover { background: #1d4ed8; transform: translateY(-1px); }

        .btn-pdf { 
            padding: 12px 20px; background: #10b981; color: white; 
            border: none; border-radius: 8px; font-size: 13px; font-weight: 600; 
            cursor: pointer; transition: 0.2s; margin-top: 10px; width: 100%;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-pdf:hover { background: #059669; }
        
        .status-badge { 
            font-size: 12px; margin-top: 10px; display: block; 
            font-weight: 600; color: var(--muted); text-align: center;
        }

        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
        }

        .btn-crm-gold-nav {
    background: #fbbf24 !important; /* Cor Gold */
    color: #000 !important;
    font-weight: 800 !important;
    margin-top: 15px !important;
    display: flex !important;
    align-items: center;
    justify-content: center;
    padding: 12px !important;
    border-radius: 8px;
    text-decoration: none;
    font-size: 14px;
    transition: 0.3s;
}
.btn-crm-gold-nav:hover { 
    background: #facc15 !important; 
    transform: scale(1.02); 
}
.btn-crm-gold-nav i { margin-right: 10px; }

.finance-actions {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-top: 20px;
}

.btn-secondary {
  background: #e2e8f0;
  color: #1e293b;
  font-weight: 600;
}

.btn-secondary:hover {
  background: #cbd5f5;
}

.btn-primary {
  background: #2563eb;
  font-weight: 700;
}

.divider {
  height: 1px;
  background: #e5e7eb;
  margin: 8px 0;
}

.status-badge.warning {
  font-size: 11px;
  color: #92400e;
  background: #fef3c7;
  padding: 8px;
  border-radius: 6px;
  text-align: center;
}

/* Padroniza√ß√£o LawTech Pro - Caixa Alta Global */
body {
    text-transform: uppercase;
}

/* Garante que os campos de digita√ß√£o tamb√©m mostrem caixa alta enquanto o usu√°rio digita */
input, textarea, select {
    text-transform: uppercase;
}

/* Opcional: Se quiser que os n√∫meros dos processos mantenham o estilo t√©cnico, 
   mas ainda em caixa alta */
.numero-processo, .processo-hash {
    font-family: 'JetBrains Mono', monospace;
    letter-spacing: 1px;
}

/* Container do rodap√© */
.sidebar-footer {
    padding-top: 20px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    margin-top: auto;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

/* Alinhamento √† esquerda (In√≠cio) */
.footer-info-row {
    display: flex;
    justify-content: flex-start; /* Alinha no come√ßo da linha */
    align-items: center;
    gap: 5px; /* Espa√ßo fixo ap√≥s os ":" */
    font-size: 12px;
}

/* R√≥tulos em caixa alta */
.footer-info-row span:first-child {
    text-transform: uppercase;
    color: var(--text-tertiary, #64748b);
    font-weight: 700;
    white-space: nowrap;
}

/* ‚úÖ Regra para e-mail e plano em min√∫sculas */
.keep-lowercase {
    text-transform: none !important; /* Cancela o uppercase global */
    font-variant: normal !important;
    color: #cbd5e1;
}
    </style>
</head>
<body>
        <aside class="sidebar">
        <div class="sidebar-header">
            <img src="Logo LawTech Pro_transparente.png" alt="LawTech Pro">
        </div>
        <nav class="menu">
            <a href="/dashboard"><i class="lucide lucide-layout-dashboard"></i> Dashboard</a>
            <a href="/clientes-page"><i class="lucide lucide-users"></i> Clientes</a>
            <a href="/prazos-page"><i class="lucide lucide-clock"></i> Prazos</a>
            <a href="/processos-page"><i class="lucide lucide-folder"></i> Processos</a>
            <a href="/audiencias-page"><i class="lucide lucide-calendar-days"></i> Audi√™ncias</a>
            <a href="/calculos-page"><i class="lucide lucide-calculator"></i> C√°lculos Jur√≠dicos</a>
            <a href="/financeiro-page"><i class="lucide lucide-credit-card"></i> Financeiro</a>
            <a href="/publicacoes-page"><i class="lucide lucide-clock"></i> Publica√ß√µes DJEN</a>
            <a href="/ia-page" style="display: flex; align-items: center; gap: 10px;">
                <i class="lucide lucide-sparkles" style="color: #fbbf24;"></i> IA Jur√≠dica 
                <span style="font-size: 9px; background: #fbbf24; color: #000; padding: 2px 5px; border-radius: 4px; font-weight: bold; margin-left: auto;">PREMIUM</span>
            </a>
            <a href="/planos-page"><i class="lucide lucide-award"></i> Gest√£o de Planos</a>
            <a href="/config-page" class="active"><i class="lucide lucide-settings"></i> Configura√ß√µes</a>
            <a href="/crm-page" class="btn-crm-gold-nav">
            <i class="lucide lucide-trending-up"></i> CRM PROSPEC√á√ÉO
            </a>
        </nav>

<div class="sidebar-footer">
    <div class="footer-info-row">
        <span>Usu√°rio:</span> 
        <span id="userEmailFooter" class="keep-lowercase">...</span>
    </div>
    
    <div class="footer-info-row">
        <span>Plano:</span> 
        <span id="planNameFooter" class="keep-lowercase">...</span>
    </div>
</div>
    </aside>

    <div class="main">
        <header class="header">
            <h2 style="font-size: 18px; font-weight: 600;">‚öôÔ∏è Configura√ß√µes</h2>
            <div style="position: relative; display: flex; align-items: center; gap: 15px;">
                <span id="userNameHeader" style="font-size: 14px; font-weight: 500; color: var(--muted);">Advogado</span>
                <div onclick="toggleUserMenu()" id="userCircle" style="width: 40px; height: 40px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; border: 2px solid #e2e8f0;">
                    --
                </div>
                <div id="userDropdown" style="display: none; position: absolute; top: 55px; right: 0; background: white; border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); width: 200px; z-index: 1001;">
                    <a href="/config-page" style="display: block; padding: 12px 16px; color: var(--text-main); text-decoration: none; font-size: 14px; border-bottom: 1px solid var(--border);">üë§ Meus Dados</a>
                    <a href="#" onclick="logout()" style="display: block; padding: 12px 16px; color: var(--danger); text-decoration: none; font-size: 14px;">üö™ Sair</a>
                </div>
            </div>
        </header>
<div class="content">
    <!-- Acesso Pessoal -->
    <div class="card">
        <div class="card-title"><i data-lucide="user"></i> Acesso Pessoal</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group">
                <label>Seu Nome Completo</label>
                <input type="text" id="perfilNome" placeholder="Seu Nome">
            </div>
            <div class="form-group">
                <label>E-mail de Login</label>
                <input type="email" id="perfilEmail" readonly title="O e-mail n√£o pode ser alterado por seguran√ßa.">
            </div>
        </div>
        <button class="btn-save" style="margin-top:15px; width: auto; padding: 10px 30px;" onclick="salvarPerfil()">
            Atualizar Nome
        </button>
    </div>

    <!-- Dados do Escrit√≥rio e Faturamento -->
    <div class="card">
        <div class="card-title"><i data-lucide="building-2"></i> Dados do Escrit√≥rio e Faturamento</div>
        
        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div class="form-group">
                <label>Advogado Respons√°vel <span style="color:red">*</span></label>
                <input type="text" id="confAdvogadoResponsavel">
            </div>
            <div class="form-group">
                <label>OAB Principal <span style="color:red">*</span></label>
                <input type="text" id="confOab" oninput="aplicarMascaraOAB(this)" placeholder="000.000/UF">
            </div>
            <div class="form-group">
                <label>Renda Mensal (R$) <span style="color:red">*</span></label>
                <input type="text" id="confRendaMensal" oninput="mascaraMoeda(this)" placeholder="R$ 0,00">
            </div>
        </div>

        <div class="form-group" style="margin-bottom: 15px;">
            <label>Tipo de Pessoa <span style="color:red">*</span></label>
            <div class="radio-group">
                <label class="radio-option">
                    <input type="radio" name="tipoDoc" value="CPF" checked onclick="ajustarMascaraDoc()"> Pessoa F√≠sica (CPF)
                </label>
                <label class="radio-option">
                    <input type="radio" name="tipoDoc" value="CNPJ" onclick="ajustarMascaraDoc()"> Pessoa Jur√≠dica (CNPJ)
                </label>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 2fr 1.2fr 0.8fr; gap: 15px; margin-bottom: 15px;">
            <div class="form-group">
                <label>Nome / Raz√£o Social <span style="color:red">*</span></label>
                <input type="text" id="confEscritorio">
            </div>
            <div class="form-group">
                <label>Documento (CPF/CNPJ) <span style="color:red">*</span></label>
                <input type="text" id="confDocumento" oninput="aplicarMascaraDoc(this)">
            </div>
            <div class="form-group" id="groupDataNascimento">
                <label>Nascimento <span style="color:red">*</span></label>
                <input type="date" id="confDataNascimento">
            </div>
        </div>
       
        <div style="display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div class="form-group">
                <label>CEP <span style="color:red">*</span></label>
                <input type="text" id="confCep" oninput="mascaraCEP(this)" onblur="buscarCep()" placeholder="00.000-000">
            </div>
            <div class="form-group">
                <label>Cidade <span style="color:red">*</span></label>
                <input type="text" id="confCidade">
            </div>
            <div class="form-group">
                <label>UF <span style="color:red">*</span></label>
                <input type="text" id="confEstado" maxlength="2" placeholder="Ex: BA">
            </div>
        </div>

        <div class="form-group">
            <label>Endere√ßo Completo <span style="color:red">*</span></label>
            <input type="text" id="confEndereco" placeholder="Rua, N√∫mero, Bairro">
        </div>

        <div style="margin-top: 20px; padding: 12px; border-left: 4px solid #2563eb; background: #f1f5f9; border-radius: 6px;">
            <span style="font-size: 12px; color: #475569; font-weight: 600; text-transform: uppercase;">
                ‚úÖ Checklist: Salve todos os dados acima antes de ativar o financeiro.
            </span>
        </div>

        <div style="display: flex; gap: 15px; margin-top: 25px;">
            <button class="btn-save" onclick="salvarDadosJuridicos()">Salvar Dados do Escrit√≥rio</button>
        </div>
    </div>

    <!-- Configura√ß√£o de Repasse (Asaas) -->
    <div class="card" style="border-top: 4px solid var(--success);">
        <div class="card-title">
            <i data-lucide="banknote"></i> Configura√ß√£o de Repasse (Asaas)
        </div>

        <!-- Dados Banc√°rios -->
        <div style="display: grid; grid-template-columns: 2fr 1fr 1.5fr 0.5fr; gap: 12px; margin-bottom: 15px;">
            <div class="form-group">
                <label>Banco <span style="color:red">*</span></label>
                <select id="confBanco">
                    <option value="">Carregando bancos...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Ag√™ncia <span style="color:red">*</span></label>
                <input type="text" id="confAgencia" placeholder="0000">
            </div>
            <div class="form-group">
                <label>Conta <span style="color:red">*</span></label>
                <input type="text" id="confConta" placeholder="00000">
            </div>
            <div class="form-group">
                <label>D√≠gito <span style="color:red">*</span></label>
                <input type="text" id="confContaDigito" placeholder="0">
            </div>
        </div>

        <!-- PIX -->
        <div class="form-group" style="margin-bottom: 20px;">
            <label>Chave PIX para Recebimento</label>
            <input type="text" id="confPixChave" placeholder="E-mail, CPF ou Chave Aleat√≥ria">
        </div>

        <!-- A√ß√µes -->
        <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 20px;">
            <button class="btn-save" onclick="salvarDadosJuridicos()">
                üíæ Salvar Dados Banc√°rios
            </button>

            <button id="btnAtivarFaturamento" class="btn-save" style="background: #10b981;" onclick="ativarFinanceiro()">
                üöÄ Ativar Faturamento
            </button>

            <span class="status-badge" style="background: #fef3c7; color: #92400e; padding: 8px 12px; border-radius: 6px; font-size: 13px;">
                ‚ö†Ô∏è A conta banc√°ria deve ser vinculada ao CPF/CNPJ informado para liberar a emiss√£o de boletos.
            </span>
        </div>
    </div>

    <!-- Gest√£o de Equipe -->
    <div class="card">
        <div class="card-title">
            <i data-lucide="users"></i> Gest√£o de Equipe
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px; margin-bottom: 15px;">
            <div class="form-group">
                <label>Nome</label>
                <input type="text" id="eqNome" autocomplete="off">
            </div>
            <div class="form-group">
                <label>E-mail</label>
                <input type="email" id="eqEmail" autocomplete="off">
            </div>
            <div class="form-group">
                <label>Senha</label>
                <input type="password" id="eqSenha" autocomplete="new-password">
            </div>
            <div class="form-group">
                <label>Permiss√£o</label>
                <select id="eqRole">
                    <option value="operador">Operador</option>
                    <option value="visualizador">Leitura</option>
                    <option value="admin">Administrador</option>
                </select>
            </div>
        </div>

        <button class="btn-save" style="width: auto; padding: 10px 30px;" onclick="salvarMembro()">
            Adicionar √† Equipe
        </button>

        <div id="listaEquipe" style="margin-top: 20px; border-top: 1px solid var(--border);"></div>
    </div>

    <!-- Alterar Minha Senha -->
    <div class="card">
        <div class="card-title">
            <i data-lucide="lock"></i> Alterar Minha Senha
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group">
                <label>Nova Senha</label>
                <input type="password" id="novaSenha">
            </div>
            <div class="form-group">
                <label>Confirmar Nova Senha</label>
                <input type="password" id="confirmaSenha">
            </div>
        </div>

        <button class="btn-save" style="background: var(--muted); margin-top: 15px; width: auto; padding: 10px 30px;" onclick="alterarSenha()">
            Atualizar Senha
        </button>        
    </div>
   
<!-- Integra√ß√µes com APIs Externas -->
<div class="card" style="border-top: 4px solid #8b5cf6;">
    <div class="card-title">
        <i data-lucide="plug"></i> Integra√ß√µes com APIs Externas
    </div>

    <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
        <strong style="color: #0c4a6e; font-size: 14px; display: block; margin-bottom: 8px;">
            üí° Como funciona?
        </strong>
        <p style="font-size: 13px; color: #0369a1; line-height: 1.6; margin: 0;">
            <strong>Sem chave API:</strong> Voc√™ adiciona publica√ß√µes manualmente copiando do DJEN oficial.<br>
            <strong>Com chave API:</strong> O sistema busca automaticamente as publica√ß√µes para voc√™ (monitoramento 24/7).
        </p>
    </div>

    <!-- Escavador API -->
    <div style="margin-bottom: 32px;">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
            <img src="https://www.escavador.com/assets/images/logo-escavador.png" 
                 alt="Escavador" 
                 style="height: 24px; object-fit: contain;"
                 onerror="this.style.display='none'">
            <h4 style="font-size: 15px; font-weight: 700; color: var(--text-main);">
                Escavador - Monitoramento DJEN
            </h4>
            <span id="badgeEscavador" style="font-size: 10px; padding: 4px 8px; border-radius: 4px; font-weight: 700; background: #fee2e2; color: #991b1b;">
                DESATIVADO
            </span>
        </div>

        <div class="form-group" style="margin-bottom: 16px;">
            <label>Chave API do Escavador (Opcional)</label>
            <input type="password" 
                   id="escavadorApiKey" 
                   class="form-input" 
                   placeholder="Deixe vazio para usar inser√ß√£o manual"
                   style="font-family: monospace;">
            <small style="font-size: 11px; color: var(--muted); display: block; margin-top: 6px;">
                ‚ö†Ô∏è Esta chave ser√° usada com <strong>SUA conta do Escavador</strong>. Voc√™ gerencia seus pr√≥prios cr√©ditos.
            </small>
        </div>

        <div style="display: flex; gap: 12px;">
            <button class="btn-save" style="flex: 1;" onclick="salvarChaveEscavador()">
                üíæ Salvar Chave
            </button>
            <button class="btn-save" 
                    style="flex: 1; background: #10b981;" 
                    onclick="testarChaveEscavador()"
                    id="btnTestarEscavador">
                üîç Testar Conex√£o
            </button>
        </div>

        <div id="resultadoTesteEscavador" style="margin-top: 16px; display: none;"></div>
    </div>

    <!-- Informa√ß√µes Adicionais -->
    <div style="background: #fef3c7; border: 1px solid #fde68a; border-radius: 8px; padding: 16px;">
        <div style="display: flex; align-items: start; gap: 12px;">
            <span style="font-size: 20px;">üìö</span>
            <div>
                <strong style="color: #78350f; font-size: 13px; display: block; margin-bottom: 6px;">
                    Como obter minha chave API do Escavador?
                </strong>
                <ol style="font-size: 12px; color: #92400e; line-height: 1.7; margin: 0; padding-left: 20px;">
                    <li>Acesse <a href="https://www.escavador.com" target="_blank" style="color: #2563eb; font-weight: 600;">www.escavador.com</a></li>
                    <li>Fa√ßa login na sua conta</li>
                    <li>V√° em "Configura√ß√µes" ‚Üí "API"</li>
                    <li>Gere uma nova chave e cole aqui</li>
                </ol>
            </div>
        </div>
    </div>
</div>

 <div style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 2px solid var(--border); padding: 32px; border-radius: 16px; margin-top: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
    
    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px;">
        <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(59,130,246,0.2);">
            <i data-lucide="credit-card" style="color: var(--primary); width: 24px; height: 24px;"></i>
        </div>
        <div>
            <h3 style="font-size: 18px; font-weight: 700; color: var(--text-main); margin: 0;">Assinatura e Pagamento</h3>
            <p style="font-size: 12px; color: var(--muted); margin: 0;">Gerencie sua assinatura e per√≠odo de teste</p>
        </div>
    </div>

    <div id="containerTrial" style="background: #fffbeb; border: 2px solid #fde68a; border-radius: 12px; padding: 20px; margin-bottom: 20px; transition: all 0.3s;">
        <div style="display: flex; align-items: flex-start; gap: 12px;">
            <div id="iconeTrialBox" style="background: #fbbf24; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                <i id="iconeTrial" data-lucide="clock" style="color: #000; width: 18px; height: 18px;"></i>
            </div>
            <div style="flex: 1;">
                <div id="labelTrial" style="font-size: 11px; font-weight: 700; color: #92400e; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">PER√çODO DE TESTE GRATUITO</div>
                <p id="textoTrial" style="font-size: 14px; color: #78350f; line-height: 1.6; margin: 0;">
                    Seu teste vence em <strong style="font-weight: 800; color: #92400e;" id="dataExpiracaoTrial">...</strong><br>
                    <span id="subtextoTrial" style="font-size: 12px;">Ap√≥s esta data, a mensalidade ser√° processada automaticamente no cart√£o cadastrado.</span>
                </p>
            </div>
        </div>
    </div>

    <div style="background: #f0fdf4; border-left: 4px solid #10b981; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
        <div style="display: flex; gap: 10px; align-items: flex-start;">
            <i class="lucide lucide-shield-check" style="color: #10b981; width: 20px; height: 20px; flex-shrink: 0; margin-top: 2px;"></i>
            <div>
                <div style="font-size: 12px; font-weight: 700; color: #065f46; margin-bottom: 4px;">Seus dados est√£o protegidos</div>
                <div style="font-size: 12px; color: #166534; line-height: 1.5;">O cancelamento interrompe cobran√ßas futuras imediatamente.</div>
            </div>
        </div>
    </div>

    <div id="containerAcaoAssinatura">
        <button id="btnAcaoAssinatura" onclick="solicitarCancelamento()" style="width: 100%; background: #fef2f2; border: 2px solid #fecaca; color: #991b1b; padding: 14px 20px; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 700; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;">
            <i class="lucide lucide-x-circle" style="width: 18px; height: 18px;"></i>
            Cancelar Renova√ß√£o Autom√°tica
        </button>
    </div>
    
    <p id="footerAvisoAssinatura" style="font-size: 11px; color: var(--muted); text-align: center; margin-top: 12px; margin-bottom: 0;">
        Ao cancelar, voc√™ manter√° acesso completo at√© o final do per√≠odo de teste.
    </p>
</div>

<script>
    const token = localStorage.getItem('token');
    let dadosSalvos = false;
    if (!token) window.location.href = '/login.html';

    // 1. M√ÅSCARAS E UTILIT√ÅRIOS
    function mascaraCEP(i) {
        let v = i.value.replace(/\D/g, ''); 
        if (v.length > 5) i.value = v.slice(0, 2) + '.' + v.slice(2, 5) + '-' + v.slice(5, 8);
        else if (v.length > 2) i.value = v.slice(0, 2) + '.' + v.slice(2);
    }

    async function buscarCep() {
        const inputCep = document.getElementById('confCep');
        if (!inputCep) return;
        const cepRaw = inputCep.value.replace(/\D/g, '');
        if (cepRaw.length !== 8) return;
        try {
            const res = await fetch(`https://viacep.com.br/ws/${cepRaw}/json/`);
            const data = await res.json();
            if (!data.erro) {
                if(document.getElementById('confEndereco')) document.getElementById('confEndereco').value = `${data.logradouro}, ${data.bairro}`;
                if(document.getElementById('confCidade')) document.getElementById('confCidade').value = data.localidade;
                if(document.getElementById('confEstado')) document.getElementById('confEstado').value = data.uf;
            }
        } catch (err) { console.error("Erro Viacep:", err); }
    }

    function mascaraMoeda(i) {
        let v = i.value.replace(/\D/g,'');
        v = (v/100).toFixed(2) + '';
        v = v.replace(".", ",");
        v = v.replace(/(\d)(\d{3})(\d{3}),/g, "$1.$2.$3,");
        v = v.replace(/(\d)(\d{3}),/g, "$1.$2,");
        i.value = 'R$ ' + v;
    }

    function ajustarMascaraDoc() {
        const inputDoc = document.getElementById('confDocumento');
        const groupData = document.getElementById('groupDataNascimento');
        const radioCpf = document.querySelector('input[name="tipoDoc"]:checked');
        if (!inputDoc) return;
        
        inputDoc.value = '';
        const tipo = radioCpf ? radioCpf.value : 'CPF';
        if (tipo === 'CPF') {
            inputDoc.placeholder = '000.000.000-00';
            if (groupData) groupData.style.display = 'block';
        } else {
            inputDoc.placeholder = '00.000.000/0000-00';
            if (groupData) groupData.style.display = 'none';
        }
    }

    function aplicarMascaraDoc(i) {
        if (!i) return;
        const radioCpf = document.querySelector('input[name="tipoDoc"]:checked');
        const tipo = radioCpf ? radioCpf.value : 'CPF';
        let v = i.value.replace(/\D/g, '');
        if (tipo === 'CPF') {
            i.value = v.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4").slice(0, 14);
        } else {
            i.value = v.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, "$1.$2.$3/$4-$5").slice(0, 18);
        }
    }

    function aplicarMascaraOAB(i) {
        let v = i.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        if (v.length > 6) i.value = v.slice(0, 3) + '.' + v.slice(3, 6) + '/' + v.slice(6, 8);
        else if (v.length > 3) i.value = v.slice(0, 3) + '.' + v.slice(3);
        else i.value = v;
    }

    // 2. CARREGAMENTO DE DADOS
    async function carregarBancos() {
        try {
            const res = await fetch('https://brasilapi.com.br/api/banks/v1');
            const bancos = await res.json();
            const select = document.getElementById('confBanco');
            if (!select) return;
            select.innerHTML = '<option value="">Selecione o Banco</option>';
            bancos.sort((a,b) => (a.fullName || "") > (b.fullName || "") ? 1 : -1).forEach(b => {
                if(b.code) select.innerHTML += `<option value="${b.code}">${b.code} - ${b.fullName || b.name}</option>`;
            });
        } catch (e) { console.error("Erro bancos:", e); }
    }

async function carregarInfoRodape() {
    try {
        // 1. Busca dados do Usu√°rio (Identidade e Trial)
        const resUser = await fetch('/api/auth/me', { headers: { Authorization: `Bearer ${token}` } });
        const dataUser = await resUser.json();
        
        if (dataUser.ok) {
            const user = dataUser.usuario;
            const nomeReal = user.nome || 'Advogado';
            
            // --- L√ìGICA PADRONIZADA DO CABE√áALHO ---
            const primeiroNome = nomeReal.trim().split(' ')[0];
            document.getElementById('userNameHeader').innerText = primeiroNome;

            // Iniciais (C√≠rculo)
            const partes = nomeReal.trim().split(' ').filter(n => n);
            let iniciais = partes[0][0];
            if (partes.length > 1) iniciais += partes[partes.length - 1][0];
            
            const circulo = document.getElementById('userCircle');
            if (circulo) circulo.innerText = iniciais.toUpperCase();

            // Preenchimento de E-mail e Nome no formul√°rio
            // Nota: usei 'userEmailFooter' conforme o padr√£o de IDs corrigido anteriormente
            const footerEmail = document.getElementById('userEmailFooter');
            if (footerEmail) footerEmail.innerText = user.email;
            
            if(document.getElementById('perfilEmail')) document.getElementById('perfilEmail').value = user.email;
            if(document.getElementById('perfilNome')) document.getElementById('perfilNome').value = nomeReal;

            // --- L√ìGICA DO C√ÅLCULO DE VENCIMENTO DO TRIAL (7 DIAS) ---
            // Agora usando dias_restantes que vem do backend
            if (user.dias_restantes !== undefined && user.dias_restantes !== null) {
                // Calcula a data de expira√ß√£o baseada nos dias restantes
                const hoje = new Date();
                const dataExpiracao = new Date(hoje);
                dataExpiracao.setDate(dataExpiracao.getDate() + parseInt(user.dias_restantes));
                
                const dataFormatada = dataExpiracao.toLocaleDateString('pt-BR');
                const elementoData = document.getElementById('dataExpiracaoTrial');
                if (elementoData) elementoData.innerText = dataFormatada;
                
                // Atualiza o texto para mostrar quantos dias faltam
                const textoTrial = document.getElementById('textoTrial');
                if (textoTrial && user.dias_restantes !== null) {
                    const diasRestantes = parseInt(user.dias_restantes);
                    const textoPlural = diasRestantes === 1 ? 'dia' : 'dias';
                    textoTrial.innerHTML = `Seu teste vence em <strong style="font-weight: 800; color: #92400e;">${diasRestantes} ${textoPlural}</strong> (<strong style="font-weight: 800; color: #92400e;">${dataFormatada}</strong>)<br>
                    <span id="subtextoTrial" style="font-size: 12px;">Ap√≥s esta data, a mensalidade ser√° processada automaticamente no cart√£o cadastrado.</span>`;
                }
            }
        }

        // 2. Carregamento do Plano e Consumo
        const resPlan = await fetch('/api/plano-consumo', { headers: { Authorization: `Bearer ${token}` } });
        const dataPlan = await resPlan.json();
        const planFooter = document.getElementById('planNameFooter');
        if(planFooter) {
            planFooter.innerText = dataPlan.plano || 'Individual';
        }

        // 3. Carregamento dos dados do Escrit√≥rio e Dados Banc√°rios
        const resEsc = await fetch('/api/config/meu-escritorio', { headers: { Authorization: `Bearer ${token}` } });
        const dataEsc = await resEsc.json();
        
        if(dataEsc.ok && dataEsc.dados) {
            const d = dataEsc.dados;
            const campos = {
                'confAdvogadoResponsavel': d.advogado_responsavel,
                'confEscritorio': d.nome,
                'confOab': d.oab,
                'confDocumento': d.documento,
                'confDataNascimento': d.data_nascimento ? d.data_nascimento.split('T')[0] : '',
                'confCep': d.cep,
                'confCidade': d.cidade,
                'confEstado': d.estado,
                'confEndereco': d.endereco,
                'confAgencia': d.agencia,
                'confConta': d.conta,
                'confContaDigito': d.conta_digito,
                'confPixChave': d.pix_chave,
                'confBanco': d.banco_codigo
            };

            Object.keys(campos).forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = campos[id] || '';
            });

            if(d.renda_mensal && document.getElementById('confRendaMensal')) {
                document.getElementById('confRendaMensal').value = 'R$ ' + parseFloat(d.renda_mensal).toLocaleString('pt-BR', {minimumFractionDigits: 2});
            }

            // ‚úÖ VERIFICAR SE FATURAMENTO J√Å EST√Å ATIVADO
            if (d.plano_financeiro_status === 'ativo' || d.asaas_id) {
                const btnFaturamento = document.getElementById('btnAtivarFaturamento');
                if (btnFaturamento) {
                    btnFaturamento.disabled = true;
                    btnFaturamento.style.background = '#10b981';
                    btnFaturamento.style.opacity = '0.7';
                    btnFaturamento.style.cursor = 'not-allowed';
                    btnFaturamento.innerHTML = '‚úÖ Faturamento Ativado';
                    btnFaturamento.onclick = null; // Remove o evento de click
                }
            }

            // ‚úÖ L√ìGICA DE CANCELAMENTO ATIVO (Mudar bloco para Vermelho)
            if (d.renovacao_automatica === false) {
                const container = document.getElementById('containerTrial');
                const iconeBox = document.getElementById('iconeTrialBox');
                const label = document.getElementById('labelTrial');
                const texto = document.getElementById('textoTrial');
                const btnAcao = document.getElementById('btnAcaoAssinatura');
                const elementoDataVenc = document.getElementById('dataExpiracaoTrial');
                const dataVenc = elementoDataVenc ? elementoDataVenc.innerText : "...";

                if (container) {
                    // 1. Muda Estilo do Card para Vermelho/Rosa suave
                    container.style.background = "#fef2f2";
                    container.style.borderColor = "#fecaca";
                }
                
                if (iconeBox) {
                    iconeBox.style.background = "#ef4444";
                    iconeBox.innerHTML = '<i data-lucide="x-circle" style="color: #fff; width: 18px; height: 18px;"></i>';
                }
                
                if (label) {
                    label.innerText = "RENOVA√á√ÉO CANCELADA";
                    label.style.color = "#991b1b";
                }

                if (texto) {
                    texto.style.color = "#991b1b";
                    texto.innerHTML = `Voc√™ cancelou sua assinatura antes de vencer o per√≠odo de teste, portanto, <strong>n√£o haver√° cobran√ßas em seu cart√£o.</strong><br>` +
                                    `<span style="font-size: 12px;">Seu acesso continuar√° liberado at√© o dia ${dataVenc}.</span>`;
                }

                // 2. Transforma o bot√£o de "Cancelar" em "Reativar"
                if (btnAcao) {
                    btnAcao.style.background = "#f0fdf4";
                    btnAcao.style.borderColor = "#bbf7d0";
                    btnAcao.style.color = "#16a34a";
                    btnAcao.innerHTML = '<i class="lucide lucide-check-circle" style="width: 18px; height: 18px;"></i> Reativar Assinatura';
                    btnAcao.setAttribute("onclick", "reativarAssinatura()");
                }

                // Reinicializa os √≠cones Lucide para renderizar o novo √≠cone de erro/check
                if(window.lucide) lucide.createIcons();
            }
        }
    } catch (err) { 
        console.warn("Aviso: Falha ao carregar alguns dados do perfil ou trial."); 
        console.error(err);
    }
}

    // 3. A√á√ïES DE SALVAMENTO
    async function salvarPerfil() {
        const nome = document.getElementById('perfilNome').value;
        const res = await fetch('/api/config/perfil', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ nome })
        });
        if (res.ok) { alert("‚úÖ Nome atualizado!"); carregarInfoRodape(); }
        else alert("‚ùå Erro ao atualizar.");
    }

    async function salvarDadosJuridicos() {
        try {
            const rendaE = document.getElementById('confRendaMensal');
            const rendaTratada = rendaE ? rendaE.value.replace(/[R$\s.]/g, '').replace(',', '.') : 0;

            const dados = {
                advogado_responsavel: document.getElementById('confAdvogadoResponsavel')?.value || '',
                nome: document.getElementById('confEscritorio')?.value || '',
                oab: document.getElementById('confOab')?.value || '',
                documento: document.getElementById('confDocumento')?.value || '',
                dataNascimento: document.getElementById('confDataNascimento')?.value || null,
                email: document.getElementById('perfilEmail')?.value || '',
                endereco: document.getElementById('confEndereco')?.value || '',
                cidade: document.getElementById('confCidade')?.value || '',
                estado: document.getElementById('confEstado')?.value?.toUpperCase() || '',
                cep: document.getElementById('confCep')?.value?.replace(/\D/g, '') || '',
                banco_codigo: document.getElementById('confBanco')?.value || '',
                agencia: document.getElementById('confAgencia')?.value || '',
                conta: document.getElementById('confConta')?.value || '',
                conta_digito: document.getElementById('confContaDigito')?.value || '',
                pix_chave: document.getElementById('confPixChave')?.value || '',
                renda_mensal: parseFloat(rendaTratada) || 0
            };

            const res = await fetch('/api/config/escritorio', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(dados)
            });

            if (res.ok) alert("‚úÖ Dados salvos com sucesso!");
            else alert("‚ùå Erro ao salvar dados.");
        } catch (e) { console.error(e); alert("Erro ao processar salvamento."); }
    }

    async function salvarDadosBancarios() {
    const dados = {
        banco_codigo: document.getElementById('confBanco').value,
        agencia: document.getElementById('confAgencia').value,
        conta: document.getElementById('confConta').value,
        conta_digito: document.getElementById('confContaDigito').value,
        pix_chave: document.getElementById('confPixChave').value
    };

    const res = await fetch('/api/config/escritorio', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(dados)
    });

    if (res.ok) {
        dadosSalvos = true;
        document.querySelector('.btn-primary').disabled = false;
    } else {
        const d = await res.json();
        alert('‚ùå ' + (d.erro || 'Erro ao salvar'));
    }
}

    async function ativarFinanceiro() {
    try {
        const btn = document.querySelector('button[onclick*="ativarFinanceiro"]'); // Busca pelo bot√£o com onclick
        
        if (btn) {
            btn.disabled = true;
            btn.innerText = "‚è≥ Ativando...";
        }

        // ‚úÖ ROTA CORRETA
        const res = await fetch('/api/financeiro/ativar-subconta', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token') || token}`
            }
        });

        const data = await res.json();

        if (!res.ok) {
            throw new Error(data.erro || `Erro ${res.status}`);
        }

        if (data.ok) {
            alert('‚úÖ ' + (data.mensagem || 'Faturamento ativado com sucesso!'));
            
            // Atualiza o bot√£o permanentemente
            const btnFaturamento = document.getElementById('btnAtivarFaturamento');
            if (btnFaturamento) {
                btnFaturamento.disabled = true;
                btnFaturamento.style.background = '#10b981';
                btnFaturamento.style.opacity = '0.7';
                btnFaturamento.style.cursor = 'not-allowed';
                btnFaturamento.innerHTML = '‚úÖ Faturamento Ativado';
                btnFaturamento.onclick = null;
            }
            
            // Recarrega a p√°gina ap√≥s 1 segundo para atualizar todos os dados
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            throw new Error(data.erro || 'Falha ao ativar faturamento');
        }

    } catch (err) {
        console.error('Erro ao ativar faturamento:', err);
        
        let mensagemErro = 'Erro ao ativar faturamento: ';
        
        // Mensagens espec√≠ficas
        if (err.message.includes('incompleto')) {
            mensagemErro += 'Preencha todos os dados banc√°rios antes de continuar.';
        } else if (err.message.includes('CPF')) {
            mensagemErro += 'CPF/CNPJ inv√°lido. Verifique o documento informado.';
        } else if (err.message.includes('already exists')) {
            mensagemErro += 'Este CPF/CNPJ j√° possui conta no Asaas.';
        } else if (err.message.includes('Invalid access_token')) {
            mensagemErro += 'Chave API do Asaas inv√°lida. Verifique a configura√ß√£o no servidor.';
        } else if (err.message.includes('ambiente')) {
            mensagemErro += 'Problema de ambiente (sandbox/produ√ß√£o). Contate o suporte.';
        } else {
            mensagemErro += err.message;
        }
        
        alert('‚ùå ' + mensagemErro);
        
    } finally {
        const btn = document.querySelector('button[onclick*="ativarFinanceiro"]');
        if (btn && !btn.innerHTML.includes('Ativado')) {
            btn.disabled = false;
            btn.innerText = "üöÄ Ativar Faturamento";
        }
    }
}

    // 4. EQUIPE
async function carregarEquipe() {
    try {
        console.log('üîÑ Carregando equipe...');
        const res = await fetch('/api/auth/equipe', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        console.log('üì° Status da resposta:', res.status);
        
        if (!res.ok) {
            const errorText = await res.text();
            console.error('‚ùå Erro na resposta:', errorText);
            throw new Error(`Falha ao carregar equipe: ${res.status} - ${errorText}`);
        }

        const membros = await res.json();
        console.log('üë• Membros recebidos:', membros);
        
        const lista = document.getElementById('listaEquipe');
        if (!lista) {
            console.error('‚ùå Elemento listaEquipe n√£o encontrado');
            return;
        }

        lista.innerHTML = '';  // limpa antes

        if (!membros || membros.length === 0) {
            lista.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 20px;">Nenhum membro na equipe ainda.</p>';
            console.log('‚ÑπÔ∏è Nenhum membro encontrado');
            return;
        }

        membros.forEach(m => {
            lista.innerHTML += `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #f1f5f9;">
                    <div>
                        <div style="font-weight: 600; font-size: 14px;">${m.nome || 'Sem nome'}</div>
                        <div style="font-size: 12px; color: var(--muted);">${m.email || '‚Äî'}</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span style="background: #e0e7ff; color: #4338ca; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 700;">
                            ${ (m.role || 'operador').toUpperCase() }
                        </span>
                        <button onclick="excluirMembro(${m.id})" 
                                style="background: none; border: none; color: #ef4444; cursor: pointer; display: flex; align-items: center;">
                            <i data-lucide="trash-2" style="width: 18px; height: 18px;"></i>
                        </button>
                    </div>
                </div>
            `;
        });

        // Chama o Lucide **depois** de inserir todo o HTML novo
        if (typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function') {
            lucide.createIcons();
            console.log("‚úÖ √çcones Lucide atualizados com sucesso na lista de equipe");
        } else {
            console.warn("‚ö†Ô∏è Biblioteca Lucide n√£o encontrada ou createIcons indispon√≠vel");
        }
        
        console.log('‚úÖ Equipe carregada com sucesso!');

    } catch (e) {
        console.error("‚ùå Erro ao carregar equipe:", e);
        const lista = document.getElementById('listaEquipe');
        if (lista) {
            lista.innerHTML = `
                <p style="color: #ef4444; text-align: center; padding: 20px;">
                    Erro ao carregar a equipe. Tente recarregar a p√°gina.<br>
                    <small style="color: #64748b; font-size: 11px; margin-top: 8px; display: block;">
                        Detalhes: ${e.message}
                    </small>
                </p>`;
        }
    }
}

    async function excluirMembro(id) {
        if (!confirm("Remover integrante imediatamente?")) return;
        const res = await fetch(`/api/auth/equipe/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (res.ok) { alert("Acesso revogado."); carregarEquipe(); }
    }

    async function salvarMembro() {
        const nome = document.getElementById('eqNome').value;
        const email = document.getElementById('eqEmail').value;
        const senha = document.getElementById('eqSenha').value;
        const role = document.getElementById('eqRole').value;

        if (!nome || !email || !senha) return alert("Preencha todos os campos da equipe.");

        const res = await fetch('/api/auth/convidar-funcionario', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ nome, email, senha, role })
        });

        const data = await res.json();
        // ‚úÖ Interceptar erro 402 (Limite de usu√°rios)
        if (res.status === 402) {
            const msg = data.message || `Voc√™ atingiu o limite de ${data.max || 3} usu√°rios do plano ${data.current_plan || 'B√°sico'}.`;
            exibirAvisoUpgrade(msg);
            return;
        }
        if (res.ok) {
            alert('‚úÖ Funcion√°rio adicionado!');
            document.getElementById('eqNome').value = '';
            document.getElementById('eqEmail').value = '';
            document.getElementById('eqSenha').value = '';
            carregarEquipe();
        } else {
            alert('‚ùå Erro: ' + (data.erro || 'Acesso negado.'));
        }
    }

async function alterarSenha() {
    const s1 = document.getElementById('novaSenha').value.trim();
    const s2 = document.getElementById('confirmaSenha').value.trim();

    if (!s1) return alert("Digite a nova senha!");
    if (s1 !== s2) return alert("As senhas n√£o conferem!");
    if (s1.length < 6) return alert("A senha deve ter pelo menos 6 caracteres!");

    try {
        const res = await fetch('/api/senha', {
            method: 'PUT',
            headers: { 
                'Content-Type': 'application/json', 
                'Authorization': `Bearer ${token}` 
            },
            body: JSON.stringify({ senha: s1 })
        });

        const data = await res.json();

        if (res.ok) {
            alert("‚úÖ Senha alterada com sucesso!");
            document.getElementById('novaSenha').value = '';
            document.getElementById('confirmaSenha').value = '';
        } else {
            alert("‚ùå " + (data.erro || `Erro ${res.status}: ${res.statusText}`));
            console.log("Detalhes do erro:", data);
        }
    } catch (err) {
        console.error("Erro na requisi√ß√£o de senha:", err);
        alert("Falha na conex√£o. Verifique se o servidor est√° rodando.");
    }
}

    function toggleUserMenu() {
        const m = document.getElementById('userDropdown');
        if(m) m.style.display = m.style.display === 'none' ? 'block' : 'none';
    }

    function logout() { localStorage.removeItem('token'); window.location.href = '/login.html'; }

    // üïí FUN√á√ÉO PARA CALCULAR E EXIBIR DIAS RESTANTES DO TRIAL
async function carregarDataTrial() {
    // Esta fun√ß√£o foi simplificada - a data j√° √© configurada pela carregarInfoRodape()
    // que calcula corretamente a partir de data_criacao do usu√°rio
    console.log('‚úÖ Verifica√ß√£o de trial - data j√° configurada por carregarInfoRodape()');
}

window.onload = () => {
    carregarBancos();
    carregarInfoRodape();
    ajustarMascaraDoc();
    carregarEquipe();
    carregarChaveEscavador();
    carregarDataTrial(); // üÜï NOVA LINHA

    const elemento = document.getElementById('ID_DO_ELEMENTO');
    if (elemento) {
        elemento.disabled = true;
    }
};

    window.onclick = (e) => {
        if (!e.target.closest('#userCircle') && !e.target.closest('#userDropdown')) {
            const m = document.getElementById('userDropdown');
            if(m) m.style.display = 'none';
        }
    };

async function solicitarCancelamento() { // üöÄ Nome deve ser igual ao do 'onclick'
    if (!confirm("Doutor, deseja realmente cancelar a renova√ß√£o autom√°tica? Seu acesso ser√° mantido apenas at√© o fim dos 7 dias gratuitos.")) return;

    try {
        const res = await fetch('/api/planos/cancelar-agendamento', {
            method: 'POST',
            headers: { 
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            }
        });

        const data = await res.json();
        if (data.ok) {
            alert(data.msg);
            window.location.reload();
        } else {
            alert("Erro: " + (data.error || "Tente novamente mais tarde."));
        }
    } catch (err) {
        alert("Erro de conex√£o com o servidor.");
    }
}

async function reativarAssinatura() {
    if (!confirm("Deseja reativar a renova√ß√£o autom√°tica e garantir a continuidade do seu acesso?")) return;

    try {
        const res = await fetch('/api/planos/reativar', {
            method: 'PUT',
            headers: { 
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        const data = await res.json();
        if (data.ok) {
            alert("‚úÖ Assinatura reativada com sucesso, Doutor!");
            window.location.reload();
        } else {
            alert("Erro ao reativar: " + (data.error || "Tente novamente mais tarde."));
        }
    } catch (err) {
        alert("Erro de conex√£o com o servidor.");
    }
}

// ===== FUN√á√ïES DE INTEGRA√á√ÉO COM ESCAVADOR =====

async function carregarChaveEscavador() {
    try {
        const res = await fetch('/api/config/meu-escritorio', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        
        if (data.ok && data.dados && data.dados.escavador_api_key) {
            const input = document.getElementById('escavadorApiKey');
            if (input) {
                input.value = data.dados.escavador_api_key;
                // Atualiza badge
                const badge = document.getElementById('badgeEscavador');
                if (badge) {
                    badge.innerText = 'ATIVADO';
                    badge.style.background = '#d1fae5';
                    badge.style.color = '#065f46';
                }
            }
        }
    } catch (err) {
        console.error("Erro ao carregar chave Escavador:", err);
    }
}

async function salvarChaveEscavador() {
    const chave = document.getElementById('escavadorApiKey').value.trim();
    
    try {
        const res = await fetch('/api/config/escavador-key', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ escavador_api_key: chave })
        });

        const data = await res.json();

        if (res.ok) {
            alert('‚úÖ Chave API salva com sucesso!');
            
            // Atualiza badge
            const badge = document.getElementById('badgeEscavador');
            if (badge) {
                if (chave) {
                    badge.innerText = 'ATIVADO';
                    badge.style.background = '#d1fae5';
                    badge.style.color = '#065f46';
                } else {
                    badge.innerText = 'DESATIVADO';
                    badge.style.background = '#fee2e2';
                    badge.style.color = '#991b1b';
                }
            }
        } else {
            alert('‚ùå Erro ao salvar: ' + (data.erro || 'Tente novamente'));
        }
    } catch (err) {
        console.error('Erro:', err);
        alert('‚ùå Erro de conex√£o');
    }
}

async function testarChaveEscavador() {
    const chave = document.getElementById('escavadorApiKey').value.trim();
    const btn = document.getElementById('btnTestarEscavador');
    const resultado = document.getElementById('resultadoTesteEscavador');
    
    if (!chave) {
        alert('‚ö†Ô∏è Digite uma chave API primeiro');
        return;
    }

    btn.disabled = true;
    btn.innerText = 'üîÑ Testando...';
    resultado.style.display = 'none';

    try {
        const res = await fetch('https://api.escavador.com/api/v1/usuario', {
            headers: {
                'Authorization': `Bearer ${chave}`
            }
        });

        const data = await res.json();

        if (res.ok && data.id) {
            resultado.innerHTML = `
                <div style="background: #d1fae5; border: 1px solid #86efac; border-radius: 8px; padding: 16px;">
                    <strong style="color: #065f46; display: block; margin-bottom: 8px;">‚úÖ Conex√£o estabelecida com sucesso!</strong>
                    <div style="font-size: 13px; color: #047857;">
                        <strong>Conta:</strong> ${data.nome || 'Sem nome'}<br>
                        <strong>E-mail:</strong> ${data.email || '‚Äî'}<br>
                        <strong>Plano:</strong> ${data.dados_assinatura?.plano?.nome || 'Gratuito'}
                    </div>
                </div>
            `;
        } else {
            resultado.innerHTML = `
                <div style="background: #fee2e2; border: 1px solid #fca5a5; border-radius: 8px; padding: 16px;">
                    <strong style="color: #991b1b; display: block; margin-bottom: 8px;">‚ùå Chave inv√°lida ou sem permiss√£o</strong>
                    <p style="font-size: 12px; color: #b91c1c; margin: 0;">
                        Verifique se a chave foi copiada corretamente e se possui as permiss√µes necess√°rias.
                    </p>
                </div>
            `;
        }

        resultado.style.display = 'block';

    } catch (err) {
        console.error('Erro ao testar:', err);
        resultado.innerHTML = `
            <div style="background: #fee2e2; border: 1px solid #fca5a5; border-radius: 8px; padding: 16px;">
                <strong style="color: #991b1b;">‚ùå Erro de conex√£o</strong>
            </div>
        `;
        resultado.style.display = 'block';
    } finally {
        btn.disabled = false;
        btn.innerText = 'üîç Testar Conex√£o';
    }
}

// üöÄ INICIALIZAR √çCONES LUCIDE
if (window.lucide) {
    lucide.createIcons();
}

// Garantir que os √≠cones sejam renderizados ap√≥s o carregamento
window.addEventListener('DOMContentLoaded', () => {
    if (window.lucide) {
        lucide.createIcons();
    }
});

    // ‚úÖ Fun√ß√£o de modal de upgrade (para limites de usu√°rios)
    function exibirAvisoUpgrade(mensagem) {
        const overlay = document.createElement('div');
        overlay.id = "overlay-upgrade";
        overlay.style = "position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:20000; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(5px);";
        overlay.innerHTML = `
        <div style="background:#fff; padding:40px; border-radius:20px; text-align:center; max-width:400px;">
            <div style="font-size:50px;">üöÄ</div>
            <h3 style="margin-top:15px; color:#0f172a;">Limite de Usu√°rios</h3>
            <p style="color:#64748b; margin:15px 0 25px 0; line-height:1.6;">${mensagem}</p>
            <div style="background:#fffbeb; border:1px solid #fde68a; border-radius:12px; padding:15px; margin-bottom:25px; text-align:left;">
                <p style="margin:0; font-size:13px; color:#92400e; line-height:1.6;">
                    <strong>üéØ Plano Intermedi√°rio inclui:</strong><br>
                    ‚Ä¢ At√© 15 usu√°rios simult√¢neos<br>
                    ‚Ä¢ Todos os recursos do B√°sico<br>
                    ‚Ä¢ Financeiro Jur√≠dico completo<br>
                    ‚Ä¢ Suporte priorit√°rio
                </p>
            </div>
            <button onclick="window.location.href='/planos-page'" style="background:linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color:#000; border:none; padding:14px 28px; border-radius:10px; font-weight:800; cursor:pointer; width:100%; margin-bottom:10px;">
                Ver Planos e Pre√ßos
            </button>
            <button onclick="document.getElementById('overlay-upgrade').remove()" style="background:none; border:none; color:#64748b; cursor:pointer; font-weight:600; padding:8px;">
                Depois
            </button>
        </div>`;
        document.body.appendChild(overlay);
    }
    </script>
</body>
</html>