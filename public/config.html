<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LawTech Pro ‚Äî Configura√ß√µes</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/lucide-static@0.451.0/font/lucide.css" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root { 
            --bg: #f8fafc; 
            --sidebar: #0f172a; 
            --sidebar-hover: rgba(255, 255, 255, 0.1);
            --text-menu: #cbd5e1;
            --primary: #2563eb; 
            --white: #ffffff; 
            --border: #e2e8f0; 
            --text-main: #1e293b; 
            --muted: #64748b; 
            --radius: 12px; 
        }

        * { box-sizing: border-box; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--text-main); line-height: 1.5; }

        /* Sidebar Padronizada */
        .sidebar { 
            width: 250px; background: var(--sidebar); color: #fff; padding: 24px 20px; 
            display: flex; flex-direction: column; height: 100vh; position: fixed; 
            left: 0; top: 0; z-index: 1000; 
        }
        .sidebar-header { text-align: center; margin-bottom: 32px; }
        .sidebar-header img { width: 100%; max-width: 160px; height: auto; }

        .menu { display: flex; flex-direction: column; gap: 4px; flex-grow: 1; }
        .menu a { 
            display: flex; align-items: center; padding: 12px; 
            color: var(--text-menu); text-decoration: none; 
            border-radius: 8px; font-size: 14px; transition: 0.2s;
        }
        .menu a i { margin-right: 12px; font-size: 18px; }
        .menu a:hover, .menu a.active { background: var(--sidebar-hover); color: #fff; }
        .menu a.active { background: var(--primary); font-weight: 500; color: #fff; }

        .sidebar-footer {
            padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 11px; color: #94a3b8; margin-top: auto;
        }

        /* √Årea Principal Alinhada */
        .main { margin-left: 250px; min-height: 100vh; display: flex; flex-direction: column; }
        
        .header { 
            background: var(--white); height: 72px; padding: 0 32px; 
            display: flex; align-items: center; justify-content: space-between; 
            border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 900; 
        }

        .content { 
            padding: 40px; 
            max-width: 900px; /* Largura ideal para formul√°rios */
            margin: 0 auto;  /* Centraliza na tela */
            width: 100%; 
        }
        /* Cards Estilo Dashboard */
        .card { 
            background: var(--white); padding: 28px; border-radius: var(--radius); 
            border: 1px solid var(--border); margin-bottom: 24px; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); 
        }
        .card-title { 
            font-size: 16px; font-weight: 700; color: var(--text-main); 
            margin-bottom: 20px; display: flex; align-items: center; gap: 10px; 
        }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        label { 
            display: block; font-size: 11px; font-weight: 700; 
            color: var(--muted); margin-bottom: 8px; text-transform: uppercase; 
            letter-spacing: 0.5px;
        }
        
        input, select { 
            width: 100%; padding: 12px 16px; border: 1px solid var(--border); 
            border-radius: 8px; font-size: 14px; outline: none; background: #fff; 
            transition: border-color 0.2s;
        }
        input:focus { border-color: var(--primary); }
        input[readonly] { background: #f1f5f9; color: var(--muted); }
        
        .radio-group { display: flex; gap: 20px; margin-bottom: 15px; }
        .radio-option { display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 500; cursor: pointer; }

        .btn-save { 
            padding: 14px 24px; background: var(--primary); color: white; 
            border: none; border-radius: 8px; font-size: 14px; font-weight: 600; 
            cursor: pointer; transition: 0.2s; width: 100%; 
        }
        .btn-save:hover { background: #1d4ed8; transform: translateY(-1px); }

        .btn-pdf { 
            padding: 12px 20px; background: #10b981; color: white; 
            border: none; border-radius: 8px; font-size: 13px; font-weight: 600; 
            cursor: pointer; transition: 0.2s; margin-top: 10px; width: 100%;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-pdf:hover { background: #059669; }
        
        .status-badge { 
            font-size: 12px; margin-top: 10px; display: block; 
            font-weight: 600; color: var(--muted); text-align: center;
        }

        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="sidebar-header">
            <img src="Logo LawTech Pro_transparente.png" alt="LawTech Pro">
        </div>
        <nav class="menu">
            <a href="/dashboard"><i class="lucide lucide-layout-dashboard"></i> Dashboard</a>
            <a href="/clientes-page"><i class="lucide lucide-users"></i> Clientes</a>
            <a href="/prazos-page"><i class="lucide lucide-clock"></i> Prazos</a>
            <a href="/processos-page"><i class="lucide lucide-folder"></i> Processos</a>
            <a href="/audiencias-page"><i class="lucide lucide-calendar-days"></i> Audi√™ncias</a>
            <a href="/calculos-page"><i class="lucide lucide-calculator"></i> C√°lculos Jur√≠dicos</a>
            <a href="/financeiro-page"><i class="lucide lucide-credit-card"></i> Financeiro</a>
            <a href="/publicacoes-page"><i class="lucide lucide-clock"></i> Publica√ß√µes DJEN</a>
            <a href="/ia-page" style="display: flex; align-items: center; gap: 10px;">
                <i class="lucide lucide-sparkles" style="color: #fbbf24;"></i> IA Jur√≠dica 
                <span style="font-size: 9px; background: #fbbf24; color: #000; padding: 2px 5px; border-radius: 4px; font-weight: bold; margin-left: auto;">PREMIUM</span>
            </a>
            <a href="/planos-page"><i class="lucide lucide-award"></i> Gest√£o de Planos</a>
            <a href="/config-page" class="active"><i class="lucide lucide-settings"></i> Configura√ß√µes</a>
        </nav>

        <div class="sidebar-footer">
            <div style="margin-bottom: 6px;">
                <span style="color:#64748b">Usu√°rio:</span> <span id="userEmailFooter" style="color:#fff">...</span>
            </div>
            <div>
                <span style="color:#64748b">Plano:</span> <span id="planNameFooter" style="color:#fff">...</span>
            </div>
        </div>
    </aside>

    <div class="main">
        <header class="header">
    <h2 style="font-size: 18px; font-weight: 600;">‚öôÔ∏è Configura√ß√µes</h2>
    
    <div style="position: relative; display: flex; align-items: center; gap: 15px;">
        <span id="userNameHeader" style="font-size: 14px; font-weight: 500; color: var(--muted);">Advogado</span>
        <div onclick="toggleUserMenu()" style="width: 40px; height: 40px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; border: 2px solid #e2e8f0;">
            FL </div>
        
        <div id="userDropdown" style="display: none; position: absolute; top: 50px; right: 0; background: white; border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); width: 200px; z-index: 1000;">
            <a href="/config-page" style="display: block; padding: 12px 16px; color: var(--text-main); text-decoration: none; font-size: 14px; border-bottom: 1px solid var(--border);">üë§ Meus Dados</a>
            <a href="#" onclick="logout()" style="display: block; padding: 12px 16px; color: #ef4444; text-decoration: none; font-size: 14px;">üö™ Sair</a>
        </div>
    </div>
</header>

        <div class="content">
    <div class="card">
        <div class="card-title"><i class="lucide lucide-user"></i> Acesso Pessoal</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group">
                <label>Seu Nome Completo</label>
                <input type="text" id="perfilNome" placeholder="Seu Nome">
            </div>
            <div class="form-group">
                <label>E-mail de Login</label>
                <input type="email" id="perfilEmail" readonly>
            </div>
        </div>
        <button class="btn-save" style="margin-top:15px; width: auto; padding: 10px 30px;" onclick="salvarPerfil()">Atualizar Nome</button>
    </div>

   <div class="card">
    <div class="card-title"><i class="lucide lucide-building-2"></i> Dados do Escrit√≥rio e Faturamento</div>
    
    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
        <div class="form-group">
            <label>Advogado Respons√°vel <span style="color:red">*</span></label>
            <input type="text" id="confAdvogadoResponsavel">
        </div>
        <div class="form-group">
            <label>OAB Principal <span style="color:red">*</span></label>
            <input type="text" id="confOab" oninput="aplicarMascaraOAB(this)">
        </div>
        <div class="form-group">
            <label>Renda Mensal (R$) <span style="color:red">*</span></label>
            <input type="text" id="confRendaMensal" oninput="mascaraMoeda(this)">
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 2fr 1.2fr 0.8fr; gap: 15px; margin-bottom: 15px;">
        <div class="form-group">
            <label>Nome / Raz√£o Social <span style="color:red">*</span></label>
            <input type="text" id="confEscritorio">
        </div>
        <div class="form-group">
            <label>Documento <span style="color:red">*</span></label>
            <input type="text" id="confDocumento" oninput="aplicarMascaraDoc(this)">
        </div>
        <div class="form-group" id="groupDataNascimento">
            <label>Nascimento <span style="color:red">*</span></label>
            <input type="date" id="confDataNascimento">
        </div>
    </div>

    <div class="form-group" style="margin-bottom: 15px;">
        <label>Tipo de Documento <span style="color:red">*</span></label>
        <div class="radio-group" style="display: flex; gap: 20px;">
            <label><input type="radio" name="tipoDoc" value="CPF" checked onclick="ajustarMascaraDoc()"> CPF</label>
            <label><input type="radio" name="tipoDoc" value="CNPJ" onclick="ajustarMascaraDoc()"> CNPJ</label>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 15px; margin-bottom: 15px;">
        <div class="form-group">
            <label>CEP <span style="color:red">*</span></label>
            <input type="text" id="confCep" oninput="mascaraCEP(this)" onblur="buscarCep()">
        </div>
        <div class="form-group">
            <label>Cidade <span style="color:red">*</span></label>
            <input type="text" id="confCidade">
        </div>
        <div class="form-group">
            <label>UF <span style="color:red">*</span></label>
            <input type="text" id="confEstado" maxlength="2">
        </div>
    </div>

    <div class="form-group">
        <label>Endere√ßo Completo <span style="color:red">*</span></label>
        <input type="text" id="confEndereco">
    </div>

    <div style="display: flex; gap: 15px; margin-top: 25px;">
        <button class="btn-save" onclick="salvarDadosJuridicos()">Salvar Dados Escrit√≥rio</button>
        <button class="btn-pdf" onclick="gerarRelatorioPDF()">Comprovante Premium</button>
    </div>
</div>

    <div class="card">
        <div class="card-title"><i class="lucide lucide-banknote"></i> Faturamento Asaas</div>
        <div style="display: grid; grid-template-columns: 2fr 1fr 1.5fr 0.5fr; gap: 12px; margin-bottom: 15px;">
            <div class="form-group"><label>Banco <span style="color:red">*</span></label><select id="confBanco"></select></div>
            <div class="form-group"><label>Ag√™ncia <span style="color:red">*</span></label><input type="text" id="confAgencia"></div>
            <div class="form-group"><label>Conta <span style="color:red">*</span></label><input type="text" id="confConta"></div>
            <div class="form-group"><label>D√≠gito <span style="color:red">*</span></label><input type="text" id="confContaDigito"></div>
        </div>
        <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 15px; align-items: end;">
            <div class="form-group">
                <label>Chave PIX de Repasse</label>
                <input type="text" id="confPixChave" placeholder="E-mail, CPF ou Aleat√≥ria">
            </div>
            <button class="btn-save" style="background:#16a34a;" onclick="ativarFinanceiro()">üöÄ Ativar Faturamento</button>
        </div>
        <span class="status-badge" id="statusFinanceiroBadge">Status: Verifique seus dados antes de ativar.</span>
    </div>

    <div class="card">
        <div class="card-title"><i class="lucide lucide-users"></i> Gest√£o de Equipe</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px; margin-bottom: 15px;">
            <div class="form-group"><label>Nome</label><input type="text" id="eqNome" autocomplete="off"></div>
            <div class="form-group"><label>E-mail</label><input type="email" id="eqEmail" autocomplete="off"></div>
            <div class="form-group"><label>Senha</label><input type="password" id="eqSenha" autocomplete="new-password"></div>
            <div class="form-group">
                <label>Permiss√£o</label>
                <select id="eqRole">
                    <option value="operador">Operador</option>
                    <option value="visualizador">Leitura</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
        </div>
        <button class="btn-save" style="background:var(--primary); width: auto; padding: 10px 30px;" onclick="salvarMembro()">Adicionar √† Equipe</button>
        <div id="listaEquipe" style="margin-top: 15px; border-top: 1px solid var(--border);"></div> 
    </div>

    <div class="card">
        <div class="card-title"><i class="lucide lucide-lock"></i> Alterar Minha Senha</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group"><label>Nova Senha</label><input type="password" id="novaSenha"></div>
            <div class="form-group"><label>Confirmar</label><input type="password" id="confirmaSenha"></div>
        </div>
        <button class="btn-save" style="background:#64748b; margin-top:15px; width: auto; padding: 10px 30px;" onclick="alterarSenha()">Alterar Senha</button>
    </div>
</div>

    <script>
        const token = localStorage.getItem('token');
    if (!token) window.location.href = '/login.html';

    // ... (suas fun√ß√µes de m√°scara permanecem as mesmas) ...

async function carregarInfoRodape() {
    try {
        // 1. GARANTE O NOME E AS INICIAIS (Primeira prioridade)
        const resUser = await fetch('/api/auth/me', { headers: { Authorization: `Bearer ${token}` } });
        const dataUser = await resUser.json();
        
        if (dataUser.ok && dataUser.usuario) {
            const nomeReal = dataUser.usuario.nome || 'Advogado';
            
            // Atualiza os textos
            document.getElementById('userNameHeader').innerText = nomeReal;
            document.getElementById('userEmailFooter').innerText = dataUser.usuario.email;
            if(document.getElementById('perfilEmail')) document.getElementById('perfilEmail').value = dataUser.usuario.email;
            if(document.getElementById('perfilNome')) document.getElementById('perfilNome').value = nomeReal;

            // FIXA AS INICIAIS "FL" (Isso para o pisca-pisca da letra A)
            const iniciais = nomeReal.split(' ').filter(n => n).map(n => n[0]).join('').toUpperCase().slice(0, 2);
            const circuloPerfil = document.querySelector('[onclick="toggleUserMenu()"]');
            if (circuloPerfil) circuloPerfil.innerText = iniciais || 'AD';
        }

        // 2. CARREGA O PLANO
        const resPlan = await fetch('/api/plano-consumo', { headers: { Authorization: `Bearer ${token}` } });
        const dataPlan = await resPlan.json();
        if(document.getElementById('planNameFooter')) document.getElementById('planNameFooter').innerText = dataPlan.plano || 'Individual';

        // 3. BUSCA DADOS DO ESCRIT√ìRIO (Com prote√ß√£o contra erros)
        const resEsc = await fetch('/api/config/meu-escritorio', { 
    headers: { Authorization: `Bearer ${token}` } 
});
        const dataEsc = await resEsc.json();
        
        if(dataEsc.ok && dataEsc.dados) {
            const d = dataEsc.dados;
            
            // Lista de IDs que DEVEM existir no seu HTML
            const campos = {
                'confAdvogadoResponsavel': d.advogado_responsavel,
                'confEscritorio': d.nome,
                'confOab': d.oab,
                'confEmailFaturamento': d.email,
                'confDocumento': d.documento,
                'confCep': d.cep,
                'confCidade': d.cidade,
                'confEstado': d.estado,
                'confEndereco': d.endereco
            };

            // Preenchimento Seguro: S√≥ preenche se o campo existir na p√°gina
            for (const [id, valor] of Object.entries(campos)) {
                const elemento = document.getElementById(id);
                if (elemento) {
                    elemento.value = valor || '';
                }
            }
        }
    } catch (err) { 
        console.warn("Aviso: Alguns campos n√£o foram encontrados na tela, mas o perfil foi carregado."); 
    }
}

        // --- RESTANTE DAS SUAS FUN√á√ïES ORIGINAIS ---
        function mascaraCEP(i) {
            let v = i.value.replace(/\D/g, ''); 
            if (v.length > 5) i.value = v.slice(0, 2) + '.' + v.slice(2, 5) + '-' + v.slice(5, 8);
            else if (v.length > 2) i.value = v.slice(0, 2) + '.' + v.slice(2);
        }

        async function buscarCep() {
            const inputCep = document.getElementById('confCep');
            const cepRaw = inputCep.value.replace(/\D/g, '');
            if (cepRaw.length !== 8) return;
            try {
                const res = await fetch(`https://viacep.com.br/ws/${cepRaw}/json/`);
                const data = await res.json();
                if (!data.erro) {
                    document.getElementById('confEndereco').value = `${data.logradouro}, ${data.bairro}`;
                    document.getElementById('confCidade').value = data.localidade;
                    document.getElementById('confEstado').value = data.uf;
                }
            } catch (err) { console.error("Erro Viacep:", err); }
        }

        function mascaraMoeda(i) {
            let v = i.value.replace(/\D/g,'');
            v = (v/100).toFixed(2) + '';
            v = v.replace(".", ",");
            v = v.replace(/(\d)(\d{3})(\d{3}),/g, "$1.$2.$3,");
            v = v.replace(/(\d)(\d{3}),/g, "$1.$2,");
            i.value = 'R$ ' + v;
        }

        function ajustarMascaraDoc() {
        const inputDoc = document.getElementById('confDocumento');
        const groupData = document.getElementById('groupDataNascimento');
        const radioCpf = document.querySelector('input[name="tipoDoc"]:checked');

        // Se o campo de documento n√£o existir na tela, a fun√ß√£o para aqui sem dar erro
        if (!inputDoc) return;

        inputDoc.value = '';
    
        // Se o radio button existir, pegamos o valor dele. Se n√£o, assumimos CPF como padr√£o.
        const tipo = radioCpf ? radioCpf.value : 'CPF';

        if (tipo === 'CPF') {
        inputDoc.placeholder = '000.000.000-00';
        if (groupData) groupData.style.display = 'block';
        } else {
        inputDoc.placeholder = '00.000.000/0000-00';
        if (groupData) groupData.style.display = 'none';
        }
        }

        function aplicarMascaraDoc(i) {
        if (!i) return;
        const radioCpf = document.querySelector('input[name="tipoDoc"]:checked');
        const tipo = radioCpf ? radioCpf.value : 'CPF';
    
        let v = i.value.replace(/\D/g, '');
        if (tipo === 'CPF') {
        i.value = v.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4").slice(0, 14);
        } else {
        i.value = v.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, "$1.$2.$3/$4-$5").slice(0, 18);
        }
        }

        function aplicarMascaraOAB(i) {
            let v = i.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            if (v.length > 6) i.value = v.slice(0, 3) + '.' + v.slice(3, 6) + '/' + v.slice(6, 8);
            else if (v.length > 3) i.value = v.slice(0, 3) + '.' + v.slice(3);
            else i.value = v;
        }

        async function carregarBancos() {
            try {
                const res = await fetch('https://brasilapi.com.br/api/banks/v1');
                const bancos = await res.json();
                const select = document.getElementById('confBanco');
                select.innerHTML = '<option value="">Selecione o Banco</option>';
                bancos.sort((a,b) => a.fullName > b.fullName ? 1 : -1).forEach(b => {
                    if(b.code) select.innerHTML += `<option value="${b.code}">${b.code} - ${b.fullName}</option>`;
                });
            } catch (e) { document.getElementById('confBanco').innerHTML = '<option value="">Erro ao carregar bancos</option>'; }
        }

  async function carregarInfoRodape() {
    try {
        // 1. DADOS DE ACESSO (NOME E INICIAIS)
        const resUser = await fetch('/api/auth/me', { headers: { Authorization: `Bearer ${token}` } });
        const dataUser = await resUser.json();
        
        if (dataUser.ok) {
            const nomeReal = dataUser.usuario.nome || 'Advogado';
            document.getElementById('userNameHeader').innerText = nomeReal;
            document.getElementById('userEmailFooter').innerText = dataUser.usuario.email;
            document.getElementById('perfilEmail').value = dataUser.usuario.email;
            document.getElementById('perfilNome').value = dataUser.usuario.nome || '';

            // RESOLVE O PROBLEMA DA LETRA "A": Gera as iniciais corretamente
            const iniciais = nomeReal.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
            const circuloPerfil = document.querySelector('[onclick="toggleUserMenu()"]');
            if (circuloPerfil) circuloPerfil.innerText = iniciais;
        }

        // 2. DADOS DO PLANO
        const resPlan = await fetch('/api/plano-consumo', { headers: { Authorization: `Bearer ${token}` } });
        const dataPlan = await resPlan.json();
        document.getElementById('planNameFooter').innerText = dataPlan.plano || 'Individual';

        // 3. DADOS DO ESCRIT√ìRIO (PREENCHIMENTO AUTOM√ÅTICO)
        const resEsc = await fetch('/api/config/meu-escritorio', { headers: { Authorization: `Bearer ${token}` } });
        const dataEsc = await resEsc.json();
        
        if(dataEsc.ok && dataEsc.dados) {
            const d = dataEsc.dados;
            // Mapeamento seguro de campos para evitar que o script "pisque" e pare
            const camposParaPreencher = {
                'confAdvogadoResponsavel': d.advogado_responsavel,
                'confEscritorio': d.nome,
                'confOab': d.oab,
                'confEmailFaturamento': d.email,
                'confDocumento': d.documento,
                'confDataNascimento': d.data_nascimento ? d.data_nascimento.split('T')[0] : '',
                'confCep': d.cep,
                'confCidade': d.cidade,
                'confEstado': d.estado,
                'confEndereco': d.endereco,
                'confAgencia': d.agencia,
                'confConta': d.conta,
                'confContaDigito': d.conta_digito,
                'confPixChave': d.pix_chave,
                'confBanco': d.banco_codigo
            };

            // Preenche apenas o que existir, sem dar erro
            Object.keys(camposParaPreencher).forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = camposParaPreencher[id] || '';
            });

            // Formata a Renda se ela existir
            if(d.renda_mensal && document.getElementById('confRendaMensal')) {
                document.getElementById('confRendaMensal').value = 'R$ ' + parseFloat(d.renda_mensal).toLocaleString('pt-BR', {minimumFractionDigits: 2});
            }
        }
    } catch (err) { 
        console.error("Aviso: Alguns dados ainda n√£o foram preenchidos no perfil."); 
    }
}

        async function salvarPerfil() {
            const nome = document.getElementById('perfilNome').value;
            const res = await fetch('/api/config/perfil', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ nome })
            });
            if (res.ok) { alert("‚úÖ Perfil atualizado!"); carregarInfoRodape(); }
            else { alert("‚ùå Erro ao atualizar perfil."); }
        }

        async function salvarDadosJuridicos() {
            const rendaCrua = document.getElementById('confRendaMensal').value;
            const rendaTratada = rendaCrua.replace(/[R$\s.]/g, '').replace(',', '.');
            const dados = {
                advogado_responsavel: document.getElementById('confAdvogadoResponsavel').value,
                nome: document.getElementById('confEscritorio').value,
                oab: document.getElementById('confOab').value,
                documento: document.getElementById('confDocumento').value,
                dataNascimento: document.getElementById('confDataNascimento').value,
                email: document.getElementById('confEmailFaturamento').value,
                endereco: document.getElementById('confEndereco').value,
                cidade: document.getElementById('confCidade').value,
                estado: document.getElementById('confEstado').value.toUpperCase(),
                cep: document.getElementById('confCep').value.replace(/\D/g, ''),
                banco_codigo: document.getElementById('confBanco').value,
                agencia: document.getElementById('confAgencia').value,
                conta: document.getElementById('confConta').value,
                conta_digito: document.getElementById('confContaDigito').value,
                pix_chave: document.getElementById('confPixChave').value,
                renda_mensal: parseFloat(rendaTratada) || 0
            };
            const res = await fetch('/api/config/escritorio', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(dados)
            });
            if (res.ok) alert("‚úÖ Dados do escrit√≥rio salvos!");
            else alert("‚ùå Erro ao salvar dados.");
        }

        async function ativarFinanceiro() {
            if (!confirm("Confirmar ativa√ß√£o da conta de faturamento com os dados acima?")) return;
            const res = await fetch('/api/financeiro/configurar-subconta', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) alert("‚úÖ Faturamento Profissional Ativado!");
            else alert("‚ùå Erro na ativa√ß√£o. Verifique campos obrigat√≥rios.");
        }

        async function alterarSenha() {
            const s1 = document.getElementById('novaSenha').value;
            const s2 = document.getElementById('confirmaSenha').value;
            if (!s1 || s1 !== s2) return alert("Senhas n√£o conferem!");
            const res = await fetch('/api/config/senha', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ senha: s1 })
            });
            if (res.ok) { alert("‚úÖ Senha alterada!"); }
            else { alert("‚ùå Erro ao alterar senha."); }
        }

        // Fun√ß√£o para carregar a equipe
    async function carregarEquipe() {
    const tokenEquipe = localStorage.getItem('token');
    const res = await fetch('/api/auth/equipe', { 
        headers: { 'Authorization': `Bearer ${tokenEquipe}` } 
    });
    const membros = await res.json();
    const listaDiv = document.getElementById('listaEquipe'); // Alinhado com seu layout atual
    listaDiv.innerHTML = '';

    membros.forEach(m => {
        listaDiv.innerHTML += `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #f1f5f9;">
                <div>
                    <div style="font-weight:600; font-size:14px; color: var(--text-main);">${m.nome}</div>
                    <div style="font-size:12px; color:var(--muted);">${m.email}</div>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="background:#e0e7ff; color:#4338ca; padding:4px 8px; border-radius:6px; font-size:10px; font-weight:700; text-transform: uppercase;">
                        ${m.role}
                    </span>
                    <button onclick="excluirMembro(${m.id})" style="background:none; border:none; color:#ef4444; cursor:pointer; padding:5px; display: flex; align-items: center;">
                        <i class="lucide lucide-trash-2" style="width:18px;"></i>
                    </button>
                </div>
            </div>
        `;
    });
    if (typeof lucide !== 'undefined') lucide.createIcons();
}

async function excluirMembro(id) {
    if(!confirm('Deseja remover este acesso imediatamente? O funcion√°rio ser√° deslogado e n√£o poder√° mais entrar.')) return;

    const tokenExclusao = localStorage.getItem('token');
    const res = await fetch(`/api/auth/equipe/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${tokenExclusao}` }
    });

    if(res.ok) {
        alert('Acesso revogado com sucesso.');
        carregarEquipe(); // Atualiza a lista na hora
    }
}

async function salvarMembro() {
    // 1. For√ßamos a leitura do token direto do armazenamento do Chrome
    const tokenSeguro = localStorage.getItem('token');
    
    // TESTE DE DIAGN√ìSTICO: Isso vai imprimir no seu console se o token existe ou n√£o
    console.log("DEBUG - Token encontrado:", tokenSeguro ? "SIM (Preenchido)" : "N√ÉO (Vazio)");

    if (!tokenSeguro) {
        alert("‚ùå Erro local: Seu login expirou. Por favor, saia do sistema e entre novamente.");
        return;
    }

    const nome = document.getElementById('eqNome').value;
    const email = document.getElementById('eqEmail').value;
    const senha = document.getElementById('eqSenha').value;
    const role = document.getElementById('eqRole').value;

    if (!nome || !email || !senha) {
        alert("‚ö†Ô∏è Por favor, preencha Nome, E-mail e Senha.");
        return;
    }

    try {
        const res = await fetch('/api/auth/convidar-funcionario', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json', 
                'Authorization': `Bearer ${tokenSeguro}` // Usando a vari√°vel local segura
            },
            body: JSON.stringify({ nome, email, senha, role })
        });

        if (res.ok) {
            alert('‚úÖ Funcion√°rio adicionado com sucesso!');
            document.getElementById('eqNome').value = '';
            document.getElementById('eqEmail').value = '';
            document.getElementById('eqSenha').value = '';
            carregarEquipe(); 
        } else {
            const erroData = await res.json();
            // Se o erro for 403, o servidor vai dizer o motivo real aqui
            alert('‚ùå Erro do Servidor: ' + (erroData.erro || 'Acesso negado (403)'));
        }
    } catch (err) {
        alert('‚ùå Erro cr√≠tico de conex√£o.');
    }
}

    async function excluirMembro(id) {
        if(!confirm('Deseja remover este acesso imediatamente? O funcion√°rio ser√° deslogado e n√£o poder√° mais entrar.')) return;

        const res = await fetch(`/api/auth/equipe/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if(res.ok) {
            carregarEquipe();
        }
    }

        function logout() { localStorage.removeItem('token'); window.location.href = '/login.html'; }

        window.onload = () => {
            carregarBancos();
            carregarInfoRodape();
            ajustarMascaraDoc();
            carregarEquipe();
        };

        function toggleUserMenu() {
        const menu = document.getElementById('userDropdown');
        menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }

        // Fecha o menu se clicar fora dele
        window.onclick = function(event) {
        if (!event.target.matches('[onclick="toggleUserMenu()"]') && !event.target.closest('#userDropdown')) {
        document.getElementById('userDropdown').style.display = 'none';
        }
        }
    </script>
</body>
</html>