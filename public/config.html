<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LawTech Pro ‚Äî Configura√ß√µes</title>
    <link rel="icon" type="image/png" href="favicon.png">
    
    <!-- Cole aqui o bloco de fontes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/lucide@0.451.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root { 
            --bg: #f8fafc; 
            --sidebar: #0f172a; 
            --sidebar-hover: rgba(255, 255, 255, 0.1);
            --text-menu: #cbd5e1;
            --primary: #2563eb; 
            --white: #ffffff; 
            --border: #e2e8f0; 
            --text-main: #1e293b; 
            --muted: #64748b; 
            --radius: 12px; 
        }

        * { box-sizing: border-box; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--text-main); line-height: 1.5; }

        /* Sidebar Padronizada */
        .sidebar { 
            width: 250px; background: var(--sidebar); color: #fff; padding: 24px 20px; 
            display: flex; flex-direction: column; height: 100vh; position: fixed; 
            left: 0; top: 0; z-index: 1000; 
        }
        .sidebar-header { text-align: center; margin-bottom: 32px; }
        .sidebar-header img { width: 100%; max-width: 160px; height: auto; }

        .menu { display: flex; flex-direction: column; gap: 4px; flex-grow: 1; }
        .menu a { 
            display: flex; align-items: center; padding: 12px; 
            color: var(--text-menu); text-decoration: none; 
            border-radius: 8px; font-size: 14px; transition: 0.2s;
        }
        .menu a i { margin-right: 12px; font-size: 18px; }
        .menu a:hover, .menu a.active { background: var(--sidebar-hover); color: #fff; }
        .menu a.active { background: var(--primary); font-weight: 500; color: #fff; }

        .sidebar-footer {
            padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 11px; color: #94a3b8; margin-top: auto;
        }

        /* √Årea Principal Alinhada */
        .main { margin-left: 250px; min-height: 100vh; display: flex; flex-direction: column; }
        
        .header { 
            background: var(--white); height: 72px; padding: 0 32px; 
            display: flex; align-items: center; justify-content: space-between; 
            border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 900; 
        }

        .content { 
            padding: 40px; 
            max-width: 900px; /* Largura ideal para formul√°rios */
            margin: 0 auto;  /* Centraliza na tela */
            width: 100%; 
        }
        /* Cards Estilo Dashboard */
        .card { 
            background: var(--white); padding: 28px; border-radius: var(--radius); 
            border: 1px solid var(--border); margin-bottom: 24px; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); 
        }
        .card-title { 
            font-size: 16px; font-weight: 700; color: var(--text-main); 
            margin-bottom: 20px; display: flex; align-items: center; gap: 10px; 
        }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        label { 
            display: block; font-size: 11px; font-weight: 700; 
            color: var(--muted); margin-bottom: 8px; text-transform: uppercase; 
            letter-spacing: 0.5px;
        }
        
        input, select { 
            width: 100%; padding: 12px 16px; border: 1px solid var(--border); 
            border-radius: 8px; font-size: 14px; outline: none; background: #fff; 
            transition: border-color 0.2s;
        }
        input:focus { border-color: var(--primary); }
        input[readonly] { background: #f1f5f9; color: var(--muted); }
        
        .radio-group { display: flex; gap: 20px; margin-bottom: 15px; }
        .radio-option { display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 500; cursor: pointer; }

        .btn-save { 
            padding: 14px 24px; background: var(--primary); color: white; 
            border: none; border-radius: 8px; font-size: 14px; font-weight: 600; 
            cursor: pointer; transition: 0.2s; width: 100%; 
        }
        .btn-save:hover { background: #1d4ed8; transform: translateY(-1px); }

        .btn-pdf { 
            padding: 12px 20px; background: #10b981; color: white; 
            border: none; border-radius: 8px; font-size: 13px; font-weight: 600; 
            cursor: pointer; transition: 0.2s; margin-top: 10px; width: 100%;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-pdf:hover { background: #059669; }
        
        .status-badge { 
            font-size: 12px; margin-top: 10px; display: block; 
            font-weight: 600; color: var(--muted); text-align: center;
        }

        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
        }

        .btn-crm-gold-nav {
    background: #fbbf24 !important; /* Cor Gold */
    color: #000 !important;
    font-weight: 800 !important;
    margin-top: 15px !important;
    display: flex !important;
    align-items: center;
    justify-content: center;
    padding: 12px !important;
    border-radius: 8px;
    text-decoration: none;
    font-size: 14px;
    transition: 0.3s;
}
.btn-crm-gold-nav:hover { 
    background: #facc15 !important; 
    transform: scale(1.02); 
}
.btn-crm-gold-nav i { margin-right: 10px; }

.finance-actions {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-top: 20px;
}

.btn-secondary {
  background: #e2e8f0;
  color: #1e293b;
  font-weight: 600;
}

.btn-secondary:hover {
  background: #cbd5f5;
}

.btn-primary {
  background: #2563eb;
  font-weight: 700;
}

.divider {
  height: 1px;
  background: #e5e7eb;
  margin: 8px 0;
}

.status-badge.warning {
  font-size: 11px;
  color: #92400e;
  background: #fef3c7;
  padding: 8px;
  border-radius: 6px;
  text-align: center;
}
    </style>
</head>
<body>
        <aside class="sidebar">
        <div class="sidebar-header">
            <img src="Logo LawTech Pro_transparente.png" alt="LawTech Pro">
        </div>
        <nav class="menu">
            <a href="/dashboard"><i class="lucide lucide-layout-dashboard"></i> Dashboard</a>
            <a href="/clientes-page"><i class="lucide lucide-users"></i> Clientes</a>
            <a href="/prazos-page"><i class="lucide lucide-clock"></i> Prazos</a>
            <a href="/processos-page"><i class="lucide lucide-folder"></i> Processos</a>
            <a href="/audiencias-page"><i class="lucide lucide-calendar-days"></i> Audi√™ncias</a>
            <a href="/calculos-page"><i class="lucide lucide-calculator"></i> C√°lculos Jur√≠dicos</a>
            <a href="/financeiro-page"><i class="lucide lucide-credit-card"></i> Financeiro</a>
            <a href="/publicacoes-page"><i class="lucide lucide-clock"></i> Publica√ß√µes DJEN</a>
            <a href="/ia-page" style="display: flex; align-items: center; gap: 10px;">
                <i class="lucide lucide-sparkles" style="color: #fbbf24;"></i> IA Jur√≠dica 
                <span style="font-size: 9px; background: #fbbf24; color: #000; padding: 2px 5px; border-radius: 4px; font-weight: bold; margin-left: auto;">PREMIUM</span>
            </a>
            <a href="/planos-page"><i class="lucide lucide-award"></i> Gest√£o de Planos</a>
            <a href="/config-page" class="active"><i class="lucide lucide-settings"></i> Configura√ß√µes</a>
            <a href="/crm-page" class="btn-crm-gold-nav">
            <i class="lucide lucide-trending-up"></i> CRM PROSPEC√á√ÉO
            </a>
        </nav>

        <div class="sidebar-footer">
            <div style="margin-bottom: 6px;">
                <span style="color:#64748b">Usu√°rio:</span> <span id="userEmailFooter" style="color:#fff">...</span>
            </div>
            <div>
                <span style="color:#64748b">Plano:</span> <span id="planNameFooter" style="color:#fff">...</span>
            </div>
        </div>
    </aside>

    <div class="main">
        <header class="header">
            <h2 style="font-size: 18px; font-weight: 600;">‚öôÔ∏è Configura√ß√µes</h2>
            <div style="position: relative; display: flex; align-items: center; gap: 15px;">
                <span id="userNameHeader" style="font-size: 14px; font-weight: 500; color: var(--muted);">Advogado</span>
                <div onclick="toggleUserMenu()" id="userCircle" style="width: 40px; height: 40px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; border: 2px solid #e2e8f0;">
                    --
                </div>
                <div id="userDropdown" style="display: none; position: absolute; top: 55px; right: 0; background: white; border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); width: 200px; z-index: 1001;">
                    <a href="/config-page" style="display: block; padding: 12px 16px; color: var(--text-main); text-decoration: none; font-size: 14px; border-bottom: 1px solid var(--border);">üë§ Meus Dados</a>
                    <a href="#" onclick="logout()" style="display: block; padding: 12px 16px; color: var(--danger); text-decoration: none; font-size: 14px;">üö™ Sair</a>
                </div>
            </div>
        </header>
<div class="content">
    <!-- Acesso Pessoal -->
    <div class="card">
        <div class="card-title"><i data-lucide="user"></i> Acesso Pessoal</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group">
                <label>Seu Nome Completo</label>
                <input type="text" id="perfilNome" placeholder="Seu Nome">
            </div>
            <div class="form-group">
                <label>E-mail de Login</label>
                <input type="email" id="perfilEmail" readonly title="O e-mail n√£o pode ser alterado por seguran√ßa.">
            </div>
        </div>
        <button class="btn-save" style="margin-top:15px; width: auto; padding: 10px 30px;" onclick="salvarPerfil()">
            Atualizar Nome
        </button>
    </div>

    <!-- Dados do Escrit√≥rio e Faturamento -->
    <div class="card">
        <div class="card-title"><i data-lucide="building-2"></i> Dados do Escrit√≥rio e Faturamento</div>
        
        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div class="form-group">
                <label>Advogado Respons√°vel <span style="color:red">*</span></label>
                <input type="text" id="confAdvogadoResponsavel">
            </div>
            <div class="form-group">
                <label>OAB Principal <span style="color:red">*</span></label>
                <input type="text" id="confOab" oninput="aplicarMascaraOAB(this)" placeholder="000.000/UF">
            </div>
            <div class="form-group">
                <label>Renda Mensal (R$) <span style="color:red">*</span></label>
                <input type="text" id="confRendaMensal" oninput="mascaraMoeda(this)" placeholder="R$ 0,00">
            </div>
        </div>

        <div class="form-group" style="margin-bottom: 15px;">
            <label>Tipo de Pessoa <span style="color:red">*</span></label>
            <div class="radio-group">
                <label class="radio-option">
                    <input type="radio" name="tipoDoc" value="CPF" checked onclick="ajustarMascaraDoc()"> Pessoa F√≠sica (CPF)
                </label>
                <label class="radio-option">
                    <input type="radio" name="tipoDoc" value="CNPJ" onclick="ajustarMascaraDoc()"> Pessoa Jur√≠dica (CNPJ)
                </label>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 2fr 1.2fr 0.8fr; gap: 15px; margin-bottom: 15px;">
            <div class="form-group">
                <label>Nome / Raz√£o Social <span style="color:red">*</span></label>
                <input type="text" id="confEscritorio">
            </div>
            <div class="form-group">
                <label>Documento (CPF/CNPJ) <span style="color:red">*</span></label>
                <input type="text" id="confDocumento" oninput="aplicarMascaraDoc(this)">
            </div>
            <div class="form-group" id="groupDataNascimento">
                <label>Nascimento <span style="color:red">*</span></label>
                <input type="date" id="confDataNascimento">
            </div>
        </div>
       
        <div style="display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div class="form-group">
                <label>CEP <span style="color:red">*</span></label>
                <input type="text" id="confCep" oninput="mascaraCEP(this)" onblur="buscarCep()" placeholder="00.000-000">
            </div>
            <div class="form-group">
                <label>Cidade <span style="color:red">*</span></label>
                <input type="text" id="confCidade">
            </div>
            <div class="form-group">
                <label>UF <span style="color:red">*</span></label>
                <input type="text" id="confEstado" maxlength="2" placeholder="Ex: BA">
            </div>
        </div>

        <div class="form-group">
            <label>Endere√ßo Completo <span style="color:red">*</span></label>
            <input type="text" id="confEndereco" placeholder="Rua, N√∫mero, Bairro">
        </div>

        <div style="margin-top: 20px; padding: 12px; border-left: 4px solid #2563eb; background: #f1f5f9; border-radius: 6px;">
            <span style="font-size: 12px; color: #475569; font-weight: 600; text-transform: uppercase;">
                ‚úÖ Checklist: Salve todos os dados acima antes de ativar o financeiro.
            </span>
        </div>

        <div style="display: flex; gap: 15px; margin-top: 25px;">
            <button class="btn-save" onclick="salvarDadosJuridicos()">Salvar Dados do Escrit√≥rio</button>
        </div>
    </div>

    <!-- Configura√ß√£o de Repasse (Asaas) -->
    <div class="card" style="border-top: 4px solid var(--success);">
        <div class="card-title">
            <i data-lucide="banknote"></i> Configura√ß√£o de Repasse (Asaas)
        </div>

        <!-- Dados Banc√°rios -->
        <div style="display: grid; grid-template-columns: 2fr 1fr 1.5fr 0.5fr; gap: 12px; margin-bottom: 15px;">
            <div class="form-group">
                <label>Banco <span style="color:red">*</span></label>
                <select id="confBanco">
                    <option value="">Carregando bancos...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Ag√™ncia <span style="color:red">*</span></label>
                <input type="text" id="confAgencia" placeholder="0000">
            </div>
            <div class="form-group">
                <label>Conta <span style="color:red">*</span></label>
                <input type="text" id="confConta" placeholder="00000">
            </div>
            <div class="form-group">
                <label>D√≠gito <span style="color:red">*</span></label>
                <input type="text" id="confContaDigito" placeholder="0">
            </div>
        </div>

        <!-- PIX -->
        <div class="form-group" style="margin-bottom: 20px;">
            <label>Chave PIX para Recebimento</label>
            <input type="text" id="confPixChave" placeholder="E-mail, CPF ou Chave Aleat√≥ria">
        </div>

        <!-- A√ß√µes -->
        <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 20px;">
            <button class="btn-save" onclick="salvarDadosJuridicos()">
                üíæ Salvar Dados Banc√°rios
            </button>

            <button class="btn-save" style="background: #10b981;" onclick="ativarFinanceiro()">
                üöÄ Ativar Faturamento
            </button>

            <span class="status-badge" style="background: #fef3c7; color: #92400e; padding: 8px 12px; border-radius: 6px; font-size: 13px;">
                ‚ö†Ô∏è A conta banc√°ria deve ser vinculada ao CPF/CNPJ informado para liberar a emiss√£o de boletos.
            </span>
        </div>
    </div>

    <!-- Gest√£o de Equipe -->
    <div class="card">
        <div class="card-title">
            <i data-lucide="users"></i> Gest√£o de Equipe
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px; margin-bottom: 15px;">
            <div class="form-group">
                <label>Nome</label>
                <input type="text" id="eqNome" autocomplete="off">
            </div>
            <div class="form-group">
                <label>E-mail</label>
                <input type="email" id="eqEmail" autocomplete="off">
            </div>
            <div class="form-group">
                <label>Senha</label>
                <input type="password" id="eqSenha" autocomplete="new-password">
            </div>
            <div class="form-group">
                <label>Permiss√£o</label>
                <select id="eqRole">
                    <option value="operador">Operador</option>
                    <option value="visualizador">Leitura</option>
                    <option value="admin">Administrador</option>
                </select>
            </div>
        </div>

        <button class="btn-save" style="width: auto; padding: 10px 30px;" onclick="salvarMembro()">
            Adicionar √† Equipe
        </button>

        <div id="listaEquipe" style="margin-top: 20px; border-top: 1px solid var(--border);"></div>
    </div>

    <!-- Alterar Minha Senha -->
    <div class="card">
        <div class="card-title">
            <i data-lucide="lock"></i> Alterar Minha Senha
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group">
                <label>Nova Senha</label>
                <input type="password" id="novaSenha">
            </div>
            <div class="form-group">
                <label>Confirmar Nova Senha</label>
                <input type="password" id="confirmaSenha">
            </div>
        </div>

        <button class="btn-save" style="background: var(--muted); margin-top: 15px; width: auto; padding: 10px 30px;" onclick="alterarSenha()">
            Atualizar Senha
        </button>
    </div>
</div>

<script>
    const token = localStorage.getItem('token');
    let dadosSalvos = false;
    if (!token) window.location.href = '/login.html';

    // 1. M√ÅSCARAS E UTILIT√ÅRIOS
    function mascaraCEP(i) {
        let v = i.value.replace(/\D/g, ''); 
        if (v.length > 5) i.value = v.slice(0, 2) + '.' + v.slice(2, 5) + '-' + v.slice(5, 8);
        else if (v.length > 2) i.value = v.slice(0, 2) + '.' + v.slice(2);
    }

    async function buscarCep() {
        const inputCep = document.getElementById('confCep');
        if (!inputCep) return;
        const cepRaw = inputCep.value.replace(/\D/g, '');
        if (cepRaw.length !== 8) return;
        try {
            const res = await fetch(`https://viacep.com.br/ws/${cepRaw}/json/`);
            const data = await res.json();
            if (!data.erro) {
                if(document.getElementById('confEndereco')) document.getElementById('confEndereco').value = `${data.logradouro}, ${data.bairro}`;
                if(document.getElementById('confCidade')) document.getElementById('confCidade').value = data.localidade;
                if(document.getElementById('confEstado')) document.getElementById('confEstado').value = data.uf;
            }
        } catch (err) { console.error("Erro Viacep:", err); }
    }

    function mascaraMoeda(i) {
        let v = i.value.replace(/\D/g,'');
        v = (v/100).toFixed(2) + '';
        v = v.replace(".", ",");
        v = v.replace(/(\d)(\d{3})(\d{3}),/g, "$1.$2.$3,");
        v = v.replace(/(\d)(\d{3}),/g, "$1.$2,");
        i.value = 'R$ ' + v;
    }

    function ajustarMascaraDoc() {
        const inputDoc = document.getElementById('confDocumento');
        const groupData = document.getElementById('groupDataNascimento');
        const radioCpf = document.querySelector('input[name="tipoDoc"]:checked');
        if (!inputDoc) return;
        
        inputDoc.value = '';
        const tipo = radioCpf ? radioCpf.value : 'CPF';
        if (tipo === 'CPF') {
            inputDoc.placeholder = '000.000.000-00';
            if (groupData) groupData.style.display = 'block';
        } else {
            inputDoc.placeholder = '00.000.000/0000-00';
            if (groupData) groupData.style.display = 'none';
        }
    }

    function aplicarMascaraDoc(i) {
        if (!i) return;
        const radioCpf = document.querySelector('input[name="tipoDoc"]:checked');
        const tipo = radioCpf ? radioCpf.value : 'CPF';
        let v = i.value.replace(/\D/g, '');
        if (tipo === 'CPF') {
            i.value = v.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4").slice(0, 14);
        } else {
            i.value = v.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, "$1.$2.$3/$4-$5").slice(0, 18);
        }
    }

    function aplicarMascaraOAB(i) {
        let v = i.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        if (v.length > 6) i.value = v.slice(0, 3) + '.' + v.slice(3, 6) + '/' + v.slice(6, 8);
        else if (v.length > 3) i.value = v.slice(0, 3) + '.' + v.slice(3);
        else i.value = v;
    }

    // 2. CARREGAMENTO DE DADOS
    async function carregarBancos() {
        try {
            const res = await fetch('https://brasilapi.com.br/api/banks/v1');
            const bancos = await res.json();
            const select = document.getElementById('confBanco');
            if (!select) return;
            select.innerHTML = '<option value="">Selecione o Banco</option>';
            bancos.sort((a,b) => (a.fullName || "") > (b.fullName || "") ? 1 : -1).forEach(b => {
                if(b.code) select.innerHTML += `<option value="${b.code}">${b.code} - ${b.fullName || b.name}</option>`;
            });
        } catch (e) { console.error("Erro bancos:", e); }
    }

async function carregarInfoRodape() {
    try {
        const resUser = await fetch('/api/auth/me', { headers: { Authorization: `Bearer ${token}` } });
        const dataUser = await resUser.json();
        
        if (dataUser.ok) {
            const nomeReal = dataUser.usuario.nome || 'Advogado';
            
            // --- L√ìGICA PADRONIZADA DO CABE√áALHO (Apenas primeiro nome) ---
            const primeiroNome = nomeReal.trim().split(' ')[0];
            document.getElementById('userNameHeader').innerText = primeiroNome;

            // Iniciais (Primeiro e √öltimo nome)
            const partes = nomeReal.trim().split(' ').filter(n => n);
            let iniciais = partes[0][0];
            if (partes.length > 1) iniciais += partes[partes.length - 1][0];
            
            const circulo = document.getElementById('userCircle');
            if (circulo) circulo.innerText = iniciais.toUpperCase();
            // -------------------------------------------------------------

            // Mant√©m preenchimento do formul√°rio e rodap√©
            document.getElementById('userEmailFooter').innerText = dataUser.usuario.email;
            if(document.getElementById('perfilEmail')) document.getElementById('perfilEmail').value = dataUser.usuario.email;
            if(document.getElementById('perfilNome')) document.getElementById('perfilNome').value = nomeReal;
        }

        // Carregamento do Plano
        const resPlan = await fetch('/api/plano-consumo', { headers: { Authorization: `Bearer ${token}` } });
        const dataPlan = await resPlan.json();
        if(document.getElementById('planNameFooter')) {
            document.getElementById('planNameFooter').innerText = dataPlan.plano || 'Individual';
        }

        // Carregamento dos dados do Escrit√≥rio (N√£o alterado)
        const resEsc = await fetch('/api/config/meu-escritorio', { headers: { Authorization: `Bearer ${token}` } });
        const dataEsc = await resEsc.json();
        
        if(dataEsc.ok && dataEsc.dados) {
            const d = dataEsc.dados;
            const campos = {
                'confAdvogadoResponsavel': d.advogado_responsavel,
                'confEscritorio': d.nome,
                'confOab': d.oab,
                'confDocumento': d.documento,
                'confDataNascimento': d.data_nascimento ? d.data_nascimento.split('T')[0] : '',
                'confCep': d.cep,
                'confCidade': d.cidade,
                'confEstado': d.estado,
                'confEndereco': d.endereco,
                'confAgencia': d.agencia,
                'confConta': d.conta,
                'confContaDigito': d.conta_digito,
                'confPixChave': d.pix_chave,
                'confBanco': d.banco_codigo
            };

            Object.keys(campos).forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = campos[id] || '';
            });

            if(d.renda_mensal && document.getElementById('confRendaMensal')) {
                document.getElementById('confRendaMensal').value = 'R$ ' + parseFloat(d.renda_mensal).toLocaleString('pt-BR', {minimumFractionDigits: 2});
            }
        }
    } catch (err) { 
        console.warn("Aviso: Falha ao carregar alguns dados do perfil."); 
    }
}

    // 3. A√á√ïES DE SALVAMENTO
    async function salvarPerfil() {
        const nome = document.getElementById('perfilNome').value;
        const res = await fetch('/api/config/perfil', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ nome })
        });
        if (res.ok) { alert("‚úÖ Nome atualizado!"); carregarInfoRodape(); }
        else alert("‚ùå Erro ao atualizar.");
    }

    async function salvarDadosJuridicos() {
        try {
            const rendaE = document.getElementById('confRendaMensal');
            const rendaTratada = rendaE ? rendaE.value.replace(/[R$\s.]/g, '').replace(',', '.') : 0;

            const dados = {
                advogado_responsavel: document.getElementById('confAdvogadoResponsavel')?.value || '',
                nome: document.getElementById('confEscritorio')?.value || '',
                oab: document.getElementById('confOab')?.value || '',
                documento: document.getElementById('confDocumento')?.value || '',
                dataNascimento: document.getElementById('confDataNascimento')?.value || null,
                email: document.getElementById('perfilEmail')?.value || '',
                endereco: document.getElementById('confEndereco')?.value || '',
                cidade: document.getElementById('confCidade')?.value || '',
                estado: document.getElementById('confEstado')?.value?.toUpperCase() || '',
                cep: document.getElementById('confCep')?.value?.replace(/\D/g, '') || '',
                banco_codigo: document.getElementById('confBanco')?.value || '',
                agencia: document.getElementById('confAgencia')?.value || '',
                conta: document.getElementById('confConta')?.value || '',
                conta_digito: document.getElementById('confContaDigito')?.value || '',
                pix_chave: document.getElementById('confPixChave')?.value || '',
                renda_mensal: parseFloat(rendaTratada) || 0
            };

            const res = await fetch('/api/config/escritorio', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(dados)
            });

            if (res.ok) alert("‚úÖ Dados salvos com sucesso!");
            else alert("‚ùå Erro ao salvar dados.");
        } catch (e) { console.error(e); alert("Erro ao processar salvamento."); }
    }

    async function salvarDadosBancarios() {
    const dados = {
        banco_codigo: document.getElementById('confBanco').value,
        agencia: document.getElementById('confAgencia').value,
        conta: document.getElementById('confConta').value,
        conta_digito: document.getElementById('confContaDigito').value,
        pix_chave: document.getElementById('confPixChave').value
    };

    const res = await fetch('/api/config/escritorio', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(dados)
    });

    if (res.ok) {
        dadosSalvos = true;
        document.querySelector('.btn-primary').disabled = false;
    } else {
        const d = await res.json();
        alert('‚ùå ' + (d.erro || 'Erro ao salvar'));
    }
}

    async function ativarFinanceiro() {
        if (!confirm("Confirmar ativa√ß√£o da conta Asaas com os dados acima?")) return;
        try {
            const res = await fetch('/api/financeiro/configurar-subconta', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();
            if (res.ok) alert("‚úÖ Faturamento Ativado!");
            else alert("‚ùå Erro: " + (data.erro || "Verifique os campos obrigat√≥rios."));
        } catch (e) { alert("Erro de conex√£o."); }
    }

    // 4. EQUIPE
async function carregarEquipe() {
    try {
        const res = await fetch('/api/auth/equipe', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error("Falha ao carregar equipe");

        const membros = await res.json();
        const lista = document.getElementById('listaEquipe');
        if (!lista) return;

        lista.innerHTML = '';  // limpa antes

        if (membros.length === 0) {
            lista.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 20px;">Nenhum membro na equipe ainda.</p>';
            return;
        }

        membros.forEach(m => {
            lista.innerHTML += `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #f1f5f9;">
                    <div>
                        <div style="font-weight: 600; font-size: 14px;">${m.nome || 'Sem nome'}</div>
                        <div style="font-size: 12px; color: var(--muted);">${m.email || '‚Äî'}</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span style="background: #e0e7ff; color: #4338ca; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 700;">
                            ${ (m.role || 'operador').toUpperCase() }
                        </span>
                        <button onclick="excluirMembro(${m.id})" 
                                style="background: none; border: none; color: #ef4444; cursor: pointer; display: flex; align-items: center;">
                            <i data-lucide="trash-2" style="width: 18px; height: 18px;"></i>
                        </button>
                    </div>
                </div>
            `;
        });

        // Chama o Lucide **depois** de inserir todo o HTML novo
        if (typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function') {
            lucide.createIcons();
            console.log("√çcones Lucide atualizados com sucesso na lista de equipe");
        } else {
            console.warn("Biblioteca Lucide n√£o encontrada ou createIcons indispon√≠vel");
        }

    } catch (e) {
        console.error("Erro ao carregar equipe:", e);
        const lista = document.getElementById('listaEquipe');
        if (lista) {
            lista.innerHTML = '<p style="color: #ef4444; text-align: center; padding: 20px;">Erro ao carregar a equipe. Tente recarregar a p√°gina.</p>';
        }
    }
}

    async function excluirMembro(id) {
        if (!confirm("Remover integrante imediatamente?")) return;
        const res = await fetch(`/api/auth/equipe/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (res.ok) { alert("Acesso revogado."); carregarEquipe(); }
    }

    async function salvarMembro() {
        const nome = document.getElementById('eqNome').value;
        const email = document.getElementById('eqEmail').value;
        const senha = document.getElementById('eqSenha').value;
        const role = document.getElementById('eqRole').value;

        if (!nome || !email || !senha) return alert("Preencha todos os campos da equipe.");

        const res = await fetch('/api/auth/convidar-funcionario', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ nome, email, senha, role })
        });

        if (res.ok) {
            alert('‚úÖ Funcion√°rio adicionado!');
            document.getElementById('eqNome').value = '';
            document.getElementById('eqEmail').value = '';
            document.getElementById('eqSenha').value = '';
            carregarEquipe();
        } else {
            const d = await res.json();
            alert('‚ùå Erro: ' + (d.erro || 'Acesso negado.'));
        }
    }

async function alterarSenha() {
    const s1 = document.getElementById('novaSenha').value.trim();
    const s2 = document.getElementById('confirmaSenha').value.trim();

    if (!s1) return alert("Digite a nova senha!");
    if (s1 !== s2) return alert("As senhas n√£o conferem!");
    if (s1.length < 6) return alert("A senha deve ter pelo menos 6 caracteres!");

    try {
        const res = await fetch('/api/senha', {
            method: 'PUT',
            headers: { 
                'Content-Type': 'application/json', 
                'Authorization': `Bearer ${token}` 
            },
            body: JSON.stringify({ senha: s1 })
        });

        const data = await res.json();

        if (res.ok) {
            alert("‚úÖ Senha alterada com sucesso!");
            document.getElementById('novaSenha').value = '';
            document.getElementById('confirmaSenha').value = '';
        } else {
            alert("‚ùå " + (data.erro || `Erro ${res.status}: ${res.statusText}`));
            console.log("Detalhes do erro:", data);
        }
    } catch (err) {
        console.error("Erro na requisi√ß√£o de senha:", err);
        alert("Falha na conex√£o. Verifique se o servidor est√° rodando.");
    }
}

    function toggleUserMenu() {
        const m = document.getElementById('userDropdown');
        if(m) m.style.display = m.style.display === 'none' ? 'block' : 'none';
    }

    function logout() { localStorage.removeItem('token'); window.location.href = '/login.html'; }

    window.onload = () => {
    carregarBancos();
    carregarInfoRodape();
    ajustarMascaraDoc();
    carregarEquipe();

    // üîí Bloqueia ativa√ß√£o at√© salvar dados banc√°rios
    const elemento = document.getElementById('ID_DO_ELEMENTO');  // substitua pelo ID real
if (elemento) {
    elemento.disabled = true;  // ou false, dependendo do que o c√≥digo faz
}
};

    window.onclick = (e) => {
        if (!e.target.closest('#userCircle') && !e.target.closest('#userDropdown')) {
            const m = document.getElementById('userDropdown');
            if(m) m.style.display = 'none';
        }
    };
    </script>
</body>
</html>