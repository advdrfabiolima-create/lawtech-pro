<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>LawTech Pro ‚Äî Central Financeira e Cobran√ßa</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/lucide-static@0.451.0/font/lucide.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="upgrade-modal.js"></script>

    <style>
        :root {
            /* Light Theme Colors - Professional & Clean */
            --bg-primary: #f8fafc;
            --bg-secondary: #111827;
            --bg-tertiary: #1a2332;
            --bg-elevated: #ffffff;
            
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-tertiary: #64748b;
            
            --accent-blue: #2563eb;
            --accent-blue-light: #3b82f6;
            --accent-blue-glow: rgba(37, 99, 235, 0.3);
            
            --accent-green: #10b981;
            --accent-purple: #8b5cf6;
            --accent-orange: #f59e0b;
            --accent-red: #ef4444;
            --accent-gold: #fbbf24;
            
            --border-subtle: rgba(0, 0, 0, 0.08);
            --border-medium: rgba(0, 0, 0, 0.12);
            
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            
            --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Compatibility */
            --bg: var(--bg-primary);
            --sidebar: var(--bg-secondary);
            --white: var(--bg-elevated);
            --border: var(--border-medium);
            --primary: var(--accent-blue);
            --success: var(--accent-green);
            --danger: var(--accent-red);
            --warning: var(--accent-orange);
            --muted: var(--text-tertiary);
            --text-main: var(--text-primary);
            --text-menu: var(--text-tertiary);
            --sidebar-hover: var(--bg-tertiary);
            --radius: 12px;
        }

        * { box-sizing: border-box; font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--text-main); line-height: 1.5; display: flex; }

        /* Sidebar Premium */
        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-right: 1px solid var(--border-subtle);
            padding: 32px 24px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 1000;
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .sidebar-header img {
            width: 100%;
            max-width: 180px;
            height: auto;
            filter: drop-shadow(0 0 20px var(--accent-blue-glow));
            transition: all var(--transition-base);
        }

        .sidebar-header img:hover {
            filter: drop-shadow(0 0 30px var(--accent-blue-glow));
            transform: scale(1.05);
        }

        .menu {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex-grow: 1;
        }

        .menu a {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            color: #94a3b8;
            text-decoration: none;
            border-radius: var(--radius-lg);
            font-size: 14px;
            font-weight: 600;
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .menu a::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--accent-blue);
            transform: scaleY(0);
            transition: transform var(--transition-base);
        }

        .menu a:hover::before,
        .menu a.active::before {
            transform: scaleY(1);
        }

        .menu a i {
            margin-right: 12px;
            font-size: 18px;
            transition: all var(--transition-base);
        }

        .menu a:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #e2e8f0;
            transform: translateX(4px);
        }

        .menu a.active {
            background: rgba(37, 99, 235, 0.15);
            color: #60a5fa;
            border: 1px solid rgba(37, 99, 235, 0.4);
        }

        .menu a.active i {
            color: #60a5fa;
        }

        .sidebar-footer {
            padding-top: 24px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 12px;
            margin-top: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .sidebar-footer span {
            color: #cbd5e1 !important;
        }

        .main { margin-left: 280px; flex: 1; min-height: 100vh; display: flex; flex-direction: column; position: relative; z-index: 1; }
        .header { background: var(--white); height: 72px; padding: 0 32px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 900; }
        .content { padding: 32px; }

        .cards-financeiro { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 32px; }
        .card-stat { background: var(--white); border-radius: var(--radius); padding: 18px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .card-label { color: var(--muted); font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; }
        .card-value { font-size: 20px; font-weight: 700; margin-top: 6px; }

        .analytics-grid { display: grid; grid-template-columns: 1.2fr 1fr 0.8fr; gap: 20px; margin-bottom: 32px; }
        .card-center { background: var(--white); border-radius: var(--radius); padding: 20px; border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .card-title { font-size: 12px; font-weight: 700; color: var(--muted); margin-bottom: 15px; display: flex; align-items: center; gap: 8px; text-transform: uppercase; }

        .billing-list { display: flex; flex-direction: column; gap: 10px; max-height: 180px; overflow-y: auto; }
        .billing-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8fafc; border-radius: 8px; border: 1px solid var(--border); }
        .btn-mini-boleto { background: var(--primary); color: white; border: none; padding: 6px 10px; border-radius: 6px; font-size: 10px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 4px; }
        
        .filter-row { display: flex; gap: 10px; margin-bottom: 24px; align-items: center; }
        .btn-filter { background: #fff; border: 1px solid var(--border); padding: 8px 16px; border-radius: 20px; font-size: 12px; cursor: pointer; color: var(--muted); font-weight: 600; }
        .btn-filter.active { background: var(--primary); color: #fff; border-color: var(--primary); }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; background: #f8fafc; color: var(--muted); padding: 14px 16px; border-bottom: 2px solid var(--border); font-size: 11px; text-transform: uppercase; font-weight: 700; }
        td { padding: 14px 16px; border-bottom: 1px solid var(--border); font-size: 13px; }

        .modal { display:none; position:fixed; inset:0; background:rgba(15, 23, 42, 0.7); z-index:10000; align-items:center; justify-content:center; backdrop-filter: blur(4px); }
        .modal-content { background:#fff; width:100%; max-width:450px; padding:32px; border-radius:16px; max-height: 90vh; overflow-y: auto; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 11px; font-weight: 700; color: var(--muted); margin-bottom: 5px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; }

        /* Estilo para upload de logo */
        .logo-preview {
            width: 150px;
            height: 150px;
            border: 2px dashed var(--border);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 15px auto;
            overflow: hidden;
            position: relative;
            background: #f8fafc;
        }

        .logo-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .logo-preview-placeholder {
            text-align: center;
            color: var(--muted);
            font-size: 12px;
            padding: 20px;
        }

        .btn-upload {
            background: var(--accent-purple);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all var(--transition-base);
        }

        .btn-upload:hover {
            background: #7c3aed;
            transform: translateY(-2px);
        }

        @media print { .no-print, .sidebar, .header, .analytics-grid { display: none !important; } .main { margin-left: 0; } }

        .btn-crm-gold-nav {
            background: linear-gradient(135deg, var(--accent-gold) 0%, #facc15 100%) !important;
            color: #000 !important;
            font-weight: 800 !important;
            margin-top: 16px !important;
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
            position: relative;
            overflow: hidden;
            border-radius: var(--radius-lg);
            padding: 14px 16px !important;
            display: flex !important;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            font-size: 14px;
            transition: all var(--transition-base);
        }

        .btn-crm-gold-nav i {
            margin-right: 10px;
            font-size: 18px;
        }

        .btn-crm-gold-nav:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(251, 191, 36, 0.6);
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Estilos para Checkbox */
input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: var(--accent-green);
}

/* Tabela do Relat√≥rio */
.relatorio-table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
}

.relatorio-table th {
    background: var(--bg-primary);
    padding: 12px;
    text-align: left;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    color: var(--text-secondary);
    border-bottom: 2px solid var(--border-medium);
}

.relatorio-table td {
    padding: 12px;
    border-bottom: 1px solid var(--border-subtle);
    font-size: 13px;
}

.relatorio-table tr:hover {
    background: var(--bg-primary);
}

.relatorio-resumo {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    padding: 25px;
    border-radius: 12px;
    margin-top: 25px;
    border: 2px solid var(--accent-blue);
}

.relatorio-resumo-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 20px;
    margin-top: 15px;
}

.relatorio-resumo-item {
    text-align: center;
}

.relatorio-resumo-label {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    color: var(--text-tertiary);
    margin-bottom: 8px;
}

.relatorio-resumo-valor {
    font-size: 28px;
    font-weight: 900;
    color: var(--text-primary);
}

.valor-positivo {
    color: var(--accent-green);
}

.valor-negativo {
    color: var(--accent-red);
}

/* Padroniza√ß√£o LawTech Pro - Caixa Alta Global */
body {
    text-transform: uppercase;
}

/* Garante que os campos de digita√ß√£o tamb√©m mostrem caixa alta enquanto o usu√°rio digita */
input, textarea, select {
    text-transform: uppercase;
}

/* Opcional: Se quiser que os n√∫meros dos processos mantenham o estilo t√©cnico, 
   mas ainda em caixa alta */
.numero-processo, .processo-hash {
    font-family: 'JetBrains Mono', monospace;
    letter-spacing: 1px;
}

/* Container do rodap√© */
.sidebar-footer {
    padding-top: 20px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    margin-top: auto;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

/* Alinhamento √† esquerda (In√≠cio) */
.footer-info-row {
    display: flex;
    justify-content: flex-start; /* Alinha no come√ßo da linha */
    align-items: center;
    gap: 5px; /* Espa√ßo fixo ap√≥s os ":" */
    font-size: 12px;
}

/* R√≥tulos em caixa alta */
.footer-info-row span:first-child {
    text-transform: uppercase;
    color: var(--text-tertiary, #64748b);
    font-weight: 700;
    white-space: nowrap;
}

/* ‚úÖ Regra para e-mail e plano em min√∫sculas */
.keep-lowercase {
    text-transform: none !important; /* Cancela o uppercase global */
    font-variant: normal !important;
    color: #cbd5e1;
}
    </style>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>

    <aside class="sidebar">
        <div class="sidebar-header"><img src="Logo LawTech Pro_transparente.png" alt="LawTech Pro"></div>
        <nav class="menu">
            <a href="/dashboard"><i class="lucide lucide-layout-dashboard"></i> Dashboard</a>
            <a href="/clientes-page"><i class="lucide lucide-users"></i> Clientes</a>
            <a href="/prazos-page"><i class="lucide lucide-clock"></i> Prazos</a>
            <a href="/processos-page"><i class="lucide lucide-folder"></i> Processos</a>
            <a href="/audiencias-page"><i class="lucide lucide-calendar-days"></i> Audi√™ncias</a>
            <a href="/calculos-page"><i class="lucide lucide-calculator"></i> C√°lculos Jur√≠dicos</a>
            <a href="/financeiro-page" class="active"><i class="lucide lucide-credit-card"></i> Financeiro</a>
            <a href="/publicacoes-page"><i class="lucide lucide-clock"></i> Publica√ß√µes DJEN</a>
            <a href="/ia-page" style="display: flex; align-items: center; gap: 10px;">
                <i class="lucide lucide-sparkles" style="color: #fbbf24;"></i> IA Jur√≠dica 
                <span style="font-size: 9px; background: #fbbf24; color: #000; padding: 2px 5px; border-radius: 4px; font-weight: bold; margin-left: auto;">PREMIUM</span>
            </a>
            <a href="/planos-page"><i class="lucide lucide-award"></i> Gest√£o de Planos</a>
            <a href="/config-page"><i class="lucide lucide-settings"></i> Configura√ß√µes</a>
            <a href="/crm-page" class="btn-crm-gold-nav">
            <i class="lucide lucide-trending-up"></i> CRM PROSPEC√á√ÉO
            </a>
        </nav>
        <div class="sidebar-footer">
    <div class="footer-info-row">
        <span>Usu√°rio:</span> 
        <span id="userEmail" class="keep-lowercase">...</span>
    </div>
    
    <div class="footer-info-row">
        <span>Plano:</span> 
        <span id="planNameFooter" class="keep-lowercase">...</span>
    </div>
</div>
    </aside>

    <div class="main">
<header class="header no-print">
    <h2 style="font-size: 18px; font-weight: 700;">üí∞ Fluxo de Caixa Estrat√©gico</h2>
    
    <div style="display:flex; gap:20px; align-items:center;">
        <button class="btn-mini-boleto" style="padding: 10px 20px; font-size: 13px;" onclick="abrirModalLancamento()">+ Novo Lan√ßamento</button>
        <button class="btn-upload" onclick="abrirModalLogo()">
            <i class="lucide lucide-image"></i> Logo
        </button>

        <div style="position: relative; display: flex; align-items: center; gap: 12px;">
            <span id="userNameHeader" style="font-size: 13px; font-weight: 600; color: var(--muted);">Advogado</span>
            <div onclick="toggleUserMenu()" id="userCircle" style="width: 38px; height: 38px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: 700; border: 2px solid #e2e8f0; font-size: 13px; text-transform: uppercase;">
                --
            </div>
            <div id="userDropdown" style="display: none; position: absolute; top: 50px; right: 0; background: white; border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); width: 180px; z-index: 1001;">
                <a href="/config-page" style="display: block; padding: 10px 16px; color: var(--text-main); text-decoration: none; font-size: 13px; border-bottom: 1px solid var(--border);">üë§ Meus Dados</a>
                <a href="#" onclick="logout()" style="display: block; padding: 10px 16px; color: var(--danger); text-decoration: none; font-size: 13px; font-weight: 600;">üö™ Sair</a>
            </div>
        </div>
    </div>
</header>

<main class="content">
    <div class="cards-financeiro">        
        <div class="card-stat" style="border-left: 4px solid var(--success);"><p class="card-label">Receitas Reais</p><h3 id="totalReceitas" class="card-value" style="color: var(--success);">R$ 0,00</h3></div>
        <div class="card-stat" style="border-left: 4px solid var(--danger);"><p class="card-label">Despesas Pagas</p><h3 id="totalDespesas" class="card-value" style="color: var(--danger);">R$ 0,00</h3></div>
        <div class="card-stat" style="border-left: 4px solid #34d399;"><p class="card-label">Boleto / A Receber</p><h3 id="totalAReceber" class="card-value" style="color: #34d399;">R$ 0,00</h3></div>
        <div class="card-stat" style="border-left: 4px solid var(--warning);"><p class="card-label">Contas a Pagar</p><h3 id="totalAPagar" class="card-value" style="color: var(--warning);">R$ 0,00</h3></div>
        <div class="card-stat" style="background: #eff6ff; border-left: 4px solid var(--primary);"><p class="card-label">Saldo L√≠quido</p><h3 id="saldoTotal" class="card-value" style="color: var(--primary);">R$ 0,00</h3></div>
    </div>

    <div class="analytics-grid no-print" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 30px; align-items: stretch;">
        
        <div class="card-center" style="display: flex; flex-direction: column;">
            <div class="card-title"><i class="lucide lucide-trending-up"></i> Evolu√ß√£o</div>
            <div style="flex-grow: 1; min-height: 150px; position: relative;">
                <canvas id="financeChart"></canvas>
            </div>
        </div>

        <div class="card-center" style="border-top: 4px solid var(--primary);">
            <div class="card-title" style="color: var(--primary);"><i class="lucide lucide-barcode"></i> Cobran√ßas</div>
            <div class="billing-list" id="listaCobrancaRapida"></div>
            <button class="btn-filter" style="width:100%; margin-top:10px; border-style: dashed;" onclick="rolarParaTabela()">Ver todas ‚Üì</button>
        </div>

        <div class="card-center">
            <div class="card-title"><i class="lucide lucide-pie-chart"></i> Sa√∫de</div>
            <div id="resumoTexto" style="display: flex; flex-direction: column; gap: 12px;">
                <div style="display: flex; justify-content: space-between; border-bottom: 1px solid #f1f5f9; padding-bottom: 5px;">
                    <span style="font-size: 10px; font-weight: 700;">TICKET M√âDIO</span>
                    <span id="kpi-ticket" style="font-weight: 700; color: var(--primary);">R$ 0,00</span>
                </div>
                <div style="display: flex; justify-content: space-between; border-bottom: 1px solid #f1f5f9; padding-bottom: 5px;">
                    <span style="font-size: 10px; font-weight: 700;">INADIMPL√äNCIA</span>
                    <span id="kpi-inadimplencia" style="font-weight: 700; color: var(--danger);">0%</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="font-size: 10px; font-weight: 700;">MARGEM</span>
                    <span id="kpi-margem" style="font-weight: 700; color: var(--success);">0%</span>
                </div>
            </div>
        </div>
    </div>

    <div class="filter-row no-print" style="display: flex; justify-content: space-between; width: 100%; margin-bottom: 15px;">
        <button class="btn-filter active">Lan√ßamentos</button>
        <button class="btn-filter" onclick="window.print()" style="border-color: var(--primary); color: var(--primary);">
            <i class="lucide lucide-printer" style="width: 14px;"></i> Imprimir
        </button> 
        <button class="btn-filter" onclick="abrirRelatorioFaturamento()" style="border-color: var(--accent-green); color: var(--accent-green);">
    <i class="lucide lucide-bar-chart-3" style="width: 14px;"></i> Relat√≥rio de Faturamento
</button>
    </div>

    <div class="table-card" style="background: white; border-radius: 12px; border: 1px solid var(--border); width: 100%; overflow: hidden;">
        <table style="width: 100%;">
            <thead>
                <tr>
                    <th style="padding-left: 20px;">Descri√ß√£o</th>
                    <th>Valor</th>
                    <th>Vencimento</th>
                    <th>Status</th>
                    <th style="text-align: center;">A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="corpoTabela"></tbody>
        </table>
    </div>
</main>
    </div>

    <!-- Modal Novo Lan√ßamento -->
    <div id="modalNovoLancamento" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px; font-weight: 800;">üí∞ Novo Lan√ßamento Financeiro</h3>
            <div class="form-group">
                <label>DESCRI√á√ÉO</label>
                <input type="text" id="addDescricao" placeholder="Ex: Honor√°rios Processo X">
            </div>
            <div class="form-group">
                <label>VALOR (R$)</label>
                <input type="text" id="addValor" placeholder="R$ 0,00">
            </div>
            <div class="form-group">
                <label>TIPO</label>
                <select id="addTipo">
                    <option value="Receita">Receita (Honor√°rios/Entrada)</option>
                    <option value="Despesa">Despesa (Custas/Sa√≠da)</option>
                </select>
            </div>
            <div class="form-group">
                <label>DATA DE VENCIMENTO</label>
                <input type="date" id="addData">
            </div>
            <button class="btn-mini-boleto" style="width: 100%; padding: 14px; font-size: 14px; justify-content: center;" onclick="salvarLancamento()">SALVAR NO FLUXO</button>
            <button style="width: 100%; margin-top: 10px; background: none; border: none; color: var(--muted); cursor: pointer;" onclick="fecharModalLancamento()">Cancelar</button>
        </div>
    </div>

    <!-- Modal Cobran√ßa -->
    <div id="modalCobranca" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 12px; font-weight: 800;">üìÑ Emiss√£o de Boleto Registrado</h3>
            <p id="cobrancaResumo" style="font-size: 13px; color: var(--muted); margin-bottom: 15px; padding: 12px; background: #f0f7ff; border-radius: 8px;"></p>
            
            <div class="form-group">
                <label>CLIENTE PARA O BOLETO</label>
                <select id="selectClienteBoleto"><option value="">Carregando clientes...</option></select>
            </div>

            <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                <div style="flex:1"><label style="font-size:11px; font-weight:700;">MULTA (2%)</label><input type="number" id="cobMulta" value="2.00" style="width:100%; padding:10px; border:1px solid #e2e8f0; border-radius:8px;"></div>
                <div style="flex:1"><label style="font-size:11px; font-weight:700;">JUROS (1%)</label><input type="number" id="cobJuros" value="1.00" style="width:100%; padding:10px; border:1px solid #e2e8f0; border-radius:8px;"></div>
            </div>

            <button class="btn-mini-boleto" style="width:100%; justify-content:center; padding:14px; font-size:14px;" onclick="confirmarBoleto()">GERAR E ENVIAR BOLETO</button>
            <button style="width:100%; margin-top:10px; background:#f1f5f9; border:none; color:var(--text-main); padding:12px; border-radius:8px; cursor:pointer; font-size:12px; font-weight:600;" 
                    onclick="document.getElementById('modalCobranca').style.display='none'">
                CANCELAR E VOLTAR
            </button>
        </div>
    </div>

    <!-- Modal Editar Lan√ßamento -->
    <div id="modalEditarLancamento" class="modal">
    <div class="modal-content">
        <h3 style="margin-bottom: 20px; font-weight: 800;">üìù Editar Lan√ßamento</h3>
        <input type="hidden" id="editId"> <div class="form-group">
            <label>DESCRI√á√ÉO</label>
            <input type="text" id="editDescricao">
        </div>
        <div class="form-group">
            <label>VALOR (R$)</label>
            <input type="number" id="editValor" step="0.01">
        </div>
        <div class="form-group">
            <label>TIPO</label>
            <select id="editTipo">
                <option value="Receita">Receita</option>
                <option value="Despesa">Despesa</option>
            </select>
        </div>
        <div class="form-group">
            <label>DATA DE VENCIMENTO</label>
            <input type="date" id="editData">
        </div>
        <button class="btn-mini-boleto" style="width: 100%; padding: 14px; font-size: 14px; justify-content: center;" onclick="atualizarLancamento()">SALVAR ALTERA√á√ïES</button>
        <button style="width: 100%; margin-top: 10px; background: none; border: none; color: var(--muted); cursor: pointer;" onclick="document.getElementById('modalEditarLancamento').style.display='none'">Cancelar</button>
    </div>
</div>

    <!-- Modal Emiss√£o de Recibo -->
    <div id="modalRecibo" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px; font-weight: 800;">üìÑ Emitir Recibo</h3>
            
            <div class="form-group">
                <label>N√öMERO DO RECIBO</label>
                <input type="text" id="reciboNumero" placeholder="Ex: REC-001/2025">
            </div>

            <div class="form-group">
                <label>SELECIONAR CLIENTE CADASTRADO</label>
                <select id="reciboClienteSelect" onchange="preencherDadosCliente()">
                    <option value="">Selecione um cliente ou preencha manualmente abaixo</option>
                </select>
            </div>

            <div class="form-group">
                <label>NOME DO CLIENTE</label>
                <input type="text" id="reciboClienteNome" placeholder="Ex: Jo√£o da Silva">
            </div>

            <div class="form-group">
                <label>CPF/CNPJ DO CLIENTE</label>
                <input type="text" id="reciboClienteDoc" placeholder="000.000.000-00">
            </div>

            <div class="form-group">
                <label>VALOR (R$)</label>
                <input type="number" id="reciboValor" step="0.01" placeholder="0.00">
            </div>

            <div class="form-group">
                <label>DESCRI√á√ÉO / REFERENTE A</label>
                <textarea id="reciboDescricao" rows="3" placeholder="Ex: Honor√°rios advocat√≠cios referente ao processo n¬∫..."></textarea>
            </div>

            <div class="form-group">
                <label>FORMA DE PAGAMENTO</label>
                <select id="reciboFormaPagamento">
                    <option value="Dinheiro">Dinheiro</option>
                    <option value="PIX">PIX</option>
                    <option value="Transfer√™ncia">Transfer√™ncia</option>
                    <option value="Cart√£o de Cr√©dito">Cart√£o de Cr√©dito</option>
                    <option value="Cart√£o de D√©bito">Cart√£o de D√©bito</option>
                    <option value="Boleto">Boleto</option>
                    <option value="Cheque">Cheque</option>
                </select>
            </div>

            <input type="hidden" id="reciboLancamentoId">

            <button class="btn-mini-boleto" style="width: 100%; padding: 14px; font-size: 14px; justify-content: center;" onclick="gerarRecibo()">
                <i class="lucide lucide-file-text"></i> GERAR RECIBO EM PDF
            </button>
            <button style="width: 100%; margin-top: 10px; background: none; border: none; color: var(--muted); cursor: pointer;" onclick="fecharModalRecibo()">Cancelar</button>
        </div>
    </div>

<!-- Modal Upload Logo + Assinatura -->
<div id="modalLogo" class="modal">
    <div class="modal-content">

        <h3 style="margin-bottom: 20px; font-weight: 800;">üñºÔ∏è Logomarca do Escrit√≥rio</h3>
        
        <p style="font-size: 13px; color: var(--muted); margin-bottom: 20px;">
            A logomarca ser√° exibida no cabe√ßalho e no rodap√© dos recibos.
        </p>

        <div class="logo-preview" id="logoPreview">
            <div class="logo-preview-placeholder">
                <i class="lucide lucide-image" style="font-size: 32px; margin-bottom: 8px;"></i>
                <p>Nenhuma logo configurada</p>
            </div>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <input 
                type="file" 
                id="logoInput" 
                accept="image/png,image/jpeg,image/jpg" 
                style="display: none;" 
                onchange="uploadLogo()"
            >
            <button class="btn-upload" onclick="document.getElementById('logoInput').click()">
                <i class="lucide lucide-upload"></i> Selecionar Logo
            </button>
        </div>

        <p style="font-size: 11px; color: var(--muted); text-align: center;">
            Formatos aceitos: PNG ou JPG (at√© 5MB)
        </p>

        <hr style="margin: 30px 0; border: none; border-top: 1px dashed #e2e8f0;">

        <h4 style="margin-bottom: 10px; font-weight: 800;">‚úçÔ∏è Assinatura Digital</h4>

        <p style="font-size: 13px; color: var(--muted); margin-bottom: 15px;">
            A assinatura ser√° inserida automaticamente acima da linha de assinatura no recibo.
        </p>

        <div class="logo-preview" id="assinaturaPreview">
            <div class="logo-preview-placeholder">
                <i class="lucide lucide-pen-tool" style="font-size: 28px; margin-bottom: 6px;"></i>
                <p>Nenhuma assinatura configurada</p>
            </div>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <input 
                type="file" 
                id="assinaturaInput" 
                accept="image/png,image/jpeg,image/jpg" 
                style="display: none;" 
                onchange="uploadAssinatura()"
            >
            <button 
                class="btn-upload" 
                style="background: var(--accent-green);" 
                onclick="document.getElementById('assinaturaInput').click()"
            >
                <i class="lucide lucide-upload"></i> Selecionar Assinatura
            </button>
        </div>

        <p style="font-size: 11px; color: var(--muted); text-align: center;">
            Formatos aceitos: PNG ou JPG (fundo transparente recomendado)
        </p>

        <button 
            style="width: 100%; margin-top: 25px; background: #f1f5f9; border: none; color: var(--text-main); padding: 12px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600;" 
            onclick="fecharModalLogo()"
        >
            FECHAR
        </button>

    </div>
</div>

<!-- Modal Relat√≥rio de Faturamento -->
<div id="modalRelatorioFaturamento" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <h3 style="margin-bottom: 20px; font-weight: 800;">üìä Relat√≥rio de Faturamento</h3>
        
        <p style="font-size: 13px; color: var(--muted); margin-bottom: 25px;">
            Gere relat√≥rios detalhados de receitas, despesas e lucro l√≠quido por per√≠odo.
        </p>

        <!-- Tipo de Per√≠odo -->
        <div class="form-group">
            <label>TIPO DE RELAT√ìRIO</label>
            <select id="relatorioTipo" onchange="atualizarCamposPeriodo()">
                <option value="mensal">üìÖ Mensal (escolha o m√™s)</option>
                <option value="anual">üìÜ Anual (escolha o ano)</option>
                <option value="personalizado">üîß Per√≠odo Personalizado</option>
            </select>
        </div>

        <!-- Campos para Mensal -->
        <div id="camposMensal" class="form-group">
            <label>M√äS E ANO</label>
            <input type="month" id="relatorioMes" value="">
        </div>

        <!-- Campos para Anual -->
        <div id="camposAnual" class="form-group" style="display: none;">
            <label>ANO</label>
            <select id="relatorioAno">
                <option value="2025">2025</option>
                <option value="2024">2024</option>
                <option value="2023">2023</option>
                <option value="2022">2022</option>
            </select>
        </div>

        <!-- Campos para Personalizado -->
        <div id="camposPersonalizado" style="display: none;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label>DATA INICIAL</label>
                    <input type="date" id="relatorioDataInicio">
                </div>
                <div class="form-group">
                    <label>DATA FINAL</label>
                    <input type="date" id="relatorioDataFim">
                </div>
            </div>
        </div>

        <!-- Op√ß√µes de Filtro -->
        <div class="form-group">
            <label>INCLUIR</label>
            <div style="display: flex; gap: 20px; margin-top: 10px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="incluirReceitas" checked>
                    <span style="font-size: 13px; font-weight: 500;">Receitas</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="incluirDespesas" checked>
                    <span style="font-size: 13px; font-weight: 500;">Despesas</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="apenasRealizados" checked>
                    <span style="font-size: 13px; font-weight: 500;">Apenas Pagos</span>
                </label>
            </div>
        </div>

        <!-- Bot√µes de A√ß√£o -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 30px;">
            <button class="btn-mini-boleto" style="padding: 14px; font-size: 14px; justify-content: center; background: var(--accent-blue);" onclick="visualizarRelatorio()">
                <i class="lucide lucide-eye"></i> VISUALIZAR
            </button>
            <button class="btn-mini-boleto" style="padding: 14px; font-size: 14px; justify-content: center;" onclick="gerarPDFRelatorio()">
                <i class="lucide lucide-download"></i> GERAR PDF
            </button>
        </div>

        <button style="width: 100%; margin-top: 15px; background: none; border: none; color: var(--muted); cursor: pointer; font-weight: 600;" onclick="fecharRelatorioFaturamento()">
            Cancelar
        </button>
    </div>
</div>

<!-- √Årea de Visualiza√ß√£o do Relat√≥rio -->
<div id="modalVisualizacaoRelatorio" class="modal">
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h3 style="font-weight: 800;">üìä Relat√≥rio de Faturamento</h3>
            <button onclick="fecharVisualizacaoRelatorio()" style="background: none; border: none; cursor: pointer; font-size: 24px; color: var(--muted);">&times;</button>
        </div>
        
        <div id="conteudoRelatorio"></div>

        <div style="display: flex; gap: 15px; margin-top: 30px;">
            <button class="btn-mini-boleto" style="flex: 1; padding: 14px; justify-content: center;" onclick="gerarPDFRelatorio()">
                <i class="lucide lucide-download"></i> BAIXAR PDF
            </button>
            <button style="flex: 1; padding: 14px; background: #f1f5f9; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;" onclick="fecharVisualizacaoRelatorio()">
                FECHAR
            </button>
        </div>
    </div>
</div>


    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/login.html';
        
        let originalData = [];
        let financeChart;
        let lancamentoParaCobrar = null;
        let clientesCadastrados = []; // Lista de clientes para o select

        // --- INICIALIZA√á√ÉO √öNICA ---
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üìÑ DOM carregado');
            setTimeout(async () => {
                await inicializar();
                await carregarClientesParaBoleto();
                await carregarClientesParaRecibo(); // Nova fun√ß√£o
                await carregarSaldoReal();
                await carregarLogoAtual();
            }, 100);
        });

        window.onload = async () => {
            console.log('üåê Window carregado');
            await inicializar();
            await carregarClientesParaBoleto();
            await carregarClientesParaRecibo(); // Nova fun√ß√£o
            await carregarSaldoReal();
            await carregarLogoAtual();
        };

async function inicializar() {
    try {
        console.log('üîÑ Inicializando p√°gina financeira...');
        
        const resU = await fetch('/api/auth/me', { headers: { Authorization: `Bearer ${token}` } });
        const du = await resU.json(); 
        
        if(du.ok) {
            const emailElement = document.getElementById('userEmail');
            if (emailElement) {
                emailElement.innerText = du.usuario.email || 'N√£o dispon√≠vel';
                console.log('‚úÖ Email atualizado:', du.usuario.email);
            }

            const nomeCompleto = du.usuario.nome || 'Advogado';
            const primeiroNome = nomeCompleto.trim().split(' ')[0];
            const nameHeader = document.getElementById('userNameHeader');
            if (nameHeader) nameHeader.innerText = primeiroNome;

            const partes = nomeCompleto.trim().split(' ').filter(n => n);
            let iniciais = partes[0][0];
            if (partes.length > 1) {
                iniciais += partes[partes.length - 1][0];
            }
            
            const circulo = document.getElementById('userCircle');
            if (circulo) circulo.innerText = iniciais.toUpperCase();
        }

        const resP = await fetch('/api/plano-consumo', { headers: { Authorization: `Bearer ${token}` } });
        const dp = await resP.json();
        
        const planoElement = document.getElementById('planNameFooter');
        if (planoElement) {
            planoElement.innerText = dp.plano || 'Free';
            console.log('‚úÖ Plano atualizado:', dp.plano);
        }

        await carregarDados();
    } catch (e) { 
        console.error("‚ùå Erro na inicializa√ß√£o financeira:", e); 
    }
}

        async function carregarDados() {
            const res = await fetch('/api/financeiro', { headers: { Authorization: `Bearer ${token}` } });
            originalData = await res.json();
            renderizar(originalData);
        }

        function renderizar(lista) {
    const corpo = document.getElementById('corpoTabela');
    const listaCobranca = document.getElementById('listaCobrancaRapida');
    
    corpo.innerHTML = '';
    listaCobranca.innerHTML = '';
    let liqR = 0, liqD = 0, pendR = 0, pendD = 0;
    let countReceitasPagas = 0;

    lista.forEach(item => {
        const v = parseFloat(item.valor);
        const isR = item.tipo === 'Receita';
        const isP = item.status === 'Pago';

        if (isP) { 
            if (isR) { liqR += v; countReceitasPagas++; } else liqD += v; 
        } else { 
            if (isR) pendR += v; else pendD += v; 
        }

        if (!isP && isR) {
            listaCobranca.innerHTML += `
                <div class="billing-item">
                    <div>
                        <div style="font-size:11px; font-weight:700; color:var(--text-main);">${item.descricao}</div>
                        <div style="font-size:12px; font-weight:800; color:var(--success); margin: 2px 0;">
                            R$ ${v.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                        </div>
                        <div style="font-size:10px; color:var(--danger); font-weight:600;">
                            Vence: ${new Date(item.data_vencimento).toLocaleDateString('pt-BR')}
                        </div>
                    </div>
                    <button class="btn-mini-boleto" onclick="prepararBoleto(${item.id}, '${item.descricao}', ${v})">
                        <i data-lucide="barcode"></i> BOLETO
                    </button>
                </div>`;
        }

        const btnPagar = !isP ? `<i data-lucide="check-circle" onclick="marcarComoPago(${item.id})" style="cursor:pointer; color:var(--success); margin-right:12px; width:18px;" title="Pagar"></i>` : '';
        const btnRecibo = isP ? `<i data-lucide="file-text" onclick="prepararRecibo(${item.id})" style="cursor:pointer; color:var(--accent-purple); margin-right:12px; width:18px;" title="Emitir Recibo"></i>` : '';
        const btnEditar = `<i data-lucide="pencil" onclick="editarLancamento(${item.id})" style="cursor:pointer; color:var(--primary); margin-right:12px; width:18px;" title="Editar"></i>`;
        const btnExcluir = `<i data-lucide="trash-2" onclick="deletar(${item.id})" style="cursor:pointer; color:var(--danger); width:18px;" title="Excluir"></i>`;

        corpo.innerHTML += `
            <tr>
                <td><strong>${item.descricao}</strong></td>
                <td><strong style="color: ${isR ? 'var(--success)' : 'var(--danger)'}">R$ ${v.toLocaleString('pt-BR', {minimumFractionDigits:2})}</strong></td>
                <td>${new Date(item.data_vencimento).toLocaleDateString('pt-BR')}</td>
                <td><span style="font-weight:700; font-size:11px; color: ${isP ? 'var(--success)' : 'var(--warning)'}}">${item.status.toUpperCase()}</span></td>
                <td style="text-align: center; white-space: nowrap;">
                    ${btnPagar} ${btnRecibo} ${btnEditar} ${btnExcluir}
                </td>
            </tr>`;
    });

    if (window.lucide) {
        lucide.createIcons();
    }

    document.getElementById('totalReceitas').innerText = `R$ ${liqR.toLocaleString('pt-BR')}`;
    document.getElementById('totalDespesas').innerText = `R$ ${liqD.toLocaleString('pt-BR')}`;
    document.getElementById('totalAReceber').innerText = `R$ ${pendR.toLocaleString('pt-BR')}`;
    document.getElementById('totalAPagar').innerText = `R$ ${pendD.toLocaleString('pt-BR')}`;
    document.getElementById('saldoTotal').innerText = `R$ ${(liqR - liqD).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
    
    atualizarGrafico(liqR, liqD, pendR, pendD);

const totalReceitasContagem = lista.filter(i => i.tipo === 'Receita' && i.status === 'Pago').length;
const ticketMedio = totalReceitasContagem > 0 ? (liqR / totalReceitasContagem) : 0;

const totalEsperado = liqR + pendR;
const inadimplencia = totalEsperado > 0 ? (pendR / totalEsperado) * 100 : 0;

const margem = liqR > 0 ? ((liqR - liqD) / liqR) * 100 : 0;

document.getElementById('kpi-ticket').innerText = `R$ ${ticketMedio.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
document.getElementById('kpi-inadimplencia').innerText = `${inadimplencia.toFixed(1)}%`;
document.getElementById('kpi-margem').innerText = `${margem.toFixed(1)}%`;

carregarSaldoReal();
}

        // --- FUN√á√ïES DE NEG√ìCIO ---
        function abrirModalLancamento() { document.getElementById('modalNovoLancamento').style.display = 'flex'; }
        function fecharModalLancamento() { document.getElementById('modalNovoLancamento').style.display = 'none'; }

async function salvarLancamento() {
    const descricao = document.getElementById('addDescricao').value;
    const valorComMascara = document.getElementById('addValor').value; 
    const tipo = document.getElementById('addTipo').value;
    const data_vencimento = document.getElementById('addData').value;

    if(!descricao || !valorComMascara || !data_vencimento) return alert("Preencha todos os campos!");

    const valorNumerico = parseFloat(valorComMascara.replace("R$", "").replace(/\./g, "").replace(",", ".").trim());

    const dados = { descricao, valor: valorNumerico, tipo, data_vencimento };

    try {
        const res = await fetch('/api/financeiro', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify(dados)
        });

        if (res.ok) {
            alert("Lan√ßamento salvo!");
            fecharModalLancamento();
            location.reload();
        } else {
            const erro = await res.json();
            alert("Erro: " + erro.erro);
        }
    } catch (err) {
        alert("Erro de conex√£o com o servidor.");
    }
}

        async function marcarComoPago(id) {
            if(!confirm("Deseja marcar como Pago?")) return;
            const res = await fetch(`/api/financeiro/${id}/pagar`, { method: 'PATCH', headers: { Authorization: `Bearer ${token}` } });
            if(res.ok) carregarDados();
        }

        async function deletar(id) {
            if(confirm('Deseja excluir?')) {
                const res = await fetch(`/api/financeiro/${id}`, { method: 'DELETE', headers: { Authorization: `Bearer ${token}` } });
                if(res.ok) carregarDados();
            }
        }

        function editarLancamento(id) {
    const item = originalData.find(i => i.id === id);
    if (!item) return;

    document.getElementById('editId').value = item.id;
    document.getElementById('editDescricao').value = item.descricao;
    document.getElementById('editValor').value = item.valor;
    document.getElementById('editTipo').value = item.tipo;
    
    const dataFormatada = new Date(item.data_vencimento).toISOString().split('T')[0];
    document.getElementById('editData').value = dataFormatada;

    document.getElementById('modalEditarLancamento').style.display = 'flex';
}

async function atualizarLancamento() {
    const id = document.getElementById('editId').value;
    const dados = {
        descricao: document.getElementById('editDescricao').value,
        valor: document.getElementById('editValor').value,
        tipo: document.getElementById('editTipo').value,
        data_vencimento: document.getElementById('editData').value
    };

    try {
        const res = await fetch(`/api/financeiro/${id}`, {
            method: 'PUT',
            headers: { 
                'Content-Type': 'application/json', 
                'Authorization': `Bearer ${token}` 
            },
            body: JSON.stringify(dados)
        });

        if (res.ok) {
            document.getElementById('modalEditarLancamento').style.display = 'none';
            carregarDados();
        } else {
            alert("Erro ao atualizar lan√ßamento.");
        }
    } catch (err) {
        console.error(err);
        alert("Erro de conex√£o.");
    }
}

        function prepararBoleto(id, desc, valor) {
            lancamentoParaCobrar = { id, desc, valor };
            document.getElementById('cobrancaResumo').innerHTML = `
                <div style="background:var(--bg); padding:15px; border-radius:8px; border-left:4px solid var(--primary);">
                    <p><strong>Honor√°rios:</strong> ${desc}</p>
                    <p><strong>Valor a Receber:</strong> R$ ${valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                </div>
                <p style="margin-top:10px; font-size:12px; color:var(--muted);">
                    * O valor ser√° creditado na conta banc√°ria configurada no seu perfil.
                </p>
            `;
            document.getElementById('modalCobranca').style.display = 'flex';
        }

        // --- FUN√á√ïES DE RECIBO ---
        
        // Carregar clientes cadastrados para o select do recibo
        async function carregarClientesParaRecibo() {
            try {
                const res = await fetch('/api/clientes', {
                    headers: { Authorization: `Bearer ${token}` }
                });

                if (!res.ok) {
                    throw new Error('Erro ao carregar clientes');
                }

                clientesCadastrados = await res.json();
                
                const select = document.getElementById('reciboClienteSelect');
                if (select) {
                    select.innerHTML = '<option value="">Selecione um cliente ou preencha manualmente abaixo</option>';
                    
                    clientesCadastrados.forEach(cliente => {
                        select.innerHTML += `<option value="${cliente.id}" data-nome="${cliente.nome}" data-documento="${cliente.documento || ''}">${cliente.nome} ${cliente.documento ? '- ' + cliente.documento : ''}</option>`;
                    });
                    
                    console.log('‚úÖ Clientes carregados para recibo:', clientesCadastrados.length);
                }
            } catch (err) {
                console.error('Erro ao carregar clientes para recibo:', err);
            }
        }

        // Preencher dados do cliente automaticamente ao selecionar no select
        function preencherDadosCliente() {
            const select = document.getElementById('reciboClienteSelect');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption.value) {
                const nome = selectedOption.getAttribute('data-nome');
                const documento = selectedOption.getAttribute('data-documento');
                
                document.getElementById('reciboClienteNome').value = nome || '';
                document.getElementById('reciboClienteDoc').value = documento || '';
                
                console.log('‚úÖ Dados do cliente preenchidos:', nome);
            } else {
                // Limpa os campos se selecionar a op√ß√£o vazia
                document.getElementById('reciboClienteNome').value = '';
                document.getElementById('reciboClienteDoc').value = '';
            }
        }
        
        function prepararRecibo(lancamentoId) {
            const item = originalData.find(i => i.id === lancamentoId);
            if (!item) return;

            document.getElementById('reciboLancamentoId').value = lancamentoId;
            document.getElementById('reciboNumero').value = `REC-${lancamentoId}-${new Date().getFullYear()}`;
            document.getElementById('reciboValor').value = item.valor;
            document.getElementById('reciboDescricao').value = item.descricao;
            
            // Limpa sele√ß√£o de cliente
            document.getElementById('reciboClienteSelect').value = '';
            document.getElementById('reciboClienteNome').value = '';
            document.getElementById('reciboClienteDoc').value = '';
            
            document.getElementById('modalRecibo').style.display = 'flex';
            
            // Recarrega √≠cones do Lucide
            if (window.lucide) {
                lucide.createIcons();
            }
        }

        function fecharModalRecibo() {
            document.getElementById('modalRecibo').style.display = 'none';
        }

        async function gerarRecibo() {
            const dados = {
                lancamentoId: document.getElementById('reciboLancamentoId').value,
                numeroRecibo: document.getElementById('reciboNumero').value,
                clienteNome: document.getElementById('reciboClienteNome').value,
                clienteDocumento: document.getElementById('reciboClienteDoc').value,
                valor: document.getElementById('reciboValor').value,
                descricao: document.getElementById('reciboDescricao').value,
                formaPagamento: document.getElementById('reciboFormaPagamento').value
            };

            if (!dados.clienteNome || !dados.valor || !dados.descricao) {
                return alert('‚ö†Ô∏è Preencha todos os campos obrigat√≥rios: Nome do Cliente, Valor e Descri√ß√£o');
            }

            const btn = event.target;
            const textoOriginal = btn.innerHTML;

            try {
                btn.innerHTML = '<i class="lucide lucide-loader-2" style="animation: spin 1s linear infinite;"></i> Gerando PDF...';
                btn.disabled = true;

                const res = await fetch('/api/recibos/gerar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(dados)
                });

                if (res.ok) {
                    // Recebe o PDF como blob
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `recibo-${dados.numeroRecibo}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    alert('‚úÖ Recibo gerado com sucesso!');
                    fecharModalRecibo();
                } else {
                    const erro = await res.json();
                    alert('‚ùå Erro: ' + (erro.erro || 'Falha ao gerar recibo'));
                }
            } catch (err) {
                console.error('Erro ao gerar recibo:', err);
                alert('‚ùå Erro ao gerar recibo. Verifique sua conex√£o.');
            } finally {
                btn.innerHTML = textoOriginal;
                btn.disabled = false;
                if (window.lucide) {
                    lucide.createIcons();
                }
            }
        }

        // --- FUN√á√ïES DE LOGO ---
        function abrirModalLogo() {
            document.getElementById('modalLogo').style.display = 'flex';
        }

        function fecharModalLogo() {
            document.getElementById('modalLogo').style.display = 'none';
        }

        async function carregarLogoAtual() {
            try {
                const res = await fetch('/api/recibos/logo', {
                    headers: { Authorization: `Bearer ${token}` }
                });
                
                if (!res.ok) {
                    console.warn('Erro ao carregar logo:', res.status);
                    return;
                }

                const data = await res.json();
                
                if (data.ok && data.logoPath) {
                    const preview = document.getElementById('logoPreview');
                    if (preview) {
                        preview.innerHTML = `<img src="${data.logoPath}" alt="Logo" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
                    }
                    console.log('‚úÖ Logo carregada:', data.logoPath);
                }
            } catch (err) {
                console.error('Erro ao carregar logo:', err);
            }
        }

        async function uploadLogo() {
            const fileInput = document.getElementById('logoInput');
            const file = fileInput.files[0];
            
            if (!file) {
                return alert('‚ö†Ô∏è Selecione uma imagem primeiro');
            }

            // Valida√ß√£o de tamanho (5MB)
            if (file.size > 5 * 1024 * 1024) {
                return alert('‚ö†Ô∏è A imagem deve ter no m√°ximo 5MB');
            }

            // Valida√ß√£o de tipo
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
            if (!allowedTypes.includes(file.type)) {
                return alert('‚ö†Ô∏è Apenas imagens JPG, PNG ou GIF s√£o permitidas');
            }

            const formData = new FormData();
            formData.append('logo', file);

            // Mostra preview tempor√°rio
            const preview = document.getElementById('logoPreview');
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.innerHTML = `<img src="${e.target.result}" alt="Preview" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
            };
            reader.readAsDataURL(file);

            try {
                const res = await fetch('/api/recibos/upload-logo', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                const data = await res.json();

                if (res.ok && data.ok) {
                    alert('‚úÖ Logo atualizada com sucesso!');
                    await carregarLogoAtual();
                } else {
                    alert('‚ùå Erro: ' + (data.erro || 'Falha ao fazer upload'));
                    // Restaura preview anterior
                    await carregarLogoAtual();
                }
            } catch (err) {
                console.error('Erro no upload:', err);
                alert('‚ùå Erro ao fazer upload da logo');
                await carregarLogoAtual();
            }
        }

        async function uploadAssinatura() {
    const fileInput = document.getElementById('assinaturaInput');
    const file = fileInput.files[0];

    if (!file) {
        return alert('‚ö†Ô∏è Selecione uma imagem primeiro');
    }

    if (file.size > 5 * 1024 * 1024) {
        return alert('‚ö†Ô∏è A imagem deve ter no m√°ximo 5MB');
    }

    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png'];
    if (!allowedTypes.includes(file.type)) {
        return alert('‚ö†Ô∏è Apenas imagens JPG ou PNG s√£o permitidas');
    }

    const formData = new FormData();
    formData.append('assinatura', file);

    // Preview imediato
    const preview = document.getElementById('assinaturaPreview');
    const reader = new FileReader();
    reader.onload = function(e) {
        preview.innerHTML = `<img src="${e.target.result}" style="max-width:100%; max-height:100%; object-fit:contain;">`;
    };
    reader.readAsDataURL(file);

    try {
        const res = await fetch('/api/recibos/upload-assinatura', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });

        const data = await res.json();

        if (res.ok && data.ok) {
            alert('‚úÖ Assinatura salva com sucesso!');
        } else {
            alert('‚ùå Erro: ' + (data.erro || 'Falha no upload'));
        }
    } catch (err) {
        console.error(err);
        alert('‚ùå Erro ao enviar assinatura');
    }
}

        async function carregarClientesParaBoleto() {
    const select = document.getElementById('selectClienteBoleto');
    try {
        const res = await fetch('/api/clientes', { 
            headers: { Authorization: `Bearer ${token}` } 
        });
        
        if (!res.ok) throw new Error("Erro na requisi√ß√£o");

        const clientes = await res.json();
        
        select.innerHTML = '<option value="">Selecione o cliente...</option>';
        clientes.forEach(c => {
            select.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
        });
    } catch (err) {
        console.error("Erro ao carregar clientes:", err);
        select.innerHTML = '<option value="">Erro ao carregar clientes</option>';
    }
}

        async function confirmarBoleto() {
            if (!lancamentoParaCobrar) return;
            const btn = document.querySelector('#modalCobranca .btn-mini-boleto');
            const originalText = btn.innerText;

            try {
                btn.innerText = "‚è≥ Gerando...";
                btn.disabled = true;

                const res = await fetch('/api/financeiro/gerar-boleto-honorarios', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({
                        lancamentoId: lancamentoParaCobrar.id,
                        valor: lancamentoParaCobrar.valor,
                        descricao: lancamentoParaCobrar.desc,
                        clienteId: document.getElementById('selectClienteBoleto').value
                    })
                });

                const data = await res.json();
                if (res.status === 402) {
                    const msg = data.message || "A emiss√£o de boletos est√° dispon√≠vel apenas nos planos Intermedi√°rio, Avan√ßado e Premium.";
                    exibirAvisoUpgrade(msg);
                    document.getElementById('modalCobranca').style.display = 'none';
                    return;
                }
                if (res.ok && data.url) {
                    window.open(data.url, '_blank');
                    alert("‚úÖ Boleto gerado com sucesso!");
                    document.getElementById('modalCobranca').style.display = 'none';
                } else { alert("‚ùå Erro: " + (data.erro || "Falha na gera√ß√£o.")); }
            } catch (err) { alert("Erro de conex√£o."); } 
            finally { btn.innerText = originalText; btn.disabled = false; }
        }

async function carregarSaldoReal() {
    try {
        const res = await fetch('/api/financeiro/saldo-real', { 
            headers: { Authorization: `Bearer ${token}` } 
        });
        
        if (!res.ok) throw new Error('Erro na API');
        const data = await res.json();

        const elRec = document.getElementById('totalReceitas');
        const elDes = document.getElementById('totalDespesas');
        const elSal = document.getElementById('saldoTotal');

        if (elRec) elRec.innerText = `R$ ${Number(data.receitasReais).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        if (elDes) elDes.innerText = `R$ ${Number(data.despesasPagas).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        if (elSal) elSal.innerText = `R$ ${Number(data.saldoLiquido).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        
    } catch (e) {
        console.error('Erro ao carregar saldo real:', e);
    }
}

        function atualizarGrafico(r1, d1, r2, d2) {
    const ctx = document.getElementById('financeChart').getContext('2d');
    if (financeChart) financeChart.destroy();

    financeChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Realizado', 'Previsto'],
            datasets: [
                { 
                    label: 'Receitas', 
                    data: [r1, r2], 
                    borderColor: '#10b981', 
                    backgroundColor: 'rgba(16, 185, 129, 0.1)', 
                    fill: true, 
                    tension: 0.4 
                },
                { 
                    label: 'Despesas', 
                    data: [d1, d2], 
                    borderColor: '#ef4444', 
                    backgroundColor: 'rgba(239, 68, 68, 0.1)', 
                    fill: true, 
                    tension: 0.4 
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { display: false },
                x: { grid: { display: false } }
            }
        }
    });
}

        function rolarParaTabela() { window.scrollTo({ top: 600, behavior: 'smooth' }); }
        function logout() { localStorage.removeItem('token'); window.location.href = '/login.html'; }

        const campoValor = document.getElementById('addValor');
        if (campoValor) {
        campoValor.addEventListener('input', function (e) {
        let value = e.target.value.replace(/\D/g, "");
        if (!value) { e.target.value = ""; return; }
        value = (value / 100).toFixed(2) + "";
        value = value.replace(".", ",");
        value = value.replace(/(\d)(\d{3})(\d{3}),/g, "$1.$2.$3,");
        value = value.replace(/(\d)(\d{3}),/g, "$1.$2,");
        e.target.value = "R$ " + value;
    });
}

function toggleUserMenu() {
    const m = document.getElementById('userDropdown');
    if(m) m.style.display = m.style.display === 'none' ? 'block' : 'none';
}

window.addEventListener('click', (e) => {
    if (!e.target.closest('#userCircle') && !e.target.closest('#userDropdown')) {
        const m = document.getElementById('userDropdown');
        if(m) m.style.display = 'none';
    }
});

        function exibirAvisoUpgrade(mensagem) {
            const overlay = document.createElement('div');
            overlay.id = "overlay-upgrade";
            overlay.style = "position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:20000; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(5px);";
            overlay.innerHTML = `
            <div style="background:#fff; padding:40px; border-radius:20px; text-align:center; max-width:400px;">
                <div style="font-size:50px;">üöÄ</div>
                <h3 style="margin-top:15px; color:#0f172a;">Recurso Intermedi√°rio</h3>
                <p style="color:#64748b; margin:15px 0 25px 0; line-height:1.6;">${mensagem}</p>
                <div style="background:#fffbeb; border:1px solid #fde68a; border-radius:12px; padding:15px; margin-bottom:25px; text-align:left;">
                    <p style="margin:0; font-size:13px; color:#92400e; line-height:1.6;">
                        <strong>üéØ Plano Intermedi√°rio inclui:</strong><br>
                        ‚Ä¢ Boletos e cobran√ßas ilimitadas<br>
                        ‚Ä¢ Integra√ß√£o Asaas completa<br>
                        ‚Ä¢ Relat√≥rios financeiros avan√ßados<br>
                        ‚Ä¢ Suporte priorit√°rio
                    </p>
                </div>
                <button onclick="window.location.href='/planos-page'" style="background:linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color:#000; border:none; padding:14px 28px; border-radius:10px; font-weight:800; cursor:pointer; width:100%; margin-bottom:10px;">
                    Ver Planos e Pre√ßos
                </button>
                <button onclick="document.getElementById('overlay-upgrade').remove()" style="background:none; border:none; color:#64748b; cursor:pointer; font-weight:600; padding:8px;">
                    Depois
                </button>
            </div>`;
            document.body.appendChild(overlay);
        }

        // ==========================================
// üìä RELAT√ìRIO DE FATURAMENTO
// ==========================================

function abrirRelatorioFaturamento() {
    document.getElementById('modalRelatorioFaturamento').style.display = 'flex';
    
    // Define m√™s atual como padr√£o
    const hoje = new Date();
    const mesAtual = hoje.toISOString().substring(0, 7); // YYYY-MM
    document.getElementById('relatorioMes').value = mesAtual;
}

function fecharRelatorioFaturamento() {
    document.getElementById('modalRelatorioFaturamento').style.display = 'none';
}

function fecharVisualizacaoRelatorio() {
    document.getElementById('modalVisualizacaoRelatorio').style.display = 'none';
}

function atualizarCamposPeriodo() {
    const tipo = document.getElementById('relatorioTipo').value;
    
    document.getElementById('camposMensal').style.display = tipo === 'mensal' ? 'block' : 'none';
    document.getElementById('camposAnual').style.display = tipo === 'anual' ? 'block' : 'none';
    document.getElementById('camposPersonalizado').style.display = tipo === 'personalizado' ? 'block' : 'none';
}

async function visualizarRelatorio() {
    const dados = await buscarDadosRelatorio();
    if (!dados) return;
    
    const html = gerarHTMLRelatorio(dados);
    document.getElementById('conteudoRelatorio').innerHTML = html;
    
    // Fechar modal de configura√ß√£o e abrir visualiza√ß√£o
    fecharRelatorioFaturamento();
    document.getElementById('modalVisualizacaoRelatorio').style.display = 'flex';
    
    // Reinicializar √≠cones Lucide
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
}

async function buscarDadosRelatorio() {
    const tipo = document.getElementById('relatorioTipo').value;
    let dataInicio, dataFim, periodoTexto;
    
    // Determinar per√≠odo
    if (tipo === 'mensal') {
        const mesAno = document.getElementById('relatorioMes').value;
        if (!mesAno) {
            alert('Por favor, selecione o m√™s.');
            return null;
        }
        
        const [ano, mes] = mesAno.split('-');
        dataInicio = `${ano}-${mes}-01`;
        
        // √öltimo dia do m√™s
        const ultimoDia = new Date(ano, mes, 0).getDate();
        dataFim = `${ano}-${mes}-${ultimoDia}`;
        
        const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                       'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
        periodoTexto = `${meses[parseInt(mes) - 1]} de ${ano}`;
        
    } else if (tipo === 'anual') {
        const ano = document.getElementById('relatorioAno').value;
        dataInicio = `${ano}-01-01`;
        dataFim = `${ano}-12-31`;
        periodoTexto = `Ano ${ano}`;
        
    } else { // personalizado
        dataInicio = document.getElementById('relatorioDataInicio').value;
        dataFim = document.getElementById('relatorioDataFim').value;
        
        if (!dataInicio || !dataFim) {
            alert('Por favor, preencha as datas de in√≠cio e fim.');
            return null;
        }
        
        periodoTexto = `${new Date(dataInicio).toLocaleDateString('pt-BR')} at√© ${new Date(dataFim).toLocaleDateString('pt-BR')}`;
    }
    
    // Buscar dados do backend
    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/financeiro/relatorio?dataInicio=${dataInicio}&dataFim=${dataFim}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) {
            throw new Error('Erro ao buscar dados do relat√≥rio');
        }
        
        const lancamentos = await response.json();
        
        // Filtrar conforme op√ß√µes
        const incluirReceitas = document.getElementById('incluirReceitas').checked;
        const incluirDespesas = document.getElementById('incluirDespesas').checked;
        const apenasRealizados = document.getElementById('apenasRealizados').checked;
        
        const lancamentosFiltrados = lancamentos.filter(lanc => {
            if (!incluirReceitas && lanc.tipo === 'Receita') return false;
            if (!incluirDespesas && lanc.tipo === 'Despesa') return false;
            if (apenasRealizados && lanc.status !== 'Pago') return false;
            return true;
        });
        
        return {
            periodo: periodoTexto,
            dataInicio,
            dataFim,
            lancamentos: lancamentosFiltrados
        };
        
    } catch (error) {
        console.error('Erro ao buscar dados:', error);
        alert('Erro ao buscar dados do relat√≥rio. Verifique o console.');
        return null;
    }
}

function gerarHTMLRelatorio(dados) {
    const { periodo, lancamentos } = dados;
    
    // Calcular totais
    let totalReceitas = 0;
    let totalDespesas = 0;
    
    lancamentos.forEach(lanc => {
        const valor = parseFloat(lanc.valor);
        if (lanc.tipo === 'Receita') {
            totalReceitas += valor;
        } else {
            totalDespesas += valor;
        }
    });
    
    const lucroLiquido = totalReceitas - totalDespesas;
    
    // Agrupar por m√™s (se for relat√≥rio anual)
    const porMes = {};
    lancamentos.forEach(lanc => {
        const mes = lanc.data_vencimento.substring(0, 7); // YYYY-MM
        if (!porMes[mes]) {
            porMes[mes] = { receitas: 0, despesas: 0 };
        }
        
        const valor = parseFloat(lanc.valor);
        if (lanc.tipo === 'Receita') {
            porMes[mes].receitas += valor;
        } else {
            porMes[mes].despesas += valor;
        }
    });
    
    let html = `
        <div style="text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid var(--border-medium);">
            <h2 style="font-size: 24px; font-weight: 900; margin-bottom: 8px;">Relat√≥rio de Faturamento</h2>
            <p style="font-size: 16px; color: var(--text-secondary); font-weight: 600;">${periodo}</p>
            <p style="font-size: 12px; color: var(--muted); margin-top: 8px;">Gerado em ${new Date().toLocaleString('pt-BR')}</p>
        </div>
        
        <!-- Resumo Geral -->
        <div class="relatorio-resumo">
            <h3 style="font-weight: 800; margin-bottom: 15px; text-align: center;">üí∞ Resumo Financeiro</h3>
            <div class="relatorio-resumo-grid">
                <div class="relatorio-resumo-item">
                    <div class="relatorio-resumo-label">Total Receitas</div>
                    <div class="relatorio-resumo-valor valor-positivo">R$ ${totalReceitas.toFixed(2).replace('.', ',')}</div>
                </div>
                <div class="relatorio-resumo-item">
                    <div class="relatorio-resumo-label">Total Despesas</div>
                    <div class="relatorio-resumo-valor valor-negativo">R$ ${totalDespesas.toFixed(2).replace('.', ',')}</div>
                </div>
                <div class="relatorio-resumo-item">
                    <div class="relatorio-resumo-label">Lucro L√≠quido</div>
                    <div class="relatorio-resumo-valor ${lucroLiquido >= 0 ? 'valor-positivo' : 'valor-negativo'}">
                        R$ ${lucroLiquido.toFixed(2).replace('.', ',')}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Se for anual, mostrar breakdown por m√™s
    if (Object.keys(porMes).length > 1) {
        html += `
            <h3 style="font-weight: 800; margin: 30px 0 15px 0;">üìÖ Breakdown Mensal</h3>
            <table class="relatorio-table">
                <thead>
                    <tr>
                        <th>M√™s</th>
                        <th style="text-align: right;">Receitas</th>
                        <th style="text-align: right;">Despesas</th>
                        <th style="text-align: right;">Saldo</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        Object.keys(porMes).sort().forEach(mesKey => {
            const mes = porMes[mesKey];
            const saldo = mes.receitas - mes.despesas;
            const [ano, mesNum] = mesKey.split('-');
            const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            const mesNome = `${meses[parseInt(mesNum) - 1]}/${ano}`;
            
            html += `
                <tr>
                    <td><strong>${mesNome}</strong></td>
                    <td style="text-align: right; color: var(--accent-green);">R$ ${mes.receitas.toFixed(2).replace('.', ',')}</td>
                    <td style="text-align: right; color: var(--accent-red);">R$ ${mes.despesas.toFixed(2).replace('.', ',')}</td>
                    <td style="text-align: right; font-weight: 700; color: ${saldo >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">
                        R$ ${saldo.toFixed(2).replace('.', ',')}
                    </td>
                </tr>
            `;
        });
        
        html += `
                </tbody>
            </table>
        `;
    }
    
    // Tabela detalhada de lan√ßamentos
    if (lancamentos.length > 0) {
        html += `
            <h3 style="font-weight: 800; margin: 30px 0 15px 0;">üìã Lan√ßamentos Detalhados</h3>
            <table class="relatorio-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Descri√ß√£o</th>
                        <th>Tipo</th>
                        <th style="text-align: right;">Valor</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        lancamentos.forEach(lanc => {
            const valor = parseFloat(lanc.valor);
            const corValor = lanc.tipo === 'Receita' ? 'var(--accent-green)' : 'var(--accent-red)';
            const corStatus = lanc.status === 'Pago' ? 'var(--accent-green)' : 'var(--accent-orange)';
            
            html += `
                <tr>
                    <td>${new Date(lanc.data_vencimento).toLocaleDateString('pt-BR')}</td>
                    <td>${lanc.descricao}</td>
                    <td>
                        <span style="padding: 4px 12px; background: ${lanc.tipo === 'Receita' ? '#d1fae5' : '#fee2e2'}; 
                                     color: ${corValor}; border-radius: 20px; font-size: 11px; font-weight: 700;">
                            ${lanc.tipo}
                        </span>
                    </td>
                    <td style="text-align: right; font-weight: 700; color: ${corValor};">
                        R$ ${valor.toFixed(2).replace('.', ',')}
                    </td>
                    <td>
                        <span style="padding: 4px 12px; background: ${lanc.status === 'Pago' ? '#d1fae5' : '#fef3c7'}; 
                                     color: ${corStatus}; border-radius: 20px; font-size: 11px; font-weight: 700;">
                            ${lanc.status}
                        </span>
                    </td>
                </tr>
            `;
        });
        
        html += `
                </tbody>
            </table>
        `;
    } else {
        html += `
            <div style="text-align: center; padding: 60px 20px; color: var(--muted);">
                <i data-lucide="inbox" style="width: 64px; height: 64px; margin-bottom: 20px; opacity: 0.3;"></i>
                <p style="font-size: 16px; font-weight: 600;">Nenhum lan√ßamento encontrado neste per√≠odo</p>
            </div>
        `;
    }
    
    return html;
}

async function gerarPDFRelatorio() {
    const dados = await buscarDadosRelatorio();
    if (!dados) return;
    
    try {
        const token = localStorage.getItem('token');
        
        // Enviar para o backend gerar PDF
        const response = await fetch('/api/financeiro/relatorio-pdf', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(dados)
        });
        
        if (!response.ok) {
            throw new Error('Erro ao gerar PDF');
        }
        
        // Baixar o PDF
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Relatorio_Faturamento_${dados.periodo.replace(/ /g, '_')}.pdf`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        alert('‚úÖ Relat√≥rio PDF gerado com sucesso!');
        
    } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        alert('‚ùå Erro ao gerar PDF. Tente novamente.');
    }
}
    </script>
</body>
</html>