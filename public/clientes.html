<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>LawTech Pro ‚Äî Gest√£o de Clientes</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/lucide-static@0.451.0/font/lucide.css" rel="stylesheet">

    <style>
    :root {
        /* Light Theme Colors - Professional & Clean */
        --bg-primary: #f8fafc;
        --bg-secondary: #111827;
        --bg-tertiary: #1a2332;
        --bg-elevated: #ffffff;
        
        --text-primary: #1e293b;
        --text-secondary: #475569;
        --text-tertiary: #64748b;
        
        --accent-blue: #2563eb;
        --accent-blue-light: #3b82f6;
        --accent-blue-glow: rgba(37, 99, 235, 0.3);
        
        --accent-green: #10b981;
        --accent-purple: #8b5cf6;
        --accent-orange: #f59e0b;
        --accent-red: #ef4444;
        --accent-gold: #fbbf24;
        
        --border-subtle: rgba(0, 0, 0, 0.08);
        --border-medium: rgba(0, 0, 0, 0.12);
        
        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 16px;
        
        --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
        
        /* Compatibility */
        --bg: var(--bg-primary);
        --sidebar: var(--bg-secondary);
        --white: var(--bg-elevated);
        --border: var(--border-medium);
        --primary: var(--accent-blue);
        --success: var(--accent-green);
        --danger: var(--accent-red);
        --warning: var(--accent-orange);
        --muted: var(--text-tertiary);
        --text-main: var(--text-primary);
        --text-menu: var(--text-tertiary);
        --sidebar-hover: var(--bg-tertiary);
        --radius: var(--radius-md);
    }

    /* Reset LawTech Pro */
    * { box-sizing: border-box; font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding: 0; }
    body { background: var(--bg); color: var(--text-main); line-height: 1.5; }

    /* Sidebar Premium */
    .sidebar {
        width: 280px;
        background: var(--bg-secondary);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        border-right: 1px solid var(--border-subtle);
        padding: 32px 24px;
        display: flex;
        flex-direction: column;
        height: 100vh;
        position: fixed;
        left: 0;
        top: 0;
        z-index: 1000;
    }

    .sidebar-header {
        text-align: center;
        margin-bottom: 40px;
        padding-bottom: 24px;
        border-bottom: 1px solid var(--border-subtle);
    }

    .sidebar-header img {
        width: 100%;
        max-width: 180px;
        height: auto;
        filter: drop-shadow(0 0 20px var(--accent-blue-glow));
        transition: all var(--transition-base);
    }

    .sidebar-header img:hover {
        filter: drop-shadow(0 0 30px var(--accent-blue-glow));
        transform: scale(1.05);
    }

    .menu {
        display: flex;
        flex-direction: column;
        gap: 6px;
        flex-grow: 1;
    }

    .menu a {
        display: flex;
        align-items: center;
        padding: 14px 16px;
        color: #94a3b8;
        text-decoration: none;
        border-radius: var(--radius-lg);
        font-size: 14px;
        font-weight: 600;
        transition: all var(--transition-base);
        position: relative;
        overflow: hidden;
    }

    .menu a::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: var(--accent-blue);
        transform: scaleY(0);
        transition: transform var(--transition-base);
    }

    .menu a:hover::before,
    .menu a.active::before {
        transform: scaleY(1);
    }

    .menu a i {
        margin-right: 12px;
        font-size: 18px;
        transition: all var(--transition-base);
    }

    .menu a:hover {
        background: rgba(255, 255, 255, 0.05);
        color: #e2e8f0;
        transform: translateX(4px);
    }

    .menu a.active {
        background: rgba(37, 99, 235, 0.15);
        color: #60a5fa;
        border: 1px solid rgba(37, 99, 235, 0.4);
    }

    .menu a.active i {
        color: #60a5fa;
    }
    
    /* Sidebar Footer (User/Plan Info) */
    .sidebar-footer {
        padding-top: 24px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        font-size: 12px;
        margin-top: auto;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .sidebar-footer span {
        color: #cbd5e1 !important;
    }

    /* Main Area */
    .main { margin-left: 280px; min-height: 100vh; display: flex; flex-direction: column; }
    .header { background: var(--white); height: 72px; padding: 0 32px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 900; }
    .content { padding: 32px; }

    /* Cards e Tabelas */
    .card { background: var(--white); border-radius: var(--radius); padding: 24px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 12px; border-bottom: 2px solid var(--border); color: var(--muted); font-size: 12px; text-transform: uppercase; font-weight: 700; }
    td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 14px; vertical-align: middle; }

    .btn-primary { background: var(--primary); color: #fff; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; display: inline-flex; align-items: center; gap: 8px; }
    
    /* Bot√µes de A√ß√£o na Tabela */
    .btn-action { border: none; background: none; cursor: pointer; font-weight: 600; font-size: 12px; padding: 4px 8px; border-radius: 4px; transition: 0.2s; }
    .btn-view { color: var(--success); }
    .btn-view:hover { background: #f0fdf4; }
    .btn-edit { color: var(--primary); }
    .btn-edit:hover { background: #eff6ff; }
    .btn-delete { color: var(--danger); }
    .btn-delete:hover { background: #fef2f2; }

    /* Modal */
    .modal { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.75); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .modal-content { background: #ffffff; width: 95%; max-width: 550px; max-height: 95vh; padding: 32px; border-radius: 16px; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }

    .form-row { display: flex; gap: 16px; margin-bottom: 16px; flex-wrap: wrap; }
    .form-group { flex: 1; display: flex; flex-direction: column; min-width: 200px; }
    .form-group.small { flex: 0 0 120px; min-width: 100px; }
    .form-group label { font-size: 11px; font-weight: 700; color: #64748b; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
    .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; color: #1e293b; transition: border-color 0.2s; }
    .form-group input:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

    .btn-crm-gold-nav { background: #fbbf24 !important; color: #000 !important; font-weight: 800 !important; margin-top: 15px !important; display: flex !important; align-items: center; justify-content: center; padding: 12px !important; border-radius: 8px; text-decoration: none; font-size: 14px; transition: 0.3s; }
    .btn-crm-gold-nav:hover { background: #facc15 !important; transform: scale(1.02); }
    .btn-crm-gold-nav i { margin-right: 10px; }

    /* üîî ESTILO DO BADGE DE NOTIFICA√á√ÉO (NOVO) */
    .badge-novo {
        background: #ef4444;
        color: white;
        font-size: 9px;
        padding: 2px 6px;
        border-radius: 10px;
        margin-left: auto; /* Alinha √† direita no menu */
        font-weight: 800;
        display: none; /* Inicia oculto */
        animation: pulse-red 2s infinite;
    }
    @keyframes pulse-red {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
        70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }
    
    /* Padroniza√ß√£o LawTech Pro - Caixa Alta Global */
body {
    text-transform: uppercase;
}

/* Garante que os campos de digita√ß√£o tamb√©m mostrem caixa alta enquanto o usu√°rio digita */
input, textarea, select {
    text-transform: uppercase;
}

/* Opcional: Se quiser que os n√∫meros dos processos mantenham o estilo t√©cnico, 
   mas ainda em caixa alta */
.numero-processo, .processo-hash {
    font-family: 'JetBrains Mono', monospace;
    letter-spacing: 1px;
}

/* Container principal do rodap√© */
.sidebar-footer {
    padding-top: 20px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    margin-top: auto;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

/* Alinhamento √† esquerda com pequeno espa√ßo ap√≥s o label */
.footer-info-row {
    display: flex;
    justify-content: flex-start; /* Alinha tudo no in√≠cio (esquerda) */
    align-items: center;
    gap: 8px; /* Espa√ßo fixo de 8px ap√≥s os ":" */
    font-size: 12px;
}

/* Estilo dos R√≥tulos (USU√ÅRIO: e PLANO:) */
.footer-info-row span:first-child {
    text-transform: uppercase;
    color: var(--text-tertiary);
    font-weight: 700;
    white-space: nowrap; /* Impede que o r√≥tulo quebre linha */
}

/* ‚úÖ EXCE√á√ÉO: For√ßa e-mail e plano em CAIXA BAIXA e alinhados √† esquerda */
.keep-lowercase {
    text-transform: lowercase !important;
    color: #cbd5e1;
    text-align: left;
}
</style>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/imask"></script>
<body>

    <aside class="sidebar">
        <div class="sidebar-header">
            <img src="Logo LawTech Pro_transparente.png" alt="LawTech Pro">
        </div>
        <nav class="menu">
            <a href="/dashboard"><i class="lucide lucide-layout-dashboard"></i> Dashboard</a>
            
            <a href="/clientes-page" class="active">
                <i class="lucide lucide-users"></i> Clientes 
                <span id="badgeClientes" class="badge-novo">NOVO</span>
            </a>

            <a href="/prazos-page"><i class="lucide lucide-clock"></i> Prazos</a>
            <a href="/processos-page"><i class="lucide lucide-folder"></i> Processos</a>
            <a href="/audiencias-page"><i class="lucide lucide-calendar-days"></i> Audi√™ncias</a>
            <a href="/calculos-page"><i class="lucide lucide-calculator"></i> C√°lculos Jur√≠dicos</a>
            <a href="/financeiro-page"><i class="lucide lucide-credit-card"></i> Financeiro</a>
            <a href="/publicacoes-page"><i class="lucide lucide-clock"></i> Publica√ß√µes DJEN</a>
            <a href="/ia-page" style="display: flex; align-items: center; gap: 10px;">
                <i class="lucide lucide-sparkles" style="color: #fbbf24;"></i> IA Jur√≠dica 
                <span style="font-size: 9px; background: #fbbf24; color: #000; padding: 2px 5px; border-radius: 4px; font-weight: bold; margin-left: auto;">PREMIUM</span>
            </a>
            <a href="/planos-page"><i class="lucide lucide-award"></i> Gest√£o de Planos</a>
            <a href="/config-page"><i class="lucide lucide-settings"></i> Configura√ß√µes</a>
            <a href="/crm-page" class="btn-crm-gold-nav">
                <i class="lucide lucide-trending-up"></i> CRM PROSPEC√á√ÉO
            </a>
        </nav>

        <div class="sidebar-footer">
    <div class="footer-info-row">
        <span>Usu√°rio:</span> 
        <span id="userEmail" class="keep-lowercase">...</span>
    </div>
    <div class="footer-info-row">
        <span>Plano:</span> 
        <span id="planNameFooter" class="keep-lowercase">...</span>
    </div>
</div>
    </aside>

    <div class="main">
<header class="header">
    <h2 style="font-size: 18px; font-weight: 700;">üë• Gest√£o de Clientes</h2>
    
    <div style="display:flex; gap:20px; align-items:center;">
        <div style="position: relative; display: flex; align-items: center; gap: 12px;">
            <span id="userNameHeader" style="font-size: 13px; font-weight: 600; color: var(--muted);">Advogado</span>
            <div onclick="toggleUserMenu()" id="userCircle" style="width: 38px; height: 38px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: 700; border: 2px solid #e2e8f0; font-size: 13px; text-transform: uppercase;">
                --
            </div>
            <div id="userDropdown" style="display: none; position: absolute; top: 50px; right: 0; background: white; border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); width: 180px; z-index: 1001;">
                <a href="/config-page" style="display: block; padding: 10px 16px; color: var(--text-main); text-decoration: none; font-size: 13px; border-bottom: 1px solid var(--border);">üë§ Meus Dados</a>
                <a href="#" onclick="logout()" style="display: block; padding: 10px 16px; color: var(--danger); text-decoration: none; font-size: 13px; font-weight: 600;">üö™ Sair</a>
            </div>
        </div>
    </div>
</header>

        <main class="content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <p style="color: var(--muted); font-size: 14px;">Administre sua base de clientes e visualize processos vinculados.</p>
                <button class="btn-primary" onclick="abrirModal()">
                    <i class="lucide lucide-plus"></i> Novo Cliente
                </button>
            </div>

            <div class="card">
                <div style="margin-bottom: 16px; display: flex; justify-content: flex-end;">
    <input
        type="text"
        id="buscaCliente"
        placeholder="üîç Buscar cliente por nome..."
        style="
            width: 280px;
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-size: 14px;
            outline: none;
        "
        oninput="filtrarClientes()"
    />
</div>
                <table>
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>CPF/CNPJ</th>
                            <th>Email</th>
                            <th>Telefone</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="listaClientes">
                        <tr><td colspan="6" style="text-align:center; color:var(--muted); padding:40px;">Carregando clientes...</td></tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <div id="modalCliente" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle" style="margin-bottom: 24px; font-size: 20px; font-weight: 700; color: #0f172a; display: flex; align-items: center; gap: 10px;">
                <i class="lucide lucide-user-plus" style="color: #2563eb;"></i> Novo Cliente
            </h3>
            
            <form id="formCliente">
                <div class="form-row">
                    <div class="form-group">
                        <label>Nome Completo / Raz√£o Social</label>
                        <input type="text" id="cliNome" placeholder="Ex: Jo√£o Silva" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Tipo de Pessoa</label>
                        <select id="cliTipo" onchange="alternarCamposPessoa(this.value)">
                            <option value="fisica">Pessoa F√≠sica (CPF)</option>
                            <option value="juridica">Pessoa Jur√≠dica (CNPJ)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label id="labelDoc">CPF</label>
                        <input type="text" id="cliDocumento" placeholder="000.000.000-00" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>E-mail</label>
                        <input type="email" id="cliEmail" placeholder="cliente@email.com">
                    </div>
                    <div class="form-group" id="groupNascimento">
                        <label>Data de Nascimento</label>
                        <input type="date" id="cliDataNascimento">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Telefone (WhatsApp)</label>
                        <input type="text" id="cliTelefone" placeholder="(00) 00000-0000">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group small">
                        <label>CEP</label>
                        <input type="text" id="cliCep" placeholder="00000-000" onblur="buscarEnderecoPorCep(this.value)">
                    </div>
                    <div class="form-group">
                        <label>Cidade</label>
                        <input type="text" id="cliCidade" placeholder="Cidade">
                    </div>
                    <div class="form-group small">
                        <label>Estado (UF)</label>
                        <select id="cliUf">
                            <option value="">--</option>
                            <option value="AC">AC</option><option value="AL">AL</option><option value="AP">AP</option>
                            <option value="AM">AM</option><option value="BA">BA</option><option value="CE">CE</option>
                            <option value="DF">DF</option><option value="ES">ES</option><option value="GO">GO</option>
                            <option value="MA">MA</option><option value="MT">MT</option><option value="MS">MS</option>
                            <option value="MG">MG</option><option value="PA">PA</option><option value="PB">PB</option>
                            <option value="PR">PR</option><option value="PE">PE</option><option value="PI">PI</option>
                            <option value="RJ">RJ</option><option value="RN">RN</option><option value="RS">RS</option>
                            <option value="RO">RO</option><option value="RR">RR</option><option value="SC">SC</option>
                            <option value="SP">SP</option><option value="SE">SE</option><option value="TO">TO</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Endere√ßo Completo</label>
                        <input type="text" id="cliEndereco" placeholder="Rua, N√∫mero, Bairro">
                    </div>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 32px;">
                    <button type="submit" class="btn-primary" style="flex: 1.5; height: 48px; font-weight: 600;">Salvar Dados</button>
                    <button type="button" onclick="fecharModal()" class="btn-secondary" style="flex: 1; height: 48px; font-weight: 600; background: #f1f5f9; color: #475569; border: none; border-radius: 8px; cursor: pointer;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
    const token = localStorage.getItem('token');
    if (!token) window.location.href = '/login.html';

    // üîî CONFIGURA√á√ÉO DE ALERTA SONORO E MONITORAMENTO
    const somNotificacao = new Audio('https://notificationsounds.com/storage/sounds/file-sounds-1150-pristine.mp3');
    let totalClientesAnterior = null;
    let maskDoc; 

    // 1. CARREGA USU√ÅRIO E PLANO NO RODAP√â
async function carregarInfoRodape() {
    try {
        const resUser = await fetch('/api/auth/me', { headers: { Authorization: `Bearer ${token}` } });
        const dataUser = await resUser.json();
        
        if (dataUser.ok) {
            // Atualiza sidebar
            document.getElementById('userEmail').innerText = dataUser.usuario.email;

            // --- L√ìGICA DO CABE√áALHO PADRONIZADA ---
            const nomeCompleto = dataUser.usuario.nome || 'Advogado';
            
            // 1. Apenas o primeiro nome
            const primeiroNome = nomeCompleto.trim().split(' ')[0];
            document.getElementById('userNameHeader').innerText = primeiroNome;

            // 2. Iniciais (Primeiro e √öltimo nome)
            const partes = nomeCompleto.trim().split(' ').filter(n => n);
            let iniciais = partes[0][0];
            if (partes.length > 1) {
                iniciais += partes[partes.length - 1][0];
            }
            
            const circulo = document.getElementById('userCircle');
            if (circulo) circulo.innerText = iniciais.toUpperCase();
        }

        const resPlan = await fetch('/api/plano-consumo', { headers: { Authorization: `Bearer ${token}` } });
        const dataPlan = await resPlan.json();
        document.getElementById('planNameFooter').innerText = dataPlan.plano || '---';
        
    } catch (err) { 
        console.error("Erro ao carregar cabe√ßalho:", err); 
    }
}

// Garanta que essas fun√ß√µes existam para o dropdown funcionar
function toggleUserMenu() {
    const m = document.getElementById('userDropdown');
    if(m) m.style.display = m.style.display === 'none' ? 'block' : 'none';
}

window.onclick = (e) => {
    if (!e.target.closest('#userCircle') && !e.target.closest('#userDropdown')) {
        const m = document.getElementById('userDropdown');
        if(m) m.style.display = 'none';
    }
};

// üöÄ Adicione estas fun√ß√µes extras ao final do script para o menu funcionar:
function toggleUserMenu() {
    const m = document.getElementById('userDropdown');
    if(m) m.style.display = m.style.display === 'none' ? 'block' : 'none';
}

window.onclick = (e) => {
    if (!e.target.closest('#userCircle') && !e.target.closest('#userDropdown')) {
        const m = document.getElementById('userDropdown');
        if(m) m.style.display = 'none';
    }
};

    // 2. CARREGA E MONITORA LISTA DE CLIENTES
    async function carregarClientes() {
        try {
            const res = await fetch('/api/clientes', { headers: { 'Authorization': `Bearer ${token}` } });
            if (res.ok) {
                const clientes = await res.json();
                
                // üîî L√≥gica de Alerta (Bip e Badge)
                if (totalClientesAnterior !== null && clientes.length > totalClientesAnterior) {
                    document.getElementById('badgeClientes').style.display = 'inline-block';
                    somNotificacao.play().catch(e => console.log("Som aguardando intera√ß√£o..."));
                }
                totalClientesAnterior = clientes.length;

                const tabela = document.getElementById('listaClientes');
                tabela.innerHTML = '';

                if (clientes.length === 0) {
                    tabela.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px; color:var(--muted);">Nenhum cliente cadastrado.</td></tr>';
                    return;
                }

                clientes.forEach(cli => {
                    const documentoLimpo = cli.documento ? cli.documento.replace(/"/g, '') : '---';
                    const acoes = `
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <i data-lucide="eye" 
                            onclick="visualizarProcessosCliente(${cli.id}, '${cli.nome}')" 
                            style="cursor:pointer; color:#10b981; width:18px;" 
                        title="Ver Processos"></i>
        
                        <i data-lucide="pencil" 
                            onclick="prepararEdicao(${cli.id}, '${cli.nome}', '${documentoLimpo}', '${cli.email}', '${cli.telefone || ''}', '${cli.cep || ''}', '${cli.endereco || ''}', '${cli.cidade || ''}', '${cli.estado || ''}')" 
                            style="cursor:pointer; color:#2563eb; width:18px;" 
                            title="Editar"></i>
        
                        <i data-lucide="trash-2" 
                            onclick="excluirCliente(${cli.id})" 
                            style="cursor:pointer; color:#ef4444; width:18px;" 
                            title="Excluir"></i>
                    </div>
                `;

                    tabela.innerHTML += `
                        <tr>
                            <td><strong style="color:var(--text-main);">${cli.nome}</strong></td>
                            <td>${documentoLimpo}</td>
                            <td>${cli.email}</td>
                            <td>${cli.telefone || '-'}</td>
                            <td>
                                <span style="background:#eff6ff; color:#2563eb; padding:4px 10px; border-radius:12px; font-weight:600; font-size:11px;">
                                    ${cli.total_processos || 0} processos
                                </span>
                            </td>
                            <td>${acoes}</td>
                        </tr>`;
                });

                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
        } catch (err) { console.error('Erro ao carregar:', err); }
    }

    function filtrarClientes() {
    const termo = document.getElementById('buscaCliente').value.toLowerCase();
    const linhas = document.querySelectorAll('#listaClientes tr');

    linhas.forEach(linha => {
        const nome = linha.querySelector('td')?.innerText.toLowerCase() || '';
        linha.style.display = nome.includes(termo) ? '' : 'none';
    });
}

    // 3. FUN√á√ïES DE MODAL E FORMUL√ÅRIO
    function abrirModal() {
        document.getElementById('modalCliente').style.display = 'flex';
        // Reset do badge ao abrir a p√°gina/modal para indicar que o Dr. j√° viu as novidades
        document.getElementById('badgeClientes').style.display = 'none';
        aplicarMascaras();
    }

    function fecharModal() { 
        document.getElementById('modalCliente').style.display = 'none'; 
        document.getElementById('formCliente').reset();
        delete document.getElementById('formCliente').dataset.editId;
        document.getElementById('modalTitle').innerHTML = '<i class="lucide lucide-user-plus" style="color: #2563eb;"></i> Novo Cliente';
    }

    function alternarCamposPessoa(tipo) {
        const labelDoc = document.getElementById('labelDoc');
        const groupNasc = document.getElementById('groupNascimento');
        if (tipo === 'fisica') {
            labelDoc.innerText = "CPF";
            groupNasc.style.display = "flex";
        } else {
            labelDoc.innerText = "CNPJ";
            groupNasc.style.display = "none";
        }
    }

    // 4. PERSIST√äNCIA DE DADOS (SALVAR/EDITAR/EXCLUIR)
    document.getElementById('formCliente').addEventListener('submit', async (e) => {
        e.preventDefault();
        const editId = e.target.dataset.editId;
        const metodo = editId ? 'PUT' : 'POST';
        const url = editId ? `/api/clientes/${editId}` : '/api/clientes';

        const dados = {
            nome: document.getElementById('cliNome').value,
            documento: document.getElementById('cliDocumento').value,
            email: document.getElementById('cliEmail').value,
            telefone: document.getElementById('cliTelefone').value,
            cep: document.getElementById('cliCep').value,
            endereco: document.getElementById('cliEndereco').value,
            cidade: document.getElementById('cliCidade').value,
            estado: document.getElementById('cliUf').value,
            tipo_pessoa: document.getElementById('cliTipo').value,
            data_nascimento: document.getElementById('cliDataNascimento').value || null
        };

        try {
            const res = await fetch(url, {
                method: metodo,
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(dados)
            });

            if (res.ok) {
                alert("‚úÖ Cliente salvo com sucesso!");
                fecharModal();
                carregarClientes();
            } else {
                const erro = await res.json();
                alert("‚ùå Erro: " + (erro.erro || "Falha ao salvar"));
            }
        } catch (err) { console.error("Erro na requisi√ß√£o:", err); }
    });

    async function excluirCliente(id) {
        if (!confirm("Deseja realmente excluir?")) return;
        const res = await fetch(`/api/clientes/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
        if (res.ok) carregarClientes();
    }

    function prepararEdicao(id, nome, documento, email, telefone, cep, endereco, cidade, estado) {
        abrirModal();
        document.getElementById('modalTitle').innerText = "üìù Editar Cliente";
        document.getElementById('cliNome').value = nome;
        document.getElementById('cliDocumento').value = documento;
        document.getElementById('cliEmail').value = email;
        document.getElementById('cliTelefone').value = telefone || '';
        document.getElementById('cliCep').value = cep || '';
        document.getElementById('cliEndereco').value = endereco || '';
        document.getElementById('cliCidade').value = cidade || '';
        document.getElementById('cliUf').value = estado || '';
        document.getElementById('formCliente').dataset.editId = id;
    }

    async function visualizarProcessosCliente(clienteId, clienteNome) {
    const container = document.getElementById('listaProcessosCliente');
    const modal = document.getElementById('modalVisualizarProcessos');
    const titulo = document.getElementById('tituloModalProcessos');

    titulo.innerText = `üìÇ Processos: ${clienteNome}`;
    container.innerHTML = '<p style="text-align:center; padding:20px;">Carregando processos...</p>';
    modal.style.display = 'flex';

    try {
        // üöÄ URL CORRIGIDA: Removido o "/processos" para bater com seu server.js
        const res = await fetch(`/api/por-cliente/${clienteId}`, { 
            method: 'GET',
            headers: { 
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            } 
        });

        if (!res.ok) throw new Error("Erro na resposta do servidor");
        const processos = await res.json();

        if (processos.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:var(--muted); padding:20px;">Este cliente n√£o possui processos cadastrados.</p>';
            return;
        }

        // Renderiza os cards dos processos com Esfera e Tribunal
        container.innerHTML = processos.map(p => `
            <div style="padding:16px; border:1px solid var(--border); border-radius:12px; background: white; display:flex; justify-content:space-between; align-items:center; box-shadow: 0 2px 4px rgba(0,0,0,0.02); margin-bottom:10px;">
                <div style="flex: 1;">
                    <strong style="display:block; color:var(--primary); font-family:monospace; font-size:14px; margin-bottom:4px;">${p.numero}</strong>
                    
                    <div style="display:flex; align-items:center; gap:6px; margin-bottom:8px;">
                        <span style="color:var(--danger); font-size:10px; font-weight:800;">VS</span>
                        <span style="font-size:13px; font-weight:600; color:var(--text-main);">${p.parte_contraria || 'Parte n√£o informada'}</span>
                    </div>

                    <div style="display:flex; gap:8px; align-items:center; flex-wrap: wrap;">
                        <span style="background: #e0f2fe; color: #0369a1; font-size:9px; font-weight:800; padding:2px 6px; border-radius:4px; text-transform:uppercase;">
                            ${p.esfera || 'N/A'}
                        </span>
                        <span style="color:var(--muted); font-size:11px; font-weight:600;">${p.tribunal || '---'}</span>
                        <small style="color:var(--muted); font-size:11px;">${p.instancia || '1'}¬∫ Grau - ${p.uf || '--'}</small>
                    </div>
                </div>
            </div>
        `).join('');

    } catch (err) {
        console.error("Erro detalhado:", err);
        container.innerHTML = '<p style="color:var(--danger); text-align:center; padding:20px; font-weight:600;">‚ùå Falha ao carregar processos. Verifique sua conex√£o.</p>';
    }
}

function fecharModalProcessos() {
    document.getElementById('modalVisualizarProcessos').style.display = 'none';
}

    async function buscarEnderecoPorCep(cep) {
        const valorCep = cep.replace(/\D/g, '');
        if (valorCep.length !== 8) return;
        try {
            const response = await fetch(`https://viacep.com.br/ws/${valorCep}/json/`);
            const data = await response.json();
            if (!data.erro) {
                document.getElementById('cliEndereco').value = `${data.logradouro}, ${data.bairro}`;
                document.getElementById('cliCidade').value = data.localidade;
                document.getElementById('cliUf').value = data.uf;
            }
        } catch (err) { console.error("Erro CEP:", err); }
    }

    function aplicarMascaras() {
        IMask(document.getElementById('cliDocumento'), {
            mask: [ { mask: '000.000.000-00', type: 'CPF' }, { mask: '00.000.000/0000-00', type: 'CNPJ' } ]
        });
        IMask(document.getElementById('cliTelefone'), { mask: '(00) 00000-0000' });
        IMask(document.getElementById('cliCep'), { mask: '00000-000' });
    }

    function logout() { localStorage.removeItem('token'); window.location.href = '/login.html'; }

    // üöÄ INICIALIZA√á√ÉO SEGURA
    window.onload = () => {
    carregarInfoRodape();
    carregarClientes();
    
    // Tenta "pr√©-carregar" o som para evitar atrasos
    somNotificacao.load(); 
    
    setInterval(carregarClientes, 40000);
};
</script>
<div id="modalVisualizarProcessos" class="modal">
    <div class="modal-content" style="max-width: 600px; border-radius: 20px; padding: 0; overflow: hidden;">
        <div style="background: var(--sidebar); padding: 24px; color: white; display: flex; justify-content: space-between; align-items: center;">
            <h3 id="tituloModalProcessos" style="margin: 0; font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 10px;">
                <i class="lucide-folder-open"></i> Processos do Cliente
            </h3>
            <span onclick="fecharModalProcessos()" style="cursor: pointer; opacity: 0.7; font-size: 24px;">&times;</span>
        </div>
        
        <div id="listaProcessosCliente" style="padding: 24px; display: flex; flex-direction: column; gap: 12px; max-height: 450px; overflow-y: auto; background: #f8fafc;">
            </div>

        <div style="padding: 16px 24px; background: white; border-top: 1px solid var(--border); display: flex; justify-content: flex-end;">
            <button class="btn-primary" onclick="fecharModalProcessos()" style="background: var(--sidebar);">Fechar Janela</button>
        </div>
    </div>
</div>
</body>
</html>